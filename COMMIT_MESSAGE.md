# Текст коммита

```
Исправлена реакция кнопок на активацию инпутов через vMix

Основные изменения:

1. Исправление проблемы с реакцией кнопок на внешнюю активацию:
   - Исправлена проблема, когда кнопки в блоке "Управление плашками vMix" не обновляли свое состояние при активации инпутов через сам vMix (вручную), хотя периодический опрос состояния через vMix API проводился каждые 2 секунды
   - Улучшена функция updateOverlayStates() для точной проверки активности конкретных инпутов (сравнение по номерам инпутов)
   - Добавлен механизм определения внешней активации через специальный маркер '__EXTERNAL__' в activeButtonRef
   - Улучшена функция isOverlayActive() для автоматического определения активной кнопки при обнаружении внешней активации инпута
   - Реализована защита от гонки условий при одновременной проверке нескольких кнопок одного инпута через двойную проверку (double-check)
   - Кнопки теперь корректно отражают состояние инпутов в vMix независимо от способа их активации

2. Улучшения в логике отслеживания состояния оверлеев:
   - В updateOverlayStates() добавлена точная проверка соответствия активного инпута в оверлее с инпутом из конфигурации
   - Используется сравнение номеров инпутов через inputsMap для точной идентификации
   - При обнаружении активного инпута без установленной активной кнопки устанавливается маркер '__EXTERNAL__'
   - При первом вызове isOverlayActive() с конкретным buttonKey маркер заменяется на реальный buttonKey
   - Первая доступная кнопка (с данными и не заблокированная) автоматически становится активной

Технические детали:

- Используется useRef (activeButtonRef) для отслеживания активной кнопки каждого инпута
- Структура activeButtonRef: { inputKey: buttonKey | '__EXTERNAL__' | undefined }
- Маркер '__EXTERNAL__' используется для обозначения того, что инпут был активирован через vMix напрямую, но активная кнопка еще не определена
- При проверке isOverlayActive(inputKey, buttonKey) если обнаружен маркер '__EXTERNAL__', то buttonKey автоматически устанавливается как активная кнопка
- Добавлена двойная проверка (double-check) для предотвращения гонки условий при одновременной проверке нескольких кнопок
- Активная кнопка очищается при деактивации инпута или при обнаружении другого активного инпута в том же оверлее

Затронутые файлы:
- src/renderer/hooks/useVMix.js - улучшены функции updateOverlayStates() и isOverlayActive(), добавлена логика обработки внешней активации

Предыдущие изменения:

1. Оптимизация отправки команд в vMix:
   - Реализована система отслеживания изменений полей для минимизации обращений к vMix API
   - Кэширование последних отправленных значений для каждого инпута (currentScore, lineup, rosterTeamA, rosterTeamB)
   - Отправка только измененных полей вместо всех полей при каждом обновлении
   - Функции фильтрации измененных полей: filterChangedFields, filterChangedColorFields, filterChangedVisibilityFields, filterChangedImageFields
   - Параметр forceUpdate для принудительного обновления всех полей (используется при создании/открытии матча, сохранении настроек)
   - Автоматический сброс кэша при смене матча (по matchId), переподключении к vMix, изменении конфигурации инпутов
   - Значительное снижение нагрузки на vMix API и улучшение производительности

2. Исправление обновления логотипов при смене команд:
   - Исправлена проблема, когда логотипы не обновлялись в vMix после смены команд местами
   - Добавлен timestamp к URL логотипов при принудительном обновлении (forceUpdate=true) для гарантированного перезагрузки изображений
   - Формат URL: logo_a.png?t=1234567890
   - Добавлена функция resetImageFieldsCache() в хук useVMix для сброса кэша логотипов
   - Логотипы теперь корректно обновляются при смене команд, сохранении настроек матча и списков команд

3. Автоматическая очистка папки logos:
   - Добавлена функция cleanupLogosDirectory() для удаления устаревших файлов логотипов
   - Очистка выполняется автоматически при:
     * Старте приложения
     * Сохранении матча (fileManager.saveMatch)
     * Смене команд местами (match:swap-teams)
     * Установке матча для мобильного сервера (mobile:set-match)
   - В папке logos остаются только актуальные файлы: logo_a.png, logo_b.png и .gitkeep
   - Безопасная обработка ошибок (не прерывает выполнение при ошибках)

Технические детали:

- Система кэширования использует useRef для хранения lastSentValuesRef с структурой:
  { inputKey: { fields: {}, colorFields: {}, visibilityFields: {}, imageFields: {} } }
- Сравнение значений с нормализацией (цвета в HEX формате, строки с trim)
- При forceUpdate=true отправляются все поля независимо от кэша
- Исключения для forceUpdate=true:
  * Создание нового матча
  * Открытие матча из файла
  * Сохранение настроек матча (MatchSettingsPage.handleSave)
  * Сохранение списков команд (RosterManagementPage.handleSave)
  * Смена команд местами
  * Ручное обновление через F5 (меню "Вид" → "Обновить данные в vMix")

Затронутые файлы:
- src/renderer/hooks/useVMix.js - система кэширования, фильтрация изменений, forceUpdate, resetImageFieldsCache
- src/renderer/pages/MatchControlPage.jsx - отслеживание первой загрузки матча, поддержка forceUpdateFromState
- src/renderer/pages/MatchSettingsPage.jsx - использование forceUpdate при сохранении и смене команд, resetImageFieldsCache
- src/renderer/pages/RosterManagementPage.jsx - использование forceUpdate при сохранении списков команд
- src/renderer/App.jsx - поддержка forceUpdateVMix флага для F5 обновления
- src/main/logoManager.js - функция cleanupLogosDirectory для очистки устаревших файлов
- src/main/fileManager.js - вызов cleanupLogosDirectory при сохранении матча
- src/main/main.js - вызов cleanupLogosDirectory при старте, смене команд, установке матча для мобильного сервера

Документация:
- Обновлен CHANGELOG.md - добавлен раздел об исправлении реакции кнопок на внешнюю активацию
- Обновлен COMMIT_MESSAGE.md - описание исправления проблемы с реакцией кнопок
```

# Текст коммита

```
Добавлены поля "Номер на карте", переименованы либеро и улучшена миграция настроек

Основные изменения:

1. Добавлены поля "Номер игрока X на карте" для стартовых составов:
   - Добавлены поля player1NumberOnCard - player6NumberOnCard для всех 6 основных игроков
   - Добавлены поля libero1NumberOnCard и libero2NumberOnCard для либеро
   - Обновлена конфигурация в vmix-input-configs.js для обоих стартовых составов (команды A и B)
   - Обновлена логика в getStartingLineupFieldValue() для обработки новых полей
   - Если специальный номер на карте не указан, автоматически используется обычный номер

2. Переименованы поля player7/8 в libero1/2 для стартовых составов:
   - Поля player7Number/Name переименованы в libero1Number/Name
   - Поля player8Number/Name переименованы в libero2Number/Name
   - Обновлена логика: либеро теперь берутся из стартового состава (индексы 6 и 7), а не из всего состава команды
   - Обновлена функция getStartingLineupFieldValue() для корректной обработки либеро из стартового состава

3. Улучшен интерфейс стартового состава:
   - Добавлены подписи "Либеро 1" и "Либеро 2" для пустых прямоугольников (ячейки 6 и 7)
   - Ячейки 0-5 остаются подписанными римскими цифрами I-VI для основных игроков
   - Переменная isReserve переименована в isLibero для ясности

4. Исправлена проблема с отображением вкладок стартовых составов в настройках vMix:
   - Реализована логика автоматического дополнения недостающих инпутов и полей при загрузке настроек
   - При загрузке настроек проверяются все обязательные инпуты и все их поля из конфигурации по умолчанию
   - Недостающие инпуты и поля автоматически добавляются из кода (vmix-input-configs.js)
   - Пользовательские настройки сохраняются при дополнении
   - Обновленный конфиг автоматически сохраняется в файл

5. Исправлена ошибка компиляции в settingsManager.js:
   - Исправлена ошибка SyntaxError: Identifier 'needsMigration' has already been declared
   - Вторая переменная переименована в needsFieldsMigration для избежания конфликта имен

Предыдущие изменения:

1. Реализована отправка данных стартовых составов в vMix:
   - Добавлены функции для автоматической отправки данных стартовых составов команд в vMix
   - Функции updateStartingLineupTeamAInput() и updateStartingLineupTeamBInput() для обновления инпутов
   - Функция getStartingLineup() для получения стартового состава с учетом порядка из startingLineupOrder
   - Функция getStartingLineupFieldValue() для получения значений полей стартового состава
   - Функция formatStartingLineupData() для форматирования данных стартового состава
   - Общие поля (заголовок, подзаголовок, логотип, название, город) совпадают с полными составами
   - Данные игроков берутся из компонента "Стартовый состав" со страницы "Управление составами"
   - Поддержка до 8 игроков в стартовом составе (6 основных + 2 запасных)
   - Поддержка полей для двух либеро (libero1Number, libero1Name, libero2Number, libero2Name)
   - Либеро берутся из всего состава команды, фильтруя по позиции "Либеро"
   - Автоматическое обновление стартовых составов при изменении данных матча
   - Кэширование отправленных значений для оптимизации
   - Добавлены записи для startingLineupTeamA и startingLineupTeamB в lastSentValuesRef

2. Добавлен drag-and-drop для основного списка игроков:
   - Добавлена возможность перетаскивать игроков для изменения порядка в основном списке команды
   - Добавлен специальный символ (три горизонтальные линии) с краю каждой строки для перетаскивания
   - Визуальная обратная связь: строка становится полупрозрачной при перетаскивании, целевая строка подсвечивается зеленым
   - Автоматическое обновление startingLineupOrder при изменении порядка игроков в основном списке
   - Порядок игроков в основном списке теперь можно изменять независимо от стартового состава
   - Функции handleRosterDragStart(), handleRosterDragEnd(), handleRosterDragOver(), handleRosterDragLeave(), handleRosterDrop()

3. Исправлена логика перетаскивания игроков:
   - Исправлена проблема с неправильной позицией вставки при перетаскивании вниз
   - Теперь элемент попадает точно на целевую позицию при перетаскивании в обоих направлениях
   - Использована правильная логика расчета индекса вставки: insertIndex = targetIndex для обоих случаев

4. Исправлена ошибка errorHandler в main.js:
   - Исправлена ошибка ReferenceError: errorHandler is not defined при открытии матча
   - Импорт errorHandler перенесен в начало файла main.js для глобальной доступности
   - Ошибка возникала в IPC handler match:open-dialog и других обработчиках

Технические детали:

- Поля "Номер на карте" берутся из player.numberOnCard или libero.numberOnCard, если указаны
- Если специальный номер на карте не указан, используется обычный номер (player.number или libero.number)
- Либеро в стартовом составе находятся на индексах 6 и 7 массива startingLineup
- Автоматическое дополнение полей происходит при каждом вызове loadSettings() в settingsManager.js
- При дополнении полей сохраняются пользовательские настройки, а типы полей обновляются из конфигурации по умолчанию

Затронутые файлы:
- src/main/vmix-input-configs.js - добавлены поля player1-6NumberOnCard и libero1-2NumberOnCard, переименованы поля player7/8 в libero1/2 для стартовых составов
- src/renderer/hooks/useVMix.js - обновлена логика getStartingLineupFieldValue() для обработки полей NumberOnCard (с fallback на обычный номер), обновлена логика обработки либеро (теперь из стартового состава по индексам 6-7)
- src/renderer/pages/RosterManagementPage.jsx - добавлены подписи "Либеро 1" и "Либеро 2" для ячеек 6 и 7 в стартовом составе, переименована переменная isReserve в isLibero
- src/main/settingsManager.js - реализована логика автоматического дополнения недостающих инпутов и полей из конфигурации по умолчанию, исправлена ошибка с двойным объявлением переменной needsMigration
- src/shared/types/Match.ts - добавлено опциональное поле numberOnCard?: string в интерфейс Player

Предыдущие изменения:

1. Исправлена реакция кнопок на активацию инпутов через vMix:
   - Исправлена проблема, когда кнопки в блоке "Управление плашками vMix" не обновляли свое состояние при активации инпутов через сам vMix (вручную), хотя периодический опрос состояния через vMix API проводился каждые 2 секунды
   - Улучшена функция updateOverlayStates() для точной проверки активности конкретных инпутов (сравнение по номерам инпутов)
   - Добавлен механизм определения внешней активации через специальный маркер '__EXTERNAL__' в activeButtonRef
   - Улучшена функция isOverlayActive() для автоматического определения активной кнопки при обнаружении внешней активации инпута
   - Реализована защита от гонки условий при одновременной проверке нескольких кнопок одного инпута через двойную проверку (double-check)
   - Кнопки теперь корректно отражают состояние инпутов в vMix независимо от способа их активации

2. Оптимизация отправки команд в vMix:
   - Реализована система отслеживания изменений полей для минимизации обращений к vMix API
   - Кэширование последних отправленных значений для каждого инпута (currentScore, lineup, rosterTeamA, rosterTeamB, startingLineupTeamA, startingLineupTeamB)
   - Отправка только измененных полей вместо всех полей при каждом обновлении
   - Функции фильтрации измененных полей: filterChangedFields, filterChangedColorFields, filterChangedVisibilityFields, filterChangedImageFields
   - Параметр forceUpdate для принудительного обновления всех полей (используется при создании/открытии матча, сохранении настроек)
   - Автоматический сброс кэша при смене матча (по matchId), переподключении к vMix, изменении конфигурации инпутов
   - Значительное снижение нагрузки на vMix API и улучшение производительности

3. Исправление обновления логотипов при смене команд:
   - Исправлена проблема, когда логотипы не обновлялись в vMix после смены команд местами
   - Добавлен timestamp к URL логотипов при принудительном обновлении (forceUpdate=true) для гарантированного перезагрузки изображений
   - Формат URL: logo_a.png?t=1234567890
   - Добавлена функция resetImageFieldsCache() в хук useVMix для сброса кэша логотипов
   - Логотипы теперь корректно обновляются при смене команд, сохранении настроек матча и списков команд

4. Автоматическая очистка папки logos:
   - Добавлена функция cleanupLogosDirectory() для удаления устаревших файлов логотипов
   - Очистка выполняется автоматически при:
     * Старте приложения
     * Сохранении матча (fileManager.saveMatch)
     * Смене команд местами (match:swap-teams)
     * Установке матча для мобильного сервера (mobile:set-match)
   - В папке logos остаются только актуальные файлы: logo_a.png, logo_b.png и .gitkeep
   - Безопасная обработка ошибок (не прерывает выполнение при ошибках)
```

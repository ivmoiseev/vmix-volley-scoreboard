# Текст коммита

```
fix: исправлена логика редактирования завершенных партий и устранены бесконечные ре-рендеры

Исправлено:
- Критическая ошибка определения текущей партии при редактировании завершенной
  (теперь проверяется не только setNumber, но и статус IN_PROGRESS)
- Проблема с сохранением счета: счет теперь корректно сохраняется в массиве sets
- Проблема с изменением статуса currentSet при редактировании завершенной партии
- Защита от изменения currentSet, когда следующая партия уже идет (IN_PROGRESS)
- Бесконечные ре-рендеры модального окна редактирования партии
- Ошибка ReferenceError: Cannot access 'match' before initialization

Добавлено:
- Модальное окно редактирования партий (SetEditModal.jsx)
  - Редактирование счета, статуса, времени начала и завершения
  - Валидация изменений с проверкой пересечения времени
  - Поддержка возврата завершенной партии в статус "В игре"
  - Блокировка изменения статуса, если следующая партия уже начата
- Утилиты для работы со временем (timeUtils.js)
  - calculateDuration, formatDuration, toTimestamp, formatTimestamp
- Валидация изменений партий (setValidation.js)
- Миграция старых матчей (matchMigration.js)
- Тесты для нового функционала

Улучшено:
- Функция сравнения areEqual в SetsDisplay.jsx для корректного обновления
- Логика обновления партий в useMatch.js с подробным логированием
- Структура MatchControlPage.jsx (useMemo, useCallback для оптимизации)

Технические детали:

1. Исправление логики определения текущей партии:
   - Старая логика: проверялся только setNumber === currentSet.setNumber
   - Новая логика: setNumber === currentSet.setNumber && currentSet.status === IN_PROGRESS
   - Это позволяет корректно различать завершенную партию и следующую партию с тем же номером

2. Защита currentSet при редактировании завершенной партии:
   - Если следующая партия уже идет (IN_PROGRESS), currentSet не изменяется
   - Если следующая партия еще не начата (PENDING), currentSet остается в статусе PENDING
   - Счет currentSet не наследуется из обновленной завершенной партии

3. Устранение бесконечных ре-рендеров:
   - Убрана IIFE для рендеринга SetEditModal
   - modalData вычисляется через useMemo после получения match
   - handleSetSave обернут в useCallback

4. Модальное окно редактирования партий:
   - Поддержка редактирования завершенных и текущих партий
   - Валидация с проверкой пересечения времени
   - Автоматическое удаление времени при изменении статуса
   - Учет часового пояса при работе со временем

Затронутые файлы:
- src/renderer/hooks/useMatch.js - исправлена логика updateSet
- src/renderer/components/SetsDisplay.jsx - улучшена функция сравнения
- src/renderer/components/SetEditModal.jsx - новый компонент
- src/renderer/pages/MatchControlPage.jsx - оптимизация рендеринга
- src/shared/timeUtils.js - новые утилиты
- src/shared/setValidation.js - валидация
- src/shared/matchMigration.js - миграция
- tests/unit/renderer/*.test.js - новые тесты
- docs/ - обновлена документация
- CHANGELOG.md - добавлено описание изменений
```

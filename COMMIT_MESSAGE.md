# Текст коммита

```
Реализована отправка стартовых составов в vMix и улучшено управление составами

Основные изменения:

1. Реализована отправка данных стартовых составов в vMix:
   - Добавлены функции для автоматической отправки данных стартовых составов команд в vMix
   - Функции updateStartingLineupTeamAInput() и updateStartingLineupTeamBInput() для обновления инпутов
   - Функция getStartingLineup() для получения стартового состава с учетом порядка из startingLineupOrder
   - Функция getStartingLineupFieldValue() для получения значений полей стартового состава
   - Функция formatStartingLineupData() для форматирования данных стартового состава
   - Общие поля (заголовок, подзаголовок, логотип, название, город) совпадают с полными составами
   - Данные игроков берутся из компонента "Стартовый состав" со страницы "Управление составами"
   - Поддержка до 8 игроков в стартовом составе (6 основных + 2 запасных)
   - Поддержка полей для двух либеро (libero1Number, libero1Name, libero2Number, libero2Name)
   - Либеро берутся из всего состава команды, фильтруя по позиции "Либеро"
   - Автоматическое обновление стартовых составов при изменении данных матча
   - Кэширование отправленных значений для оптимизации
   - Добавлены записи для startingLineupTeamA и startingLineupTeamB в lastSentValuesRef

2. Добавлен drag-and-drop для основного списка игроков:
   - Добавлена возможность перетаскивать игроков для изменения порядка в основном списке команды
   - Добавлен специальный символ (три горизонтальные линии) с краю каждой строки для перетаскивания
   - Визуальная обратная связь: строка становится полупрозрачной при перетаскивании, целевая строка подсвечивается зеленым
   - Автоматическое обновление startingLineupOrder при изменении порядка игроков в основном списке
   - Порядок игроков в основном списке теперь можно изменять независимо от стартового состава
   - Функции handleRosterDragStart(), handleRosterDragEnd(), handleRosterDragOver(), handleRosterDragLeave(), handleRosterDrop()

3. Исправлена логика перетаскивания игроков:
   - Исправлена проблема с неправильной позицией вставки при перетаскивании вниз
   - Теперь элемент попадает точно на целевую позицию при перетаскивании в обоих направлениях
   - Использована правильная логика расчета индекса вставки: insertIndex = targetIndex для обоих случаев

4. Исправлена ошибка errorHandler в main.js:
   - Исправлена ошибка ReferenceError: errorHandler is not defined при открытии матча
   - Импорт errorHandler перенесен в начало файла main.js для глобальной доступности
   - Ошибка возникала в IPC handler match:open-dialog и других обработчиках

5. Обновлена конфигурация полей для стартовых составов:
   - Удалены лишние поля player9-player14 из конфигураций startingLineupTeamA и startingLineupTeamB
   - Оставлены только поля для 8 игроков (player1-player8) в стартовых составах
   - Добавлены поля для двух либеро (libero1Number, libero1Name, libero2Number, libero2Name)

Технические детали:

- Стартовые составы отправляются автоматически вместе с полными составами при вызове updateMatchData()
- Используется та же система кэширования, что и для полных составов
- Либеро определяются по позиции "Либеро" из всего состава команды (не только из стартовых игроков)
- При перетаскивании в основном списке пересчитываются индексы в startingLineupOrder для сохранения корректного порядка стартовых игроков

Затронутые файлы:
- src/main/vmix-input-configs.js - добавлены поля для либеро в startingLineupTeamA и startingLineupTeamB, удалены лишние поля player9-player14
- src/renderer/hooks/useVMix.js - добавлены функции для обработки стартовых составов (getStartingLineup, getStartingLineupFieldValue, formatStartingLineupData, updateStartingLineupTeamAInput, updateStartingLineupTeamBInput), добавлена обработка полей либеро, добавлены записи в lastSentValuesRef и resetImageFieldsCache
- src/renderer/pages/RosterManagementPage.jsx - добавлен drag-and-drop для основного списка игроков (handleRosterDragStart, handleRosterDragEnd, handleRosterDragOver, handleRosterDragLeave, handleRosterDrop), исправлена логика перетаскивания, добавлен символ перетаскивания в таблицу
- src/main/main.js - исправлен импорт errorHandler (перенесен в начало файла)
- src/main/fileManager.js - добавлена миграция позиций "Другое" -> "Не указано" при загрузке старых файлов матчей, улучшена обработка ошибок с логированием

Предыдущие изменения:

1. Исправлена реакция кнопок на активацию инпутов через vMix:
   - Исправлена проблема, когда кнопки в блоке "Управление плашками vMix" не обновляли свое состояние при активации инпутов через сам vMix (вручную), хотя периодический опрос состояния через vMix API проводился каждые 2 секунды
   - Улучшена функция updateOverlayStates() для точной проверки активности конкретных инпутов (сравнение по номерам инпутов)
   - Добавлен механизм определения внешней активации через специальный маркер '__EXTERNAL__' в activeButtonRef
   - Улучшена функция isOverlayActive() для автоматического определения активной кнопки при обнаружении внешней активации инпута
   - Реализована защита от гонки условий при одновременной проверке нескольких кнопок одного инпута через двойную проверку (double-check)
   - Кнопки теперь корректно отражают состояние инпутов в vMix независимо от способа их активации

2. Оптимизация отправки команд в vMix:
   - Реализована система отслеживания изменений полей для минимизации обращений к vMix API
   - Кэширование последних отправленных значений для каждого инпута (currentScore, lineup, rosterTeamA, rosterTeamB, startingLineupTeamA, startingLineupTeamB)
   - Отправка только измененных полей вместо всех полей при каждом обновлении
   - Функции фильтрации измененных полей: filterChangedFields, filterChangedColorFields, filterChangedVisibilityFields, filterChangedImageFields
   - Параметр forceUpdate для принудительного обновления всех полей (используется при создании/открытии матча, сохранении настроек)
   - Автоматический сброс кэша при смене матча (по matchId), переподключении к vMix, изменении конфигурации инпутов
   - Значительное снижение нагрузки на vMix API и улучшение производительности

3. Исправление обновления логотипов при смене команд:
   - Исправлена проблема, когда логотипы не обновлялись в vMix после смены команд местами
   - Добавлен timestamp к URL логотипов при принудительном обновлении (forceUpdate=true) для гарантированного перезагрузки изображений
   - Формат URL: logo_a.png?t=1234567890
   - Добавлена функция resetImageFieldsCache() в хук useVMix для сброса кэша логотипов
   - Логотипы теперь корректно обновляются при смене команд, сохранении настроек матча и списков команд

4. Автоматическая очистка папки logos:
   - Добавлена функция cleanupLogosDirectory() для удаления устаревших файлов логотипов
   - Очистка выполняется автоматически при:
     * Старте приложения
     * Сохранении матча (fileManager.saveMatch)
     * Смене команд местами (match:swap-teams)
     * Установке матча для мобильного сервера (mobile:set-match)
   - В папке logos остаются только актуальные файлы: logo_a.png, logo_b.png и .gitkeep
   - Безопасная обработка ошибок (не прерывает выполнение при ошибках)
```

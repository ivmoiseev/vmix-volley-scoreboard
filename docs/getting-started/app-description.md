# Описание приложения vMix Volley Scoreboard

## Общее описание

**vMix Volley Scoreboard** - это десктопное приложение на базе Electron, предназначенное для управления счетом в волейбольных турнирах и интеграции с программой vMix для отображения графической информации на экранах.

## Основные функции

### 1. Управление счетом и подачей

- Отслеживание счета внутри партии (сетов)
- Отслеживание счета по партиям (общий счет матча)
- Сохранение результата каждой партии
- Автоматический учет перехода подачи при начислении очка
- Ручная коррекция перехода подачи при необходимости
- Отображение сетбола и матчбола в соответствии с правилами ВФВ (волейбол в зале)
- Управление таймерами и перерывами (при необходимости)
- Поддержка правил пляжного и снежного волейбола (документация: [Варианты волейбола](../development/volleyball-variants.md))

### 2. Управление матчами

- Создание нового матча
- Открытие существующего матча из файла
- Сохранение текущего матча
- Каждый матч сохраняется в отдельный JSON файл
- **Автосохранение матча** (включено по умолчанию):
  - Автоматическое сохранение при изменениях матча (debounce 2 секунды)
  - При первом сохранении - диалог выбора файла
  - При повторном сохранении - сохранение в тот же файл
  - При открытии из файла - все изменения сохраняются в этот же файл
  - Настройка автосохранения в UI и меню
- **Смена команд местами**:
  - Быстрая смена команд A и B местами в настройках матча
  - Автоматическая смена всех связанных данных (счет, статистика, логотипы)
  - Подтверждение перед выполнением операции

### 2.1. Импорт и экспорт настроек

- **Экспорт настроек:**
  - Экспорт всех настроек приложения в JSON файл через меню "Файл" → "Экспорт настроек..."
  - Сохранение всех секций настроек: vMix, мобильный сервер, автосохранение, автоматические обновления
  - Включает все настройки инпутов vMix и их поля (fields)
  - Валидация данных перед экспортом
  - Удобно для переноса конфигурации между установками или создания резервных копий

- **Импорт настроек:**
  - Импорт настроек из JSON файла через меню "Файл" → "Импорт настроек..."
  - **Merge стратегия:** объединение с существующими настройками (не перезапись)
  - Сохранение настроек, которых нет в импортируемом файле
  - Валидация импортируемых данных перед применением
  - Частичный импорт: можно импортировать только отдельные секции (vmix, mobile и т.д.)
  - Глубокое объединение полей (fields) в инпутах vMix
  - Предупреждения при частичном импорте или невалидных секциях
  - Игнорирование неизвестных секций с предупреждением

### 3. Интеграция с vMix

- Автоматическая отправка HTTP команд в vMix через REST API
- **Оптимизированное обновление инпутов vMix** - отправка только измененных полей для минимизации нагрузки на API
  - Кэширование последних отправленных значений для каждого инпута
  - Автоматическое сравнение и фильтрация только измененных полей
  - Принудительное обновление всех полей (`forceUpdate`) при создании/открытии матча, сохранении настроек
  - Автоматический сброс кэша при смене матча, переподключении к vMix, изменении конфигурации
- Обновление инпутов vMix с информацией о счете в реальном времени
- Поддержка 8 оверлеев для отображения информации
- Настройка IP адреса и порта компьютера с vMix
- **Детальная настройка каждого инпута** с поддержкой типов полей:
  - **Текстовые поля** (`type: "text"`) - для передачи текстовых данных
  - **Поля цвета** (`type: "color"`) - для изменения цвета элементов через команду `SetColor`
  - **Поля видимости** (`type: "visibility"`) - для управления видимостью элементов (индикатор подачи)
  - **Поля изображений** (`type: "image"`) - для установки логотипов через команду `SetImage`
- **Каждый инпут может быть выведен в любой из 8 оверлеев** (настройка для каждого инпута отдельно)
- **Каждое поле имеет свой `fieldIdentifier`** - кастомное имя для обращения к vMix
- Управление выводом плашек в оверлеи через кнопки интерфейса
- Кнопки управления плашками являются state-dependent (зависят от состояния)
- При установленном соединении с vMix кнопки синхронизируются с реальным состоянием оверлеев через периодический опрос API
- Визуальная индикация активного/неактивного состояния плашек в оверлеях
- **Настройки vMix сохраняются в глобальный файл настроек** (`settings.json`)
- **Автоматическая загрузка настроек при запуске приложения**
- **Автоматическое обновление данных в vMix** при изменении матча (debounce механизм 300ms)
- **Исправление обновления логотипов:** добавление timestamp к URL логотипов при принудительном обновлении для гарантированного перезагрузки изображений в vMix
- Поддержка следующих инпутов:
  - Заявка (TeamA vs TeamB) - `lineup`
  - Статистика - `statistics`
  - Состав команды (полный) - `roster`
  - Стартовый состав команды - `startingLineup`
  - Текущий счет (во время партии) - `currentScore`
  - Счет после 1-5 партий - `set1Score`, `set2Score`, `set3Score`, `set4Score`, `set5Score`
  - Плашка 1 судья - `referee1`
  - Плашка 2 судьи - `referee2`

### 4. Удаленное управление

- Встроенный HTTP сервер для локальной сети
- Доступ к контрольной панели с мобильных устройств по Wi-Fi
- Генерация уникальных ссылок для доступа
- **Сохранение ссылки в глобальных настройках** (не генерируется заново при каждом запуске)
- **Автоматическое восстановление ссылки при перезапуске приложения**
- Генерация QR-кодов для быстрого подключения
- **Автоматическое отображение сохраненной ссылки и QR-кода при запуске**
- Защита от несанкционированного доступа через уникальные ссылки
- **Автоматический запуск мобильного сервера при перезапуске приложения, если он был включен**
- **Сохранение состояния сервера (включен/выключен) и порта в настройках**

### 5. Настройка матча

- Задание имен команд
- Выбор цвета формы для каждой команды (HEX формат)
- Указание заголовка турнира (`tournament`)
- Указание подзаголовка турнира (`tournamentSubtitle`)
- Указание города и страны (`location`)
- Указание места проведения (`venue`)
- Указание даты и времени проведения матча
- Загрузка и сохранение составов команд
- Загрузка логотипов команд (поддержка base64 и файлов PNG)
- Автоматическое сохранение логотипов в файлы `logos/logo_a.png` и `logos/logo_b.png` для доступа через HTTP
- Автоматическая очистка папки `logos` от устаревших файлов (выполняется при старте приложения, сохранении матча, смене команд)
- Указание тренеров команд
- Указание судейской коллегии (главный судья, второй судья, судьи на линии, секретарь)
- **Быстрая смена команд местами**:
  - Кнопка "Поменять команды местами" в разделе "Команды"
  - Автоматическая смена всех данных команд (названия, цвета, логотипы, составы)
  - Автоматическая смена счета, подачи и статистики
  - Полезно перед началом матча, когда жребий определяет, кто будет командой A, а кто командой B

### 6. Расширенная статистика

- Опциональное ведение расширенной статистики
- Подсчет статистики по категориям:
  - Атака
  - Блок
  - Подачи
  - Ошибки соперника
- **Кнопки для увеличения (+1) и уменьшения (-1) значений**
- **Улучшенное отображение с подписями** (например, "Атака: 15")
- **Автоматическое сохранение статистики при изменении**
- Расширенные опции не блокируют основное ведение счета
- Статистика отображается на соответствующих плашках vMix

## Технический стек

- **Electron** (v39.2.7) - фреймворк для создания десктопного приложения
- **React** (v19.2.3) - библиотека для создания реактивного пользовательского интерфейса
- **React Router DOM** (v7.11.0) - маршрутизация в React приложении
- **Vite** (v7.3.0) - сборщик и dev-сервер для React
- **Node.js** - серверная часть для HTTP сервера и интеграции с vMix
- **Express** (v5.2.1) - HTTP сервер для мобильного доступа
- **JSON** - формат хранения данных матчей и настроек
- **electron-store** - хранение настроек (через кастомный `settingsManager`)
- **axios** - HTTP клиент для запросов к vMix API
- **qrcode** - генерация QR-кодов для мобильного доступа
- **xml2js** - парсинг XML ответов от vMix API
- **uuid** - генерация уникальных идентификаторов

## Архитектура

### Основной процесс (Main Process)

**Файлы:**

- `main.js` - точка входа, управление окнами, IPC handlers
- `server.js` - HTTP сервер для мобильного доступа (`MobileServer` класс)
- `vmix-client.js` - клиент для работы с vMix API
- `vmix-config.js` - конфигурация vMix (обертка над `settingsManager`)
- `settingsManager.js` - менеджер глобальных настроек (`settings.json`)
- `fileManager.js` - управление файлами матчей
- `logoManager.js` - управление логотипами команд
- `vmix-input-configs.js` - конфигурации полей по умолчанию для инпутов
- `preload.js` - preload скрипт для безопасного IPC

**Функциональность:**

- Управление окнами приложения
- HTTP сервер для мобильного доступа (Express)
- Интеграция с vMix через HTTP API (GET запросы)
- Работа с файловой системой (создание/открытие/сохранение матчей)
- **Управление глобальными настройками приложения** (`settings.json`)
- **Автоматическое восстановление состояния при перезапуске** (мобильный сервер, настройки vMix)
- Обработка IPC запросов от renderer процесса
- Управление сессиями мобильного доступа

### Рендер процесс (Render Process)

**Структура:**

- `index.jsx` - точка входа React приложения
- `App.jsx` - главный компонент с маршрутизацией
- `pages/` - страницы приложения:
  - `WelcomePage.jsx` - главная страница
  - `MatchControlPage.jsx` - управление матчем
  - `MatchSettingsPage.jsx` - настройки матча
  - `RosterManagementPage.jsx` - управление составами
  - `VMixSettingsPage.jsx` - настройки vMix
  - `MobileAccessPage.jsx` - мобильный доступ
  - `AboutPage.jsx` - о программе
- `components/` - переиспользуемые компоненты:
  - `Layout.jsx` - общий layout
  - `ScoreDisplay.jsx` - отображение счета
  - `SetsDisplay.jsx` - отображение сетов
  - `ScoreButtons.jsx` - кнопки управления счетом
  - `ServeControl.jsx` - управление подачей
  - `StatusIndicators.jsx` - индикаторы сетбола/матчбола
  - `VMixOverlayButtons.jsx` - кнопки управления оверлеями
  - `ErrorBoundary.jsx` - обработка ошибок
- `hooks/` - React хуки:
  - `useMatch.js` - логика управления матчем
  - `useVMix.js` - интеграция с vMix
- `utils/` - утилиты:
  - `debounce.js` - debounce функция
  - `imageResize.js` - изменение размера изображений

**Функциональность:**

- React приложение для отображения интерфейса
- Маршрутизация через React Router
- Коммуникация с основным процессом через IPC (через `window.electronAPI`)
- Автоматическое обновление данных в vMix при изменении матча
- Управление состоянием матча через хук `useMatch`
- Синхронизация с vMix через хук `useVMix`

## Сценарий использования

1. Статист или оператор запускает приложение на компьютере
2. **При первом запуске настраивает подключение к vMix:**
   - Вводит IP адрес и порт vMix
   - Настраивает каждый инпут (имя/номер, оверлей, поля с `fieldIdentifier`)
   - Настройки сохраняются автоматически в `settings.json`
3. Создает новый матч (Ctrl+N или кнопка на главной странице) или открывает существующий (Ctrl+O)
4. Настраивает параметры матча:
   - Команды (названия, цвета)
   - Турнир (заголовок, подзаголовок)
   - Место проведения (город, страна, адрес)
   - Дата и время
   - Логотипы команд (автоматически сохраняются в `logos/`)
   - Тренеры команд
   - Судейская коллегия
5. При необходимости настраивает составы команд (страница "Управление составами")
6. **Запускает мобильный сервер** (если нужен удаленный доступ):
   - На странице "Мобильный доступ" нажимает "Запустить сервер"
   - Генерируется уникальная ссылка (если еще не была создана)
   - Ссылка и QR-код отображаются автоматически
   - Состояние сервера сохраняется в настройках
7. Передает ссылку/QR-код статисту с мобильным устройством
8. Статист подключается к приложению через браузер на мобильном устройстве по уникальной ссылке
9. Статист ведет счет матча через мобильный интерфейс (упрощенный интерфейс без управления плашками)
10. Приложение автоматически обновляет информацию в vMix при любых изменениях:
    - Обновление счета → обновление инпута `currentScore`
    - Изменение настроек матча → обновление инпута `lineup`
    - Управление оверлеями через кнопки (синхронизация состояния с vMix)
11. По окончании матча сохраняется JSON файл с результатами (Ctrl+S или кнопка "Сохранить матч")
12. **При следующем запуске приложения:**
    - Все настройки vMix восстанавливаются автоматически
    - Мобильный сервер запускается автоматически, если был включен
    - Сохраненная ссылка для мобильного доступа восстанавливается

## Безопасность

- Уникальные ссылки для доступа предотвращают несанкционированный доступ
- Доступ только в пределах локальной сети
- Каждая сессия имеет уникальный идентификатор

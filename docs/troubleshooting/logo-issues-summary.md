# Решение проблем с логотипами - Сводка

*Последнее обновление: 2026-01-21*

## Обзор

Этот документ описывает все проблемы с логотипами, которые были решены в проекте, и их решения.

---

## 1. Логотипы не передавались в vMix через API команды

**Проблема:** После изменений в системе хранения логотипов (переход на `logoPath` и `logoBase64` вместо `logo`) функции формирования данных для vMix проверяли только поле `logo`, которое могло отсутствовать в объекте команды.

**Решение:**
- Обновлена проверка наличия логотипов в `getLineupFieldValue()`, `getRosterFieldValue()` и `getStartingLineupFieldValue()`
- Теперь проверяются все возможные источники: `logo`, `logoPath`, `logoBase64`
- Это обеспечивает корректное формирование URL для логотипов во всех случаях

**Файлы:**
- `src/renderer/hooks/useVMix.js`

---

## 2. Неправильные пути для логотипов в функциях составов

**Проблема:** В функциях `getRosterFieldValue()` и `getStartingLineupFieldValue()` формировался двойной путь `/logos/logos/logo_a.png`, так как `logoBaseUrl` уже содержал `/logos`.

**Решение:**
- Исправлено формирование URL: `logoBaseUrl` всегда включает `/logos` (`http://[IP]:[PORT]/logos`)
- К нему добавляется только имя файла (`logo_a.png` или `logo_b.png`)
- Результат: `http://[IP]:[PORT]/logos/logo_a.png` (корректный путь)

**Файлы:**
- `src/renderer/hooks/useVMix.js`

---

## 3. Логотипы не сохранялись в файлы при обновлении матча

**Проблема:** Функция `processTeamLogoForSave()` проверяла только поле `logo` и не использовала `logoBase64`, поэтому при обновлении уже сохраненного матча логотипы не сохранялись в файлы.

**Решение:**
- Обновлена функция для проверки и `logo`, и `logoBase64`
- Логотипы теперь всегда сохраняются в файлы при обновлении матча, независимо от источника данных

**Файлы:**
- `src/main/logoManager.ts`

---

## 4. Логотипы не работали в production сборке

**Проблема:** В production режиме папка `logos` находилась в `extraResources` (доступна только для чтения), что не позволяло сохранять и обновлять логотипы.

**Решение:**
- В production логотипы сохраняются в `userData/logos/` вместо `extraResources/logos/` (доступно для записи)
- Добавлена автоматическая миграция логотипов из `extraResources` в `userData` при первом запуске
- Сервер мобильного доступа обслуживает логотипы из `userData/logos/` в production режиме
- Пути определяются динамически через `app.getPath('userData')` в production

**Файлы:**
- `src/main/logoManager.ts`
- `src/main/server.ts`

---

## 5. Проблема работы в разных подсетях

**Проблема:** Компьютер может иметь несколько сетевых адаптеров (физических и виртуальных), и мобильный сервер мог запуститься на IP из одной подсети, а vMix находится в другой.

**Решение:**
- Добавлен выбор сетевого интерфейса на странице "Мобильный доступ"
- Выпадающий список со всеми доступными интерфейсами (с IP адресами)
- Выбранный IP сохраняется в настройках (`mobile.selectedIP`)
- Мобильный сервер использует выбранный IP вместо автоматического определения
- При изменении интерфейса требуется перезапуск сервера для применения изменений

**Файлы:**
- `src/main/server.ts`
- `src/renderer/pages/MobileAccessPage.jsx`

---

## 6. Логотипы менялись местами после сохранения настроек

**Проблема:** После нажатия "Поменять команды местами" и последующего сохранения настроек логотипы в vMix снова менялись местами, возвращаясь в исходное положение.

**Решение:**
- Обновление `logoPath` в матче после сохранения в `main.ts`
- Использование обновленного матча с правильными `logoPath` при сохранении настроек
- Правильное формирование URL логотипа на основе `teamKey` (не зависит от `logoPath`)

**Файлы:**
- `src/main/main.ts`
- `src/renderer/pages/MatchSettingsPage.jsx`
- `src/renderer/hooks/useVMix.js`

---

## 7. Очистка логотипов при открытии проекта без логотипов

**Проблема:** При открытии проекта без логотипов после проекта с логотипами, логотипы из предыдущего проекта оставались в файлах `logo_a.png` и `logo_b.png` и могли сохраниться в новый проект при автосохранении.

**Решение:**
- Добавлена проверка наличия логотипов в исходном JSON до обработки
- Если в открытом проекте нет логотипов, удаляются соответствующие файлы `logo_a.png` и `logo_b.png`
- `processTeamLogoForLoad` возвращает команду с явно установленными `undefined` для всех полей логотипов при их отсутствии
- При сохранении проекта без логотипов удаляются файлы и не устанавливается `logoPath`
- При создании нового матча вызывается `clearLogosOnNewMatch()` для удаления файлов логотипов

**Файлы:**
- `src/main/fileManager.ts`
- `src/main/logoManager.ts`
- `src/main/main.ts`

---

## 8. Принудительное обновление vMix при открытии проекта

**Проблема:** При открытии проекта из файла команды на обновление инпутов в vMix передавались только если поля в приложении не пустые. Это означало, что если в приложении пусто, данные в vMix не очищались.

**Решение:**
- Изменена проверка `hasFields` в функциях обновления для учета `forceUpdate`
- При `forceUpdate=true` всегда отправляются команды, даже если все поля пустые
- Изменены функции форматирования для отправки пустых полей при `forceUpdate=true`
- Это позволяет очистить данные в vMix при открытии пустого проекта

**Файлы:**
- `src/renderer/hooks/useVMix.js`
- `src/renderer/pages/MatchControlPage.jsx`

---

## Технические детали

### Пути к файлам в разных режимах

**Dev режим:**
- `logos/` - корень проекта (`__dirname/../../logos`)
- `matches/` - корень проекта (`__dirname/../../matches`)
- `settings.json` - `app.getPath('userData')/settings.json`

**Production режим:**
- `logos/` - `%APPDATA%/VolleyScore Master/logos/` (Windows) или `~/Library/Application Support/VolleyScore Master/logos/` (macOS)
- `matches/` - `app.getPath('userData')/matches/` (для записи; в сборку не включаются, данные импортируются при необходимости)
- `settings.json` - `%APPDATA%/VolleyScore Master/settings.json` (userData, writable)

### Миграция логотипов из extraResources в userData

При первом запуске приложения в production режиме:
1. Создается папка `userData/logos/` (если не существует)
2. Проверяется наличие файлов `logo_a.png` и `logo_b.png` в `userData/logos/`
3. Если файлы отсутствуют, копируются из `extraResources/logos/` (если доступны)
4. При последующих запусках миграция пропускается, если файлы уже существуют в `userData/logos/`

### Обратная совместимость

- Старые матчи с полем `logo` (base64) продолжают работать
- Старые матчи с полем `logoPath` продолжают работать
- При загрузке матча `logoPath` используется для определения пути к файлу
- При сохранении матча `logoBase64` всегда сохраняется для портативности

---

## Использование выбора сетевого интерфейса

1. Перейти на страницу "Мобильный доступ"
2. Выбрать нужный сетевой интерфейс из выпадающего списка (например, интерфейс в той же подсети, что и vMix - `192.168.144.x`)
3. Если сервер запущен, остановить его
4. Выбранный IP сохранится в настройках автоматически
5. Запустить сервер - он будет использовать выбранный IP
6. При следующем запуске будет использоваться сохраненный выбор

---

## Проверка работоспособности

После внесенных изменений логотипы должны:
1. ✅ Сохраняться в файлы при сохранении матча (dev и production)
2. ✅ Сохраняться в `userData/logos/` в production (доступно для записи)
3. ✅ Мигрировать из `extraResources` в `userData` при первом запуске в production
4. ✅ Передаваться в vMix через команду `SetImage` с правильными URL
5. ✅ Обслуживаться HTTP сервером из правильной папки (`userData/logos/` в production)
6. ✅ Использовать выбранный сетевой интерфейс для формирования URL
7. ✅ Работать в разных подсетях (сервер и vMix в разных подсетях)
8. ✅ Корректно очищаться при открытии проекта без логотипов
9. ✅ Корректно обновляться в vMix при открытии проекта

---

## Отладка

### Проверка доступности логотипов:
- API endpoint: `GET /api/logos/check` - возвращает информацию о доступности файлов
- Консоль браузера: логирование полной строки HTTP запроса для команды `SetImage`
- Консоль Electron: логирование путей к папкам logos и процесса миграции

### Проверка выбранного IP:
- На странице "Мобильный доступ" отображается выбранный IP
- В настройках (`settings.json`) сохраняется `mobile.selectedIP`
- В консоли сервера логируется используемый IP при запуске

---

**Связанные документы:**
- [Архитектура проекта](../architecture/ARCHITECTURE.md)
- [API vMix](../api/vmix-api-reference.md)

# Недоступные для редактирования текстовые поля в Electron (потеря фокуса после alert/confirm)

*Последнее обновление: 2026-02-12*

**Статус:** решение внедрено (2026-02-12). Все вызовы `alert`/`confirm` в рендерере заменены на IPC-диалоги (`showMessage`/`showConfirm`). Подробности и инструкция по рефакторингу — в [electron-dialog-refactoring-implementation-guide.md](../development/electron-dialog-refactoring-implementation-guide.md).

---

## Краткое описание проблемы

В некоторых случаях текстовые поля в формах перестают принимать ввод с клавиатуры: при клике мышью фокус на поле устанавливается (или кажется установленным), но ввести или изменить текст нельзя. Проблема типична для Electron-приложений на Windows и часто связана с использованием **нативных браузерных диалогов** (`alert()`, `confirm()`, `prompt()`) в процессе рендерера.

## Почему это происходит

### Известный баг Electron

В Electron (на базе Chromium) после показа нативного модального окна (`window.alert()`, `window.confirm()`, `window.prompt()`) **фокус клавиатуры не возвращается корректно** к элементам страницы. В результате:

- Поле может визуально получать фокус при клике, но ввод с клавиатуры не обрабатывается (кроме части служебных клавиш: Backspace, Delete и т.п.).
- Курсор в поле может не отображаться или вести себя некорректно.
- В обычном Chrome такого поведения нет — это особенность связки Electron + встроенный Chromium на платформе Windows.

Официально зафиксировано в репозитории Electron: [Issue #20821 — Keyboard focus is lost in input DOM elements when displaying alert or similar browser dialogs](https://github.com/electron/electron/issues/20821). Баг воспроизводится начиная с Electron 5.x и сохраняется в актуальных версиях.

### Причина

Нативный диалог перехватывает фокус окна. После закрытия диалога фокус не восстанавливается на прежнем элементе ввода в рендерере, из-за чего возникает «ловушка»: окно в фокусе, но клавиатурный ввод не доходит до полей формы.

### Временные обходные пути (для пользователя)

Пока проблема не исправлена в коде приложения, пользователь может временно восстановить ввод:

- Свернуть и снова развернуть окно приложения.
- Открыть и закрыть инструменты разработчика (DevTools).
- Переключиться на другое приложение и обратно в окно VolleyScore Master.

Эти действия заставляют окно снова получить фокус и часто восстанавливают работу полей ввода.

---

## Где проблема проявляется в проекте VolleyScore Master

### Источник: вызовы `alert()` и `confirm()` в процессе рендерера

В проекте нативные диалоги вызываются **только в процессе рендерера** (React-страницы, компоненты, хуки). Именно после этих вызовов пользователь может столкнуться с недоступными полями ввода на страницах с формами.

Кастомные модальные окна в приложении (например, `SetEditModal`, модалки на странице настроек vMix) реализованы как обычные React-компоненты (блоки с `position: fixed` и overlay). Они **не** используют `window.alert`/`confirm` и **сами по себе** не являются причиной этого бага. Проблему вызывают только нативные диалоги.

### Страницы и места вызовов (до рефакторинга)

Ниже перечислены файлы и страницы, где **ранее** использовались `alert()` и/или `window.confirm()`. В текущей версии все эти вызовы заменены на IPC-диалоги (см. статус выше).

| Файл | Тип | Контекст |
|------|-----|----------|
| **MatchSettingsPage.tsx** | `confirm`, `alert` | Подтверждение «Поменять команды местами»; сообщения об успехе/ошибке смены команд; ошибки загрузки изображений (логотипы). **Часто используемая страница с множеством полей ввода — здесь баг особенно заметен.** |
| **RosterManagementPage.tsx** | `alert` | Импорт состава: ошибка формата файла, успех импорта, ошибка чтения файла. **Страница с полями имён/номеров игроков — после импорта поля могут перестать редактироваться.** |
| **MatchControlPage.tsx** | `alert`, `confirm` | Предупреждение о несохранённых данных; подтверждение «Завершить текущую партию?». |
| **VMixSettingsPage.tsx** | `alert`, `confirm` | Ошибка сохранения настроек; подтверждение удаления инпута. |
| **WelcomePage.tsx** | `alert` | Ошибки создания/открытия матча, недоступность Electron API. |
| **Layout.tsx** | `alert` | Настройки автосохранения; сохранение матча (успех/ошибка). |
| **MobileAccessPage.tsx** | `alert` | Запуск/остановка сервера, сохранение IP, генерация сессии, копирование ссылки. |
| **useMatch.ts** | `alert` | Ошибки при операциях с матчем. |

В **main-процессе** (`main.ts`, `updater.ts`, `documentation-viewer.ts`, `fileManager.ts`) используются только API Electron: `dialog.showMessageBox`, `dialog.showErrorBox`, `dialog.showOpenDialog`, `dialog.showSaveDialog`. Они выполняются в главном процессе и **не приводят** к потере фокуса в полях ввода в рендерере. Замена `alert`/`confirm` в рендерере на вызовы через IPC к `dialog.showMessageBox` (и при необходимости `showMessageBox` с кнопками для аналога `confirm`) — рекомендуемый способ устранения бага.

---

## Нужно ли заменять кастомные модальные окна?

**Нет.** Текущие кастомные модальные окна (например, редактирование партии, добавление инпута vMix, повторное сопоставление) не используют нативные диалоги и не являются причиной описанного бага. Заменять их на другие кастомные модалки ради этого не нужно.

Имеет смысл:

1. **Не использовать** в рендерере `alert()`, `confirm()` и `prompt()`.
2. Для сообщений и вопросов использовать либо **Electron `dialog` в main-процессе через IPC**, либо **кастомные UI-компоненты** (модалки/тосты) внутри рендерера.

---

## Другие возможные причины «нередактируемых» полей

- **Стили/CSS:** `pointer-events: none`, `user-select: none` на контейнере или перекрывающем слое могут мешать вводу; проверьте, что overlay модалок не перекрывает форму после закрытия и что у полей ввода нет блокирующих правил.
- **Фокус и доступность:** при сложных формах и модалках полезно явно управлять фокусом (например, возврат фокуса на кнопку/поле после закрытия модалки) — это не исправляет баг Electron с `alert`/`confirm`, но улучшает предсказуемость поведения.
- **Дублирование обработчиков или состояние:** убедиться, что нет двойной подписки на события или состояния, блокирующих обновление значения инпута (например, `readOnly`/`disabled`, заданные по ошибке).

В контексте ваших жалоб (страницы «Настройки матча» и «Управление составами») основная и наиболее вероятная причина — вызовы `alert()` и `confirm()` на этих страницах (и при переходе с других страниц после показа диалога).

---

## Рекомендуемые способы исправления

### 1. Использовать Electron `dialog` через IPC (рекомендуется)

Перенести показ сообщений и вопросов в main-процесс и вызывать его из рендерера по IPC:

- **Аналог `alert(message)`:**  
  В main: `dialog.showMessageBox(mainWindow, { type: 'info', message, title: '...' })`.  
  Вызов из рендерера: например, `window.electronAPI.showMessage({ title: 'Информация', message })`.

- **Аналог `confirm(message)`:**  
  В main: `dialog.showMessageBox(mainWindow, { type: 'question', buttons: ['Да', 'Нет'], ... })`, вернуть выбранный индекс.  
  Вызов из рендерера: например, `const ok = await window.electronAPI.showConfirm({ title: 'Подтверждение', message })`.

Такой подход не перехватывает фокус в рендерере так, как это делают нативные браузерные диалоги, и устраняет потерю возможности редактирования полей.

**Шаги по внедрению:**

1. В `main.ts` (или отдельном модуле) реализовать обработчики IPC, например:
   - `dialog:show-message` — показ информационного окна (`showMessageBox`).
   - `dialog:show-confirm` — вопрос с кнопками «Да»/«Нет» (или «ОК»/«Отмена»), возврат результата в рендерер.
2. В `preload.cjs` пробросить в `window.electronAPI` методы вида `showMessage({ title, message })` и `showConfirm({ title, message })` (или с дополнительными параметрами).
3. В коде рендерера заменить все вызовы `alert(...)` на `await window.electronAPI.showMessage(...)` (или аналог), а `window.confirm(...)` — на `await window.electronAPI.showConfirm(...)` и использовать возвращённое значение в логике.

После замены всех использований `alert`/`confirm` в рендерере на эти API проблема с недоступными полями после диалогов должна исчезнуть.

### 2. Кастомные модальные окна / тосты в рендерере

Альтернатива — не использовать нативные диалоги вообще: показывать сообщения и вопросы через свои React-компоненты (модалки, тосты, snackbar). Это даёт полный контроль над вводом и фокусом и также устраняет баг, но требует реализации и поддержки компонентов и, при необходимости, глобального состояния для очереди сообщений.

### 3. Не делать

- **Не** полагаться на `window.alert`/`confirm`/`prompt` в рендерере в Electron на Windows — они провоцируют потерю фокуса в полях ввода.
- **Не** заменять кастомные модальные окна приложения только ради исправления этого бага — причина в нативных диалогах, а не в ваших React-модалках.

---

## Итог

| Вопрос | Ответ |
|--------|--------|
| Почему поля перестают редактироваться? | Из-за бага Electron: после `alert()`/`confirm()` в рендерере фокус клавиатуры не возвращается к полям ввода (особенно на Windows). |
| Где в проекте возникает? | На всех страницах, где вызываются `alert` или `confirm` в рендерере; вы особенно замечали на «Настройках матча» и «Управлении составами» — там эти вызовы есть и много полей ввода. |
| Виноваты ли кастомные модальные окна? | Нет. Проблему вызывают только нативные браузерные диалоги. Кастомные модалки можно оставить. |
| Что делать? | Заменить в рендерере все `alert`/`confirm` на вызовы через IPC к `dialog.showMessageBox` в main-процессе (или на кастомные UI-компоненты). |

В проекте VolleyScore Master решение внедрено: все вызовы заменены на `window.electronAPI.showMessage` и `window.electronAPI.showConfirm`; проблема с недоступными полями после диалогов устранена.

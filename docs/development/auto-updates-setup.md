# Настройка автоматических обновлений

Это руководство описывает реализованную систему автоматических обновлений для приложения VolleyScore Master.

## Обзор

Приложение использует `electron-updater` для автоматической проверки и установки обновлений через GitHub Releases. Система работает только в production режиме и автоматически проверяет наличие новых версий при запуске приложения (с задержкой 10 секунд). Пользователь может отключить автоматическую проверку обновлений через настройки на странице "О программе".

## Архитектура

### Компоненты

1. **`src/main/updater.js`** - модуль управления обновлениями
   - Инициализация системы обновлений
   - Обработка событий от `electron-updater`
   - Показ диалогов пользователю
   - Проверка обновлений при запуске приложения

2. **IPC каналы** (в `src/main/main.js` и `src/main/preload.cjs`):
   - `update:check` - проверка обновлений
   - `update:download` - загрузка обновления
   - `update:install` - установка обновления
   - `update-status` - событие статуса обновления (от main к renderer)
   - `autoupdate:get-settings` - получение настроек автоматических обновлений
   - `autoupdate:set-settings` - сохранение настроек автоматических обновлений

3. **UI компонент** (`src/renderer/pages/AboutPage.jsx`):
   - Отображение статуса обновлений
   - Переключатель автоматической проверки обновлений
   - Кнопки для управления обновлениями
   - Прогресс-бар загрузки

4. **Настройки** (`src/main/settingsManager.js`):
   - Хранение настройки `autoUpdate.enabled` в файле настроек
   - Управление включением/отключением автоматических обновлений

## Настройка

### 1. Конфигурация electron-builder

В `package.json` уже настроена конфигурация для публикации на GitHub:

```json
{
  "build": {
    "publish": [
      {
        "provider": "github",
        "owner": "ivmoiseev",
        "repo": "vmix-volley-scoreboard"
      }
    ]
  }
}
```

### 2. GitHub Token

Для публикации релизов через `electron-builder` необходим GitHub Personal Access Token с правами для создания релизов.

**Создание токена (рекомендуется - Classic Token):**
1. Перейдите в GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Нажмите "Generate new token (classic)"
3. **ВАЖНО:** Выберите scope `repo` (полный доступ к репозиторию) - это включает права на создание релизов
4. Укажите срок действия токена (рекомендуется: 90 дней или без ограничений для CI/CD)
5. Нажмите "Generate token"
6. **Скопируйте токен сразу** - он больше не будет показан!
7. Сохраните токен в безопасном месте

**Альтернатива - Fine-grained Token:**
Если используете Fine-grained токены, убедитесь, что включены следующие права:
- `Contents: Write` - для загрузки файлов релиза
- `Metadata: Read` - для чтения информации о репозитории
- `Releases: Write` - для создания и редактирования релизов (если доступно)

⚠️ **Примечание:** Для большинства случаев рекомендуется использовать Classic Token с scope `repo`, так как это проще и надежнее.

**Использование токена:**
- **Рекомендуется:** Создайте файл `.env` в корне проекта (уже в `.gitignore`):
  ```bash
  GH_TOKEN=your_github_token_here
  ```
  Токен будет автоматически загружен при сборке через `dotenv-cli` (уже установлен как dev dependency).
- Или установите переменную окружения перед сборкой:
  ```bash
  # Windows PowerShell:
  $env:GH_TOKEN="your_github_token_here"
  npm run build:electron:publish
  
  # Linux/Mac:
  export GH_TOKEN=your_github_token_here
  npm run build:electron:publish
  ```
  
⚠️ **ВАЖНО:** Файл `.env` уже добавлен в `.gitignore` и не будет закоммичен в репозиторий. Никогда не коммитьте токены в git!

### 3. Публикация релиза

Для публикации нового релиза:

1. **Обновите CHANGELOG.md:**
   - Добавьте секцию для новой версии в формате:
     ```markdown
     ## [1.0.7] - 2026-01-21
     
     ### Добавлено
     - Новая функция X
     
     ### Исправлено
     - Исправлена ошибка Y
     ```
   - Переместите записи из `[Unreleased]` в секцию новой версии
   - Укажите правильную дату релиза

2. **Обновите версию** в `package.json`:
   ```json
   {
     "version": "1.0.7"
   }
   ```
   ⚠️ **ВАЖНО:** Версия в `package.json` должна совпадать с версией в `CHANGELOG.md`!

3. **Создайте git tag**:
   ```bash
   git tag v1.0.7
   git push origin v1.0.7
   ```

3. **Соберите и опубликуйте**:
   
   ⚠️ **ВАЖНО:** Для работы автоматических обновлений необходимо использовать `--publish always`, чтобы `electron-builder` автоматически создал и загрузил файл `latest.yml` на GitHub.
   
   ```bash
   # Если токен в .env файле (рекомендуется):
   npm run build:electron:publish
   
   # Или если токен в переменной окружения:
   GH_TOKEN=your_token npm run build:electron:publish
   ```
   
   Или если вы хотите только собрать без публикации:
   ```bash
   npm run build:electron
   ```
   ⚠️ **Внимание:** Если релиз создан вручную без `--publish always`, файл `latest.yml` не будет создан, и автоматические обновления не будут работать. В этом случае приложение покажет сообщение о том, что автоматическая проверка недоступна.

4. **GitHub Release создается автоматически:**
   - При использовании `npm run build:electron:publish` релиз создается автоматически
   - Release notes извлекаются из `CHANGELOG.md` для текущей версии
   - Файлы установщика и `latest.yml` загружаются автоматически
   - Релиз публикуется как "release" (не draft)
   
   **Примечание:** Если нужно создать draft релиз, отредактируйте его на GitHub после публикации

### 4. Release Notes

**Автоматическое извлечение из CHANGELOG.md:**

При использовании `npm run build:electron:publish` release notes автоматически извлекаются из `CHANGELOG.md` для текущей версии.

**Как это работает:**
1. Скрипт `scripts/extract-release-notes.js` читает версию из `package.json`
2. Находит соответствующую секцию в `CHANGELOG.md` (формат: `## [1.0.7] - 2026-01-21`)
3. Извлекает все изменения до следующей версии
4. Сохраняет в `release-notes.txt` (временно, не коммитится)
5. `electron-builder` использует этот файл для заполнения описания GitHub Release

**Формат CHANGELOG.md:**
```markdown
## [1.0.7] - 2026-01-21

### Добавлено
- Новая функция X
- Улучшение Y

### Исправлено
- Исправлена ошибка Z
```

**Ручное редактирование:**
Если нужно изменить release notes перед публикацией:
1. Запустите `npm run extract:release-notes` для создания `release-notes.txt`
2. Отредактируйте `release-notes.txt`
3. Запустите `npm run build:electron:publish` (он использует уже созданный файл)

**Альтернатива - ручное добавление:**
Если release notes не были автоматически добавлены, вы можете:
- Отредактировать релиз на GitHub после публикации
- Или добавить описание вручную при создании релиза

## Работа системы обновлений

### Автоматическая проверка

1. **При запуске приложения** (с задержкой 10 секунд):
   - Проверяется настройка автоматических обновлений
   - Если автоматические обновления включены, проверяется наличие обновлений на GitHub
   - Если обновление найдено, показывается диалог

### Отключение автоматических обновлений

Пользователь может отключить автоматическую проверку обновлений:
- На странице "О программе" есть переключатель "Автоматическая проверка при запуске"
- При отключении автоматических обновлений проверка при запуске не выполняется
- Пользователь все еще может проверить обновления вручную, нажав кнопку "Проверить обновления"

### Процесс обновления

1. **Проверка обновлений**:
   - Приложение запрашивает информацию о последней версии с GitHub
   - Сравнивается с текущей версией

2. **Уведомление пользователя**:
   - Если обновление доступно, показывается диалог с информацией
   - Пользователь может выбрать "Скачать" или "Позже"

3. **Загрузка обновления**:
   - Обновление скачивается в фоновом режиме
   - Отображается прогресс-бар с процентом загрузки

4. **Установка обновления**:
   - После загрузки показывается диалог о готовности к установке
   - Пользователь может выбрать "Установить сейчас" или "Установить при выходе"
   - При установке приложение перезапускается

### Ручная проверка обновлений

Пользователь может вручную проверить обновления:
- Перейти на страницу "О программе"
- Нажать кнопку "Проверить обновления"

## Настройка автоматических обновлений

### Для пользователя

Пользователь может управлять автоматическими обновлениями через интерфейс:
1. Перейдите на страницу "О программе"
2. В разделе "Обновления" найдите переключатель "Автоматическая проверка при запуске"
3. Включите или отключите автоматическую проверку

### Для разработчика

Настройка автоматических обновлений хранится в файле `settings.json` в секции `autoUpdate`:

```json
{
  "autoUpdate": {
    "enabled": true
  }
}
```

По умолчанию автоматические обновления включены (`enabled: true`).

## Режим разработки

В режиме разработки (`NODE_ENV === "development"` или `!app.isPackaged`):
- Автоматические обновления отключены
- Проверка обновлений не выполняется
- Это предотвращает конфликты при разработке

## Обработка ошибок

Система обрабатывает следующие ошибки:
- Ошибки сети при проверке обновлений
- Ошибки при загрузке обновления
- Ошибки при установке обновления

Все ошибки логируются в консоль и отображаются пользователю через UI.

## Безопасность

### Подпись обновлений

Для Windows рекомендуется подписывать установщики:
- Настройте код-подписание в `package.json`:
  ```json
  {
    "build": {
      "win": {
        "signAndEditExecutable": true,
        "certificateFile": "path/to/certificate.pfx",
        "certificatePassword": "password"
      }
    }
  }
  ```

### Проверка целостности

`electron-updater` автоматически проверяет:
- Целостность загруженных файлов
- Соответствие версии
- Подпись установщика (если настроено)

## Отладка

### Логи

Все события обновлений логируются в консоль с префиксом `[Updater]`:
- Проверка обновлений
- Доступность обновлений
- Прогресс загрузки
- Ошибки

### Тестирование

Для тестирования обновлений:
1. Создайте тестовый релиз с версией выше текущей
2. Запустите приложение в production режиме
3. Проверьте работу системы обновлений

**Важно:** Не тестируйте обновления на production версии, используйте отдельную тестовую среду.

## Troubleshooting

### Ошибка "Cannot find latest.yml" (404)

**Причина:** Файл `latest.yml` отсутствует в релизе на GitHub. Это происходит, если релиз был создан вручную без использования `electron-builder --publish always`.

**Как это выглядит для пользователя:**
- Приложение показывает сообщение: "Автоматическая проверка обновлений недоступна. Проверьте обновления вручную на GitHub."
- Это не критическая ошибка, приложение продолжает работать нормально
- Пользователь может проверить обновления вручную, нажав кнопку "Проверить обновления"

**Решение для разработчика:**
1. **Для новых релизов:** Используйте скрипт `build:electron:publish`:
   ```bash
   # Если токен в .env файле:
   npm run build:electron:publish
   
   # Или если токен в переменной окружения:
   GH_TOKEN=your_token npm run build:electron:publish
   ```
   Это автоматически создаст и загрузит файл `latest.yml` на GitHub.

2. **Для существующих релизов:** 
   - Пересоберите релиз с `--publish always` (рекомендуется)
   - Или вручную загрузите файл `latest.yml` в релиз:
     - Файл находится в папке `release/` после сборки
     - Загрузите его как asset в существующий релиз на GitHub

**Примечание:** Приложение обрабатывает эту ошибку корректно и не показывает её как критическую. Пользователь видит информативное сообщение с ссылкой на GitHub Releases.

### Обновления не проверяются

1. Проверьте, что приложение запущено в production режиме
2. Проверьте наличие интернет-соединения
3. Проверьте логи в консоли на наличие ошибок
4. Убедитесь, что GitHub Releases доступны публично
5. Убедитесь, что в релизе есть файл `latest.yml` (создается автоматически при использовании `--publish always`)

### Ошибка "Cannot find module 'electron-updater'"

Установите зависимость:
```bash
npm install electron-updater --save-dev
```

### Обновление не устанавливается

1. Проверьте права доступа к папке установки
2. Убедитесь, что установщик не поврежден
3. Проверьте логи на наличие ошибок

### Ошибка 403 Forbidden "Resource not accessible by personal access token"

**Причина:** GitHub токен не имеет достаточных прав для создания релизов.

**Симптомы:**
- Ошибка `HttpError: 403 Forbidden` при попытке опубликовать релиз
- Сообщение: "Resource not accessible by personal access token"

**Решение:**

1. **Проверьте права токена:**
   - Для Classic Token: убедитесь, что выбран scope `repo` (полный доступ к репозиторию)
   - Для Fine-grained Token: проверьте, что включены права `Contents: Write` и `Metadata: Read`

2. **Создайте новый токен с правильными правами:**
   - Перейдите в GitHub → Settings → Developer settings → Personal access tokens
   - Удалите старый токен (если нужно)
   - Создайте новый Classic Token с scope `repo`
   - Обновите токен в файле `.env`:
     ```bash
     GH_TOKEN=новый_токен_здесь
     ```

3. **Проверьте, что токен загружается:**
   - Убедитесь, что файл `.env` находится в корне проекта
   - Проверьте, что в `.env` нет лишних пробелов или кавычек вокруг токена
   - Формат должен быть: `GH_TOKEN=github_pat_...` (без пробелов вокруг `=`)

4. **Для Fine-grained токенов:**
   - Убедитесь, что токен имеет доступ к нужному репозиторию
   - Проверьте, что включены права:
     - `Contents: Write`
     - `Metadata: Read`
     - `Releases: Write` (если доступно)

**Рекомендация:** Используйте Classic Token с scope `repo` для максимальной совместимости с `electron-builder`.

### GitHub API rate limit

Если превышен лимит запросов к GitHub API:
- Используйте GitHub Token для увеличения лимита
- Увеличьте интервал проверки обновлений

### Обработка ошибок в коде

Приложение автоматически обрабатывает следующие ситуации:
- **Отсутствие latest.yml (404)**: Показывается сообщение о недоступности автоматической проверки, но не критическая ошибка
- **Ошибки сети**: Логируются в консоль и отображаются пользователю
- **Ошибки загрузки**: Показывается диалог с описанием ошибки

## Дополнительные ресурсы

- [electron-updater документация](https://www.electron.build/auto-update)
- [electron-builder документация](https://www.electron.build/)
- [GitHub Releases API](https://docs.github.com/en/rest/releases)

## Известные ограничения

1. **Только production режим**: Обновления работают только в production сборке
2. **GitHub Releases**: Требуется публичный доступ к GitHub Releases
3. **Windows**: Для полной функциональности рекомендуется подпись установщиков
4. **Интернет**: Требуется активное интернет-соединение для проверки обновлений
5. **Проверка только при запуске**: Автоматическая проверка выполняется только при запуске приложения, периодическая проверка не реализована

## Будущие улучшения

- [x] Отключение автоматических обновлений через настройки
- [ ] Периодическая проверка обновлений (опционально)
- [ ] Каналы обновлений (stable, beta, alpha)
- [ ] Дельта-обновления для уменьшения размера загрузки
- [ ] Поддержка обновлений через собственный сервер

---

*Последнее обновление: 2026-01-21*

## Примечание о .env файле

Файл `.env` с GitHub Token уже создан в корне проекта и добавлен в `.gitignore`. 
Токен автоматически загружается через `dotenv-cli` при выполнении команды `npm run build:electron:publish`.
Скрипт использует `dotenv-cli` для загрузки переменных окружения из `.env` файла перед запуском `electron-builder`.

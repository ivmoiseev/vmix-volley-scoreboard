# Настройка автоматических обновлений

Это руководство описывает реализованную систему автоматических обновлений для приложения VolleyScore Master.

## Обзор

Приложение использует `electron-updater` для автоматической проверки и установки обновлений через GitHub Releases. Система работает только в production режиме и автоматически проверяет наличие новых версий при запуске приложения (с задержкой 10 секунд). Пользователь может отключить автоматическую проверку обновлений через настройки на странице "О программе".

## Архитектура

### Компоненты

1. **`src/main/updater.js`** - модуль управления обновлениями
   - Инициализация системы обновлений
   - Обработка событий от `electron-updater`
   - Показ диалогов пользователю
   - Проверка обновлений при запуске приложения

2. **IPC каналы** (в `src/main/main.js` и `src/main/preload.cjs`):
   - `update:check` - проверка обновлений
   - `update:download` - загрузка обновления
   - `update:install` - установка обновления
   - `update-status` - событие статуса обновления (от main к renderer)
   - `autoupdate:get-settings` - получение настроек автоматических обновлений
   - `autoupdate:set-settings` - сохранение настроек автоматических обновлений

3. **UI компонент** (`src/renderer/pages/AboutPage.jsx`):
   - Отображение статуса обновлений
   - Переключатель автоматической проверки обновлений
   - Кнопки для управления обновлениями
   - Прогресс-бар загрузки

4. **Настройки** (`src/main/settingsManager.js`):
   - Хранение настройки `autoUpdate.enabled` в файле настроек
   - Управление включением/отключением автоматических обновлений

## Настройка

### 1. Конфигурация electron-builder

В `package.json` уже настроена конфигурация для публикации на GitHub:

```json
{
  "build": {
    "publish": [
      {
        "provider": "github",
        "owner": "ivmoiseev",
        "repo": "vmix-volley-scoreboard"
      }
    ]
  }
}
```

### 2. GitHub Token

Для публикации релизов через `electron-builder` необходим GitHub Personal Access Token с правами `repo`.

**Создание токена:**
1. Перейдите в GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Создайте новый токен с правами `repo`
3. Сохраните токен в безопасном месте

**Использование токена:**
- Установите переменную окружения `GH_TOKEN` перед сборкой:
  ```bash
  export GH_TOKEN=your_github_token_here
  ```
- Или используйте файл `.env` (не коммитьте его в git!)

### 3. Публикация релиза

Для публикации нового релиза:

1. **Обновите версию** в `package.json`:
   ```json
   {
     "version": "1.0.7"
   }
   ```

2. **Создайте git tag**:
   ```bash
   git tag v1.0.7
   git push origin v1.0.7
   ```

3. **Соберите и опубликуйте**:
   ```bash
   npm run build:electron
   ```
   
   Или для публикации на GitHub:
   ```bash
   GH_TOKEN=your_token npm run build:electron -- --publish always
   ```

4. **Создайте GitHub Release**:
   - Перейдите в GitHub → Releases → Draft a new release
   - Выберите созданный tag
   - Заполните описание релиза (release notes)
   - `electron-builder` автоматически загрузит файлы установщика

### 4. Release Notes

Release notes можно указать:
- В описании GitHub Release (будет автоматически подхвачено)
- В файле `release-notes.md` (если настроено)

## Работа системы обновлений

### Автоматическая проверка

1. **При запуске приложения** (с задержкой 10 секунд):
   - Проверяется настройка автоматических обновлений
   - Если автоматические обновления включены, проверяется наличие обновлений на GitHub
   - Если обновление найдено, показывается диалог

### Отключение автоматических обновлений

Пользователь может отключить автоматическую проверку обновлений:
- На странице "О программе" есть переключатель "Автоматическая проверка при запуске"
- При отключении автоматических обновлений проверка при запуске не выполняется
- Пользователь все еще может проверить обновления вручную, нажав кнопку "Проверить обновления"

### Процесс обновления

1. **Проверка обновлений**:
   - Приложение запрашивает информацию о последней версии с GitHub
   - Сравнивается с текущей версией

2. **Уведомление пользователя**:
   - Если обновление доступно, показывается диалог с информацией
   - Пользователь может выбрать "Скачать" или "Позже"

3. **Загрузка обновления**:
   - Обновление скачивается в фоновом режиме
   - Отображается прогресс-бар с процентом загрузки

4. **Установка обновления**:
   - После загрузки показывается диалог о готовности к установке
   - Пользователь может выбрать "Установить сейчас" или "Установить при выходе"
   - При установке приложение перезапускается

### Ручная проверка обновлений

Пользователь может вручную проверить обновления:
- Перейти на страницу "О программе"
- Нажать кнопку "Проверить обновления"

## Настройка автоматических обновлений

### Для пользователя

Пользователь может управлять автоматическими обновлениями через интерфейс:
1. Перейдите на страницу "О программе"
2. В разделе "Обновления" найдите переключатель "Автоматическая проверка при запуске"
3. Включите или отключите автоматическую проверку

### Для разработчика

Настройка автоматических обновлений хранится в файле `settings.json` в секции `autoUpdate`:

```json
{
  "autoUpdate": {
    "enabled": true
  }
}
```

По умолчанию автоматические обновления включены (`enabled: true`).

## Режим разработки

В режиме разработки (`NODE_ENV === "development"` или `!app.isPackaged`):
- Автоматические обновления отключены
- Проверка обновлений не выполняется
- Это предотвращает конфликты при разработке

## Обработка ошибок

Система обрабатывает следующие ошибки:
- Ошибки сети при проверке обновлений
- Ошибки при загрузке обновления
- Ошибки при установке обновления

Все ошибки логируются в консоль и отображаются пользователю через UI.

## Безопасность

### Подпись обновлений

Для Windows рекомендуется подписывать установщики:
- Настройте код-подписание в `package.json`:
  ```json
  {
    "build": {
      "win": {
        "signAndEditExecutable": true,
        "certificateFile": "path/to/certificate.pfx",
        "certificatePassword": "password"
      }
    }
  }
  ```

### Проверка целостности

`electron-updater` автоматически проверяет:
- Целостность загруженных файлов
- Соответствие версии
- Подпись установщика (если настроено)

## Отладка

### Логи

Все события обновлений логируются в консоль с префиксом `[Updater]`:
- Проверка обновлений
- Доступность обновлений
- Прогресс загрузки
- Ошибки

### Тестирование

Для тестирования обновлений:
1. Создайте тестовый релиз с версией выше текущей
2. Запустите приложение в production режиме
3. Проверьте работу системы обновлений

**Важно:** Не тестируйте обновления на production версии, используйте отдельную тестовую среду.

## Troubleshooting

### Обновления не проверяются

1. Проверьте, что приложение запущено в production режиме
2. Проверьте наличие интернет-соединения
3. Проверьте логи в консоли на наличие ошибок
4. Убедитесь, что GitHub Releases доступны публично

### Ошибка "Cannot find module 'electron-updater'"

Установите зависимость:
```bash
npm install electron-updater --save-dev
```

### Обновление не устанавливается

1. Проверьте права доступа к папке установки
2. Убедитесь, что установщик не поврежден
3. Проверьте логи на наличие ошибок

### GitHub API rate limit

Если превышен лимит запросов к GitHub API:
- Используйте GitHub Token для увеличения лимита
- Увеличьте интервал проверки обновлений

## Дополнительные ресурсы

- [electron-updater документация](https://www.electron.build/auto-update)
- [electron-builder документация](https://www.electron.build/)
- [GitHub Releases API](https://docs.github.com/en/rest/releases)

## Известные ограничения

1. **Только production режим**: Обновления работают только в production сборке
2. **GitHub Releases**: Требуется публичный доступ к GitHub Releases
3. **Windows**: Для полной функциональности рекомендуется подпись установщиков
4. **Интернет**: Требуется активное интернет-соединение для проверки обновлений
5. **Проверка только при запуске**: Автоматическая проверка выполняется только при запуске приложения, периодическая проверка не реализована

## Будущие улучшения

- [x] Отключение автоматических обновлений через настройки
- [ ] Периодическая проверка обновлений (опционально)
- [ ] Каналы обновлений (stable, beta, alpha)
- [ ] Дельта-обновления для уменьшения размера загрузки
- [ ] Поддержка обновлений через собственный сервер

---

*Последнее обновление: 2026-01-21*

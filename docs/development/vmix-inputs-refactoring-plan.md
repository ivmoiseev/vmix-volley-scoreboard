# План рефакторинга: работа с инпутами vMix (динамическая настройка)

*Последнее обновление: 2026-02-03*

## Обзор

Документ описывает план крупного рефакторинга страницы «Настройки подключения к vMix». Цель — перейти от фиксированного набора предопределённых инпутов к динамической модели: подключение к vMix, получение списка инпутов типа GT через API, добавление инпутов и полей через сопоставление с данными приложения (vmix-data-map).

**Используемые источники:**
- Структура проекта и правила: `.cursor/rules/`, `docs/architecture/ARCHITECTURE.md`
- Карта данных: `docs/development/vmix-data-map.md`
- Пример ответа vMix API: `docs/api/vmix-api-response.xml`
- Текущая реализация настроек: `docs/architecture/vmix-settings-redesign-plan.md`

---

## 1. Подключение к vMix

### 1.1. Текущее состояние

- На странице есть поля «Адрес» и «Порт», кнопка «Тест подключения».
- Результат теста отображается в UI, но **состояние подключения не сохраняется** в настройки и не восстанавливается при запуске.
- Настройки `host` и `port` сохраняются в `settings.json` при нажатии «Сохранить настройки».

### 1.2. Целевая логика

| Условие | Действие |
|--------|-----------|
| Подключение не установлено | В группе «Подключение»: поля «Адрес» и «Порт», кнопка **«Подключить»**. |
| Нажатие «Подключить» | Выполнить запрос к `http://{host}:{port}/api`. При успехе: сохранить в `settings.json` адрес, порт и **состояние подключения** (`vmix.connectionState: "connected"`). Кнопка меняется на **«Отключить»**. |
| Нажатие «Отключить» | Сохранить в настройки **`connectionState: "disconnected"`** (в т.ч. записать в файл настроек), чтобы при следующем запуске приложение не пыталось автоматически подключиться. Кнопка меняется на «Подключить». Аналогично при «Подключить» состояние `"connected"` сохранять в файл. |
| Ошибка подключения | Показать сообщение об ошибке, состояние не менять. |
| При запуске приложения | Загрузить настройки из `settings.json`. Если есть `host`, `port` и состояние «подключено» — **автоматически** выполнить подключение (запрос к API). Восстановить последнее состояние (подключён/отключён). |

**Индикатор подключения на других страницах:** индикатор состояния подключения к vMix оставить **только там, где он уже реализован** (главная, управление матчем). Новые индикаторы на других страницах не добавлять.

**Хранение настроек:** существующий механизм через `settingsManager` (файл настроек в `app.getPath('userData')/settings.json`). Добавить в секцию `vmix` поля для состояния подключения (см. раздел 5).

**Функции управления настройками** уже есть (`settingsManager.ts`, IPC `settings:*`, `vmix:*`); их нужно использовать для сохранения/загрузки `host`, `port` и флага подключения.

---

## 2. Получение списка инпутов типа GT после подключения

### 2.1. Источник данных

- Запрос: `GET http://{host}:{port}/api` (без параметров).
- Ответ — XML (см. `docs/api/vmix-api-response.xml`).

Структура инпутов в XML:

```xml
<input key="..." number="10" type="GT" title="SCORE" shortTitle="SCORE" ...>
  <text index="0" name="Count_Team1.Text">17</text>
  <color index="0" name="Color_Team1.Fill.Color">#000000</color>
  <image index="0" name="Logo_Team1.Source">http://...</image>
</input>
```

Инпуты с **типом GT** (`type="GT"`) — это титры/графика, которыми управляет приложение.

### 2.2. Требуемые изменения в Main Process

1. **Расширить метод получения инпутов в `vmix-client.ts`:**
   - Вариант A: добавить метод `getGTInputs()`, который вызывает `GET /api`, парсит XML и возвращает только инпуты с `type="GT"`.
   - Вариант B: расширить существующий `getInputs()` параметром `filterByType?: 'GT'` и включать в ответ атрибут `type` у каждого инпута.

   Рекомендуется: отдельный метод `getGTInputs()` для ясности, плюс при необходимости общий `getInputs({ type?: string })`.

2. **Формат возвращаемых данных для инпута GT:**
   - `number` — номер инпута в vMix;
   - `key` — уникальный ключ из vMix (GUID);
   - `title`, `shortTitle` — для отображения в выпадающем списке «Добавить инпут».
   - Все три свойства (`key`, `number`, `title`) при добавлении инпута **обязательно сохраняются** в настройках (см. раздел 3.4 и раздел 5).

3. **Метод получения полей выбранного инпута:**
   - Добавить в `vmix-client.ts` метод вида `getInputFields(inputNumber)` или использовать полный ответ API и извлекать для указанного инпута дочерние элементы:
     - `<text index="..." name="...">` → тип `text`, имя поля — атрибут `name`;
     - `<color index="..." name="...">` → тип `color` (или `fill`);
     - `<image index="..." name="...">` → тип `image`.
   - Возвращать массив: `{ type: 'text' | 'color' | 'image', name: string, index: number }[]` (имя используется в API vMix при SetText/SetColor/SetImage).

4. **IPC:** добавить обработчики, например:
   - `vmix:getGTInputs` — возвращает список GT-инпутов (вызов после успешного подключения);
   - `vmix:getInputFields` — возвращает поля выбранного инпута по номеру/ключу.

Получение списка GT-инпутов выполняется **после успешного подключения** и при открытии модального окна «Добавить инпут» (или при загрузке страницы, если уже подключено).

---

## 3. Настройка инпутов: пустой старт и добавление инпута

### 3.1. Текущее состояние

- В настройках задан фиксированный набор инпутов (currentScore, lineup, rosterTeamA, …) с предопределёнными ключами и полями из `vmix-input-configs.ts` и `inputLabels`.

### 3.2. Целевая логика

- **В новом проекте (или после сброса конфигурации)** блок «Настройка инпутов» изначально **пустой**: нет ни одного инпута в левой колонке.
- Структура блока сохраняется: **слева** — список инпутов, **справа** — настройки выбранного инпута.
- **Сверху** блока «Настройка инпутов» добавляется кнопка **«Добавить инпут»**. **Дублирование по title допускается:** один и тот же GT-инпут vMix (один и тот же title) можно добавить в приложение несколько раз с разными отображаемыми именами (например, «Тренер А», «Первый судья», «Второй судья» на базе инпута TITLES). В модальном окне «Добавить инпут» разрешён выбор любого GT-инпута из списка, в том числе уже выбранного в другом нашем инпуте.

### 3.3. Добавление инпута

1. Пользователь нажимает «Добавить инпут».
2. Открывается **модальное окно** с полями:
   - **Произвольное название** (текстовое поле) — отображаемое имя в левой колонке приложения (например, «Текущий счёт», «Заявка»).
   - **Выпадающий список** — инпуты vMix с типом GT, полученные через `vmix:getGTInputs` (отображать можно `title` или `shortTitle`, в настройках сохранять номер/ключ инпута vMix).
3. Подтверждение (например, «Добавить» / «Сохранить»):
   - Сохранить сопоставление: внутренний идентификатор приложения (например, уникальный id или слаг) ↔ **обязательно** свойства инпута vMix: `key`, `number`, `title` (см. раздел 3.4).
   - Добавить запись в `config.inputs` (или аналог) и отобразить новый инпут в левой колонке.
4. При выборе этого инпута в левой колонке справа показывается панель настроек полей (см. раздел 4).

Сохраняемые данные для одного инпута (минимально):
- `displayName` — произвольное имя в UI (отображаемое в левой колонке приложения);
- `vmixTitle` — **основной** идентификатор для обращения к инпуту в vMix API (см. раздел 3.4);
- `vmixKey` — уникальный ключ инпута в vMix (сохраняется для будущего функционала);
- `vmixNumber` — номер инпута в vMix (сохраняется для будущего функционала);
- `enabled` — включён/выключен;
- `overlay` — номер оверлея (1–8);
- `fields` — объект настройки полей (см. ниже).

### 3.4. Обращение к инпутам по title

При добавлении нового инпута в настройки **обязательно сохраняются** три свойства из ответа vMix API: **key**, **number**, **title**.

В дальнейшем при использовании приложения (отправка команд в vMix) обращение к инпуту выполняется **по title**: в запросах к vMix API параметр **Input** передаётся **напрямую как title инпута** (URL-кодированный), без определения номера инпута. Пример из документации vMix: `http://127.0.0.1:8088/api/?Function=SetColor&Input=My%20input&Value=#0033AA22&SelectedName=Text1` — здесь `My%20input` это title инпута. Таким образом, при отправке SetText/SetColor/SetImage/SetImage и т.д. используем `Input=<vmixTitle в URL-кодировке>`; отдельный шаг «поиск инпута по title → number» не нужен.

**Требование к шаблонам vMix:** один и тот же инпут (один и тот же титр/графика) в разных проектах vMix должен иметь **одинаковый title**. Тогда настройки приложения останутся работоспособными при переключении между проектами или после перемещения инпутов.

Поля **number** и **key** сохраняем в настройках на случай будущего функционала (например, обращение по номеру при известной стабильности сцены).

Возможность **включить/выключить** инпут и **сменить отображаемое имя** (`displayName`) сохраняется. Выбор **номера оверлея** остаётся, как в текущей реализации.

### 3.5. Редактирование и удаление инпутов. Порядок отображения

- **Редактирование инпута:** для выбранного инпута в правой панели предусматривается возможность изменить отображаемое имя (`displayName`), включение/выключение, номер оверлея. Изменения сохраняются в конфиг (в памяти); запись в файл — при нажатии кнопки «Сохранить» внизу страницы. Сопоставление с инпутом vMix (vmixTitle, vmixKey, vmixNumber) после добавления не меняется — при необходимости пользователь удаляет инпут и добавляет заново с другим выбором.
- **Удаление инпута:** в правой панели (или в контекстном меню / иконке у строки в левой колонке) — кнопка **«Удалить инпут»** (доступна в т.ч. для недоступных инпутов). Перед удалением показывать подтверждение (например, «Удалить инпут „Текущий счёт“? Настройки полей будут потеряны.»). После подтверждения запись инпута удаляется из `config.inputs`, **id инпута удаляется из массива `inputOrder`**, обновлённые настройки сохраняются (по кнопке «Сохранить»); выбранным становится другой инпут (например, следующий в списке).
- **Порядок отображения инпутов:** в левой колонке инпуты отображаются в порядке, заданном пользователем. Порядок можно менять **перетаскиванием по вертикали** (drag-and-drop): пользователь тянет строку инпута вверх или вниз и отпускает в нужной позиции; новый порядок сохраняется в настройках (массив id инпутов, см. раздел 5). При первом добавлении инпутов порядок определяется порядком добавления; при загрузке настроек — по сохранённому массиву порядка.

### 3.6. Недоступные инпуты: пометить, не удалять

При **отсутствии связи с vMix** или при **отсутствии в текущем проекте vMix** инпута с нужным `title` (например, пользователь переключил проект vMix или переименовал титр) инпут в настройках приложения **не удаляется**. Его нужно помечать как **«недоступный в данный момент»** (например, визуально: серый цвет, иконка предупреждения, подпись «Инпут не найден в vMix» или «Нет связи с vMix»). При восстановлении связи или появлении инпута с таким title в vMix инпут снова становится доступным, настройки полей сохраняются.

**При выборе недоступного инпута** справа показывать список полей в режиме **«только просмотр»**: блоки полей отображаются из **кэша** (если список полей этого инпута уже был успешно загружен ранее), без возможности менять сопоставление и без запроса к API. Кэш списка полей по инпуту нужен и для быстродействия: при повторном выборе инпута можно показывать поля из кэша, обновляя по запросу или при успешном подключении. **Возможность удалить недоступный инпут** предусмотрена: кнопка «Удалить инпут» доступна и для недоступных инпутов (подтверждение, затем удаление из `config.inputs` и из `inputOrder`).

Этот функционал, по возможности, **уже реализован** в текущей коде. В рамках рефакторинга: при отправке данных в vMix пропускать недоступные инпуты, в UI — показывать их в списке с пометкой «недоступен», при выборе — поля в режиме только просмотр из кэша.

### 3.7. Компонент «Управление плашками vMix» на странице «Управление матчем»

На странице **«Управление матчем»** есть компонент **«Управление плашками vMix»** (кнопки показа/скрытия оверлеев и т.п.). В рамках рефакторинга:

- **Список инпутов** в этом компоненте — **тот же**, что отображается в левой колонке страницы «Настройки подключения к vMix»: те же инпуты из `config.inputs`, в том же **порядке** (массив `inputOrder`). То есть источник данных один — настройки vMix; на странице настроек пользователь добавляет/удаляет инпуты и задаёт порядок перетаскиванием, на странице управления матчем отображается тот же список в том же порядке для управления плашками.
- **Недоступные инпуты** в компоненте «Управление плашками vMix» подсвечиваются **так же, как и сейчас** (визуально помечены как недоступные, без изменения логики по сравнению с текущей реализацией).

Таким образом, левая колонка страницы «Настройки vMix» и список в компоненте «Управление плашками vMix» на странице «Управление матчем» используют одни и те же данные (инпуты из настроек, порядок `inputOrder`) и единообразно отображают недоступные инпуты.

---

## 4. Настройка полей инпута: список полей из API и сопоставление в раскрывающихся блоках

### 4.1. Текущее состояние

- Поля каждого инпута заданы статически в `vmix-input-configs.ts` и привязаны к ключам (teamA, scoreASet, …). Типы полей и идентификаторы vMix заданы в конфиге.

### 4.2. Целевая логика: все поля инпута сразу, раскрывающиеся блоки

При **добавлении нового инпута** и **выборе его в левой колонке** справа сразу отображается **полный список полей этого инпута**, полученный через vMix API (`vmix:getInputFields` по номеру/ключу выбранного инпута). Не требуется вручную добавлять каждое поле по кнопке «Добавить» — все поля инпута показываются сразу.

**Форма отображения списка полей:**

- Каждое поле vMix отображается в виде **раскрывающегося блока** (accordion / collapsible).
- **Заголовок блока** — имя поля в vMix (например, `Судья.Text`, `Name_Team1.Text`). В заголовке или рядом можно показывать индикатор: сопоставлено (например, иконка/метка) или не сопоставлено. Так сразу видно, что настроено, а что — нет.
- **Раскрытие блока** — по клику на заголовок или на кнопку «развернуть». Внутри блока отображаются опции сопоставления:
  - Для полей типа **text**: выпадающий список **«Данные приложения»** (справочник из vmix-data-map с человекопонятными названиями) **или** вариант **«Произвольный текст»** (галочка/переключатель) и текстовое поле для ввода фиксированной строки. При выборе источника или вводе кастомного текста сопоставление сохраняется в конфиг; **сохранение в файл настроек** выполняется при нажатии кнопки **«Сохранить»** внизу страницы (автосохранение при каждом действии не используется).
  - Для полей типа **color** / **image**: выпадающий список «Данные приложения» (только те пункты vmix-data-map, которые подходят по типу). При выборе сопоставление сохраняется.
- Пользователь раскрывает нужные блоки, задаёт сопоставление — без модальных окон и без пошагового «добавить поле». Быстрее и нагляднее: один экран со всеми полями инпута, в каждом блоке — опции сопоставления.

Типы полей vMix (text, color, image) определяются по тегу в XML. **Для полей типа text** допускается как сопоставление с данными приложения, так и **кастомный вариант** (см. раздел 4.4). В конфиге сохраняются только те поля, для которых задано сопоставление (`dataMapKey` или `customValue`). **Ключ записи в `fields`** — **имя поля vMix** (`vmixFieldName`): в vMix имена полей в рамках одного инпута уникальны, поэтому использовать их как ключ допустимо и упрощает сопоставление с блоком из API. При использовании имени поля vMix в качестве ключа (в т.ч. с точками и спецсимволами) нужно обеспечить корректную работу с кодировками и спецсимволами: в JSON ключи с точками допустимы (например, `"Name_Team1.Text"`); при передаче в URL (SelectedName и т.д.) имя кодировать (encodeURIComponent).

### 4.2.1. Редактирование и сброс сопоставления полей

- **Редактирование сопоставления:** внутри раскрытого блока пользователь меняет выбор в выпадающем списке «Данные приложения» или текст в «Произвольный текст»; изменения сохраняются в конфиг (в памяти); запись в файл настроек — при нажатии кнопки «Сохранить» внизу страницы.
- **Сброс сопоставления:** в блоке — кнопка **«Очистить»** или **«Удалить сопоставление»**. После подтверждения запись этого поля (ключ — имя поля vMix) удаляется из `fields` выбранного инпута; поле остаётся в списке блоков (из API), но снова помечается как «не сопоставлено». Удалять сам блок из списка не нужно — список полей всегда соответствует vMix API выбранного инпута.

### 4.3. Связь с vmix-data-map

- Документ `docs/development/vmix-data-map.md` задаёт полный перечень данных приложения (разделы 1–12 и др.). Нужно:
  - Сформировать на его основе **справочник пунктов для выпадающего списка** «Данные приложения» в виде **иерархического списка** (группы: «Турнир», «Команды», «Счёт», «Судьи» и т.д.) с человекопонятными названиями. Модель данных справочника разработать так, чтобы в будущем было удобно дополнять и модифицировать структуру.
  - Все пункты справочника должны иметь **человекопонятные названия** (для отображения в UI), при этом внутренне используется технический ключ (например, `teamA.name` → «Название команды A»).
  - **Фильтр по типу поля:** для полей типа **color** и **image** в блоке показывать только те пункты справочника, которые подходят по типу (цвета, изображения). Справочник при формировании списка опций фильтруется по типу поля (text / color / image).
  - В конфиге поля хранить выбранный ключ источника данных; в `useVMix` (или в main при подготовке данных) по этому ключу брать значение из `match` и подставлять в соответствующую команду vMix.

**Поля видимости в vMix:** это те же текстовые элементы, управляемые через **отдельный API видимости** (SetTextVisibleOn/SetTextVisibleOff). В справочнике «Данные приложения» для таких случаев — «виртуальные» пункты (например, «Индикатор подачи команды A/B»); при выборе такого пункта в логике отправки вызывается API видимости, а не SetText.

### 4.4. Кастомный текст для полей типа text

Для **полей типа text** предусматривается **кастомный вариант сопоставления**: вместо выбора источника данных из справочника пользователь может указать произвольный (фиксированный) текст, который будет всегда отправляться в данное поле инпута vMix. Это позволяет использовать один и тот же инпут vMix в разных ролях — например, один инпут «TITLES» и для судей, и для тренеров.

**Пример: инпут «Тренер А» на базе vMix-инпута TITLES**

1. Нажать **«Добавить инпут»**. В отображаемое имя указать «Тренер А». Выбрать из списка GT-инпутов vMix инпут **TITLES**. Включить инпут, выбрать номер оверлея 1. Сохранить инпут.
2. Выбрать инпут «Тренер А» в левой колонке. Справа отображается список всех полей инпута TITLES (из vMix API) в виде раскрывающихся блоков, например: «Судья.Text», «Должность.Text».
3. Раскрыть блок **«Судья.Text»**. В опциях сопоставления выбрать из выпадающего списка **«Имя тренера команды A»** (данные из матча). Сопоставление сохраняется.
4. Раскрыть блок **«Должность.Text»**. Включить вариант **«Произвольный текст»**, в появившемся текстовом поле вписать **«Тренер команды»**. Сопоставление сохраняется.
5. Сохранить настройки (если не используется автосохранение).

В результате при отображении «Тренер А» в vMix в поле «Судья.Text» будет подставляться имя тренера команды A из матча, а в поле «Должность.Text» — всегда строка «Тренер команды». Тот же инпут TITLES можно добавить ещё раз с именем «Первый судья» и в блоках сопоставить «Судья.Text» с именем первого судьи, «Должность.Text» — с кастомным текстом «Первый судья».

**Что нужно для реализации, сохранения и использования:**

- **UI в раскрывающемся блоке (text):** переключатель или галочка «Произвольный текст»; при включении скрывать/отключать выпадающий список «Данные приложения» и показывать текстовое поле для ввода строки. При выключении — наоборот.
- **Сохранение в настройках:** для поля типа text хранить либо `dataMapKey` (источник из vmix-data-map), либо `customValue` (строка). Взаимоисключающие варианты: при наличии `customValue` значение для отправки берётся из него, иначе — из `match` по `dataMapKey`.
- **Логика отправки в vMix:** при формировании значения для текстового поля: если у конфигурации поля задано `customValue`, использовать его; иначе получить значение из матча по `dataMapKey` (как в общем случае). Далее — вызов SetText с полученной строкой.
- **Отображение в заголовке блока:** для сопоставленного поля с кастомным значением показывать превью строки или метку «произвольный текст»; для поля с dataMapKey — человекопонятное название источника. Так видно, что сопоставлено и чем, без раскрытия блока.
- **Редактирование:** при раскрытии блока поля с уже заданным `customValue` подставлять галочку «Произвольный текст» и текстовое поле с сохранённой строкой; для поля с `dataMapKey` — выбранный пункт справочника.

---

## 5. Структура данных настроек (settings.json)

Предлагаемое расширение секции `vmix` в `settings.json`:

```json
{
  "vmix": {
    "host": "192.168.1.100",
    "port": 8088,
    "connectionState": "connected",
    "inputOrder": ["input_1", "input_2", "input_3"],
    "inputs": {
      "input_1": {
        "displayName": "Текущий счёт",
        "vmixTitle": "SCORE",
        "vmixKey": "90fbc558-6019-4b3d-95ad-a6df19f2eca3",
        "vmixNumber": "10",
        "enabled": true,
        "overlay": 1,
        "fields": {
          "Name_Team1.Text": {
            "enabled": true,
            "vmixFieldType": "text",
            "dataMapKey": "teamA.name"
          },
          "Score_Team1.Text": {
            "enabled": true,
            "vmixFieldType": "text",
            "dataMapKey": "currentSet.scoreA"
          },
          "Должность.Text": {
            "enabled": true,
            "vmixFieldType": "text",
            "customValue": "Тренер команды"
          }
        }
      }
    }
  }
}
```

- `connectionState`: `"connected"` | `"disconnected"` — для восстановления при запуске.
- **inputOrder** — массив id инпутов в порядке отображения в левой колонке. При отрисовке списка инпутов использовать этот порядок; при перетаскивании обновлять массив и сохранять в настройки.
- Ключи инпутов (`input_1`, …) — **стабильные уникальные идентификаторы** (рекомендуется uuid при создании инпута), чтобы ссылки на инпут не ломались при переименовании и т.п.
- **vmixTitle** — основной идентификатор для обращения к инпуту при отправке команд в vMix (поиск инпута по имени в vMix API). Обязательно сохраняется при добавлении инпута.
- **vmixKey**, **vmixNumber** — сохраняются при добавлении инпута для возможного будущего функционала; при отправке команд приложение обращается к инпуту по **vmixTitle**.
- **Сохранение настроек:** запись в файл настроек выполняется **только при нажатии кнопки «Сохранить»** внизу страницы «Настройки подключения к vMix». Кнопка «Отмена» закрывает страницу без сохранения (несохранённые изменения отменяются). **Исключение:** `connectionState` (и при необходимости host/port) сохраняются в файл **сразу** при нажатии «Подключить» или «Отключить», чтобы при следующем запуске приложения состояние подключения было корректным даже если пользователь не нажал «Сохранить».
- **При удалении инпута:** id инпута **удаляется из массива `inputOrder`**; обновлённые настройки сохраняются при следующем нажатии «Сохранить».
- `fields`: ключ записи — **имя поля vMix** (`vmixFieldName`), в vMix имена полей в рамках одного инпута уникальны. Значения: `vmixFieldType`, для текстовых полей — либо `dataMapKey` (ключ из vmix-data-map), либо **`customValue`** (произвольная строка); при отправке используется `customValue`, если он задан, иначе значение из матча по `dataMapKey`. Для полей color/image — только `dataMapKey`. При использовании имени поля с точками/спецсимволами в ключе JSON — без изменений; при передаче в URL (SelectedName) — кодировать (encodeURIComponent).

**Миграция старых данных не нужна.** Рефакторинг можно выполнять без обратной совместимости: после обновления настройки инпутов vMix будут пустыми, пользователь заново добавит инпуты и поля по новой схеме.

---

## 6. Этапы реализации (черновик)

1. **Подключение**
   - Добавить в настройки `connectionState`, логику «Подключить»/«Отключить» с сохранением в settings.
   - При загрузке приложения: восстановление host/port и при `connectionState === 'connected'` — автоматический запрос к API.
   - Показ сообщения об ошибке при неуспешном подключении.

2. **API Main Process**
   - В `vmix-client.ts`: метод получения GT-инпутов (парсинг XML, фильтр по `type="GT"`).
   - Метод получения полей инпута по номеру/ключу (парсинг дочерних элементов input).
   - **Кэш списка полей по инпуту:** после успешного запроса `getInputFields` для инпута сохранять результат в кэш (по vmixTitle или id инпута), чтобы при выборе недоступного инпута показывать поля в режиме только просмотр и повысить быстродействие при повторном выборе инпута.
   - IPC: `vmix:getGTInputs`, `vmix:getInputFields`.

3. **UI: блок «Настройка инпутов»**
   - Пустой список по умолчанию; кнопка «Добавить инпут»; модальное окно (название + выпадающий список GT-инпутов). При создании инпута присваивать **стабильный ключ** (uuid).
   - Сохранение нового инпута в конфиг и отображение в левой колонке **в порядке, заданном массивом inputOrder**.
   - Для выбранного инпута: включить/выключить, отображаемое имя, номер оверлея; кнопки **«Удалить инпут»** (с подтверждением) и при необходимости «Изменить» общих свойств (displayName, overlay).
   - **Недоступные инпуты:** если нет связи с vMix или инпут с данным vmixTitle не найден в текущем проекте vMix — помечать инпут как «недоступный в данный момент» (визуально: серый, иконка/подпись), **не удалять** из списка и из конфига (см. раздел 3.6).
   - **Изменение порядка инпутов:** список инпутов в левой колонке — с возможностью **перетаскивания по вертикали** (drag-and-drop); после перетаскивания обновлять `inputOrder` и сохранять в настройки.
   - **Компонент «Управление плашками vMix» на странице «Управление матчем»:** отображать тот же список инпутов, что и в левой колонке страницы «Настройки vMix», в том же порядке (`inputOrder`). Недоступные инпуты подсвечивать так же, как в текущей реализации (см. раздел 3.7).

4. **UI: поля инпута (раскрывающиеся блоки)**
   - При выборе инпута в левой колонке справа запрашивать список полей через `vmix:getInputFields` (или брать из кэша) и отображать **все поля** в виде **раскрывающихся блоков**. Для **недоступного инпута** — показывать поля из кэша в режиме **только просмотр** (без возможности менять сопоставление). Заголовок блока — имя поля vMix; индикатор в заголовке: сопоставлено / не сопоставлено.
   - Внутри раскрытого блока: для text — выпадающий список «Данные приложения» (иерархический) или «Произвольный текст» + текстовое поле; для color/image — выпадающий список «Данные приложения», отфильтрованный по типу поля. Кнопка «Очистить сопоставление» (с подтверждением) — удаляет запись поля из `config.inputs[inputId].fields` (ключ записи — имя поля vMix), блок остаётся в списке.
   - Сохранение сопоставления в конфиг (в памяти); запись в файл — по кнопке «Сохранить». В заголовке блока показывать превью: человекопонятное название источника или «произвольный текст» + превью строки.

5. **Логика отправки в vMix**
   - Адаптировать `useVMix` (и при необходимости main): при обновлении матча проходить по сохранённым инпутам и полям. **Обращение к инпуту:** в параметре `Input` передавать **vmixTitle** (URL-кодированный), без определения номера инпута (vMix API принимает Input по имени, см. раздел 3.4).
   - Для каждого поля: для **текстовых** полей — если задано `customValue`, использовать его, иначе брать значение из `match` по `dataMapKey`; для color/image — только `dataMapKey`. По `vmixFieldType` вызывать SetText/SetColor/SetImage; параметр `SelectedName` — имя поля vMix (ключ записи в `fields`), при необходимости кодировать для URL. Для полей видимости (индикаторы подачи и т.д.) — вызывать SetTextVisibleOn/SetTextVisibleOff.
   - Учесть типы text, fill/color, image и особые случаи (видимость, логотипы по URL и т.д.) в соответствии с vmix-data-map и текущей реализацией.

6. **Справочник данных приложения**
   - На основе vmix-data-map сформировать **иерархический** список (группы: «Турнир», «Команды», «Счёт», «Судьи» и т.д.) с человекопонятными названиями для выпадающего списка «Данные приложения»; модель данных разработать с расчётом на удобное дополнение и модификацию. В блоках полей типа color/image показывать только пункты справочника, подходящие по типу (фильтр по типу поля).

7. **Миграция старых настроек**
   - Не требуется. Рефакторинг без обратной совместимости: после обновления секция `vmix.inputs` пустая, старые настройки не переносятся.

8. **Тестирование и документация**
   - Проверка подключения, добавления инпутов/полей, сохранения и восстановления, отправки данных в vMix.
   - Проверка редактирования и удаления инпутов и полей (с подтверждением), изменения порядка инпутов перетаскиванием и сохранения `inputOrder`.
   - Проверка отображения списка полей в раскрывающихся блоках при выборе инпута и сопоставления в блоках (dataMapKey / customValue).
   - Проверка пометки инпутов как «недоступный в данный момент» при отсутствии связи с vMix или при отсутствии инпута с нужным title в текущем проекте vMix; инпуты при этом не удаляются из списка и из конфига; при выборе недоступного инпута — поля в режиме только просмотр из кэша; возможность удалить недоступный инпут.
   - Проверка кэша полей (повторный выбор инпута, отображение полей недоступного инпута из кэша).
   - Проверка сохранения только по кнопке «Сохранить» и отката при «Отмена»; при удалении инпута — удаление id из `inputOrder`.
   - Обновить документацию (vmix-settings-redesign-plan, vmix-api-reference, README в docs) после реализации.

---

## 7. Открытые вопросы и уточнения (все решены)

- **Идентификатор инпута в приложении:** решено — использовать **стабильный ключ** (uuid при создании инпута).
- **Порядок полей внутри инпута:** решено — порядок полей определяется **ответом vMix API**: все поля выбранного инпута отображаются в раскрывающихся блоках в том порядке, в каком они приходят из API. Отдельный массив порядка полей (аналог `inputOrder`) на первом этапе не вводим; при необходимости перетаскивание порядка полей можно добавить позже.
- **Отсутствие связи с vMix / инпут не найден в текущем проекте:** решено — инпут **помечать как недоступный в данный момент** (визуально: серый, иконка/подпись), **не удалять** из списка и из конфига. При восстановлении связи или появлении инпута с нужным title в vMix инпут снова становится доступным (см. раздел 3.6). Кэш списка GT-инпутов и полей для работы без связи — опционально на следующих итерациях.

---

## 8. Дополнительные вопросы и уточнения (все решены)

Ответы на вопросы из предыдущей версии раздела 8 зафиксированы и отражены в соответствующих разделах плана.

| Вопрос | Решение | Где отражено в плане |
|--------|---------|----------------------|
| **8.1** Кнопка «Отключить» | При нажатии «Отключить» явно сохранять в настройки `connectionState: "disconnected"`. | Раздел 1.2 (таблица, строка «Нажатие «Отключить»»). |
| **8.1** Индикатор на других страницах | Индикатор подключения к vMix оставить только там, где уже реализован (главная, управление матчем). Новые индикаторы не добавлять. | Раздел 1.2 (абзац «Индикатор подключения на других страницах»). |
| **8.2** Выбран недоступный инпут | Справа показывать список полей в режиме **только просмотр** из кэша. | Раздел 3.6, этап 4. |
| **8.2** Удаление недоступного инпута | Возможность удалить недоступный инпут предусмотрена (кнопка «Удалить инпут» доступна и для недоступных). | Раздел 3.6, раздел 3.5. |
| **8.2** Кэш полей | Предусмотреть кэш списка полей по инпуту: показ полей недоступного инпута из кэша, плюс быстродействие при повторном выборе. | Раздел 3.6, этап 2 (кэш), этап 4. |
| **8.3** Дублирование по title | Дублирование по title допускается: один и тот же GT-инпут можно добавить несколько раз с разными отображаемыми именами. | Раздел 3.2 (абзац «Дублирование по title допускается»). |
| **8.4** Ключ поля в fields | Использовать **имя поля vMix** (`vmixFieldName`) в качестве ключа записи в `fields`. В vMix имена полей в одном инпуте уникальны. Обеспечить корректную работу с кодировками и спецсимволами (в URL — encodeURIComponent). | Раздел 4.2, раздел 5 (структура и пояснения). |
| **8.5** Момент сохранения | Сохранение в файл — **только при нажатии кнопки «Сохранить»**. Кнопка «Отмена» отменяет несохранённые изменения. | Раздел 4.2 (сопоставление), раздел 5 (пояснения). |
| **8.5** inputOrder при удалении | При удалении инпута удалять его id из массива `inputOrder`. | Раздел 3.5, раздел 5, этапы 3 и 4. |
| **8.6** Структура справочника | **Иерархический** список (группы: «Турнир», «Команды», «Счёт», «Судьи» и т.д.); модель данных — с расчётом на удобное дополнение и модификацию. | Раздел 4.3, этап 6. |
| **8.6** Фильтр по типу поля | Для полей типа color/image показывать только подходящие по типу пункты справочника. | Раздел 4.3, этап 6. |
| **8.7** Поля видимости в vMix | Это те же текстовые элементы, управляемые через **отдельный API видимости** (SetTextVisibleOn/SetTextVisibleOff). В справочнике — «виртуальные» пункты; при выборе в логике отправки вызывается API видимости. | Раздел 4.3 (абзац «Поля видимости в vMix»). |
| **8.8** Обращение к инпуту при отправке | Номер инпута определять **не нужно**. vMix API принимает параметр **Input по имени (title)**. Передавать `Input=<vmixTitle в URL-кодировке>`. Пример: `Input=My%20input`. | Раздел 3.4, этап 5. |

---

**Инструкции для программистов:** подробная разбивка на этапы, TDD (Red–Green–Refactor) и пошаговые инструкции по реализации описаны в документе [Инструкции по реализации рефакторинга vMix](vmix-inputs-refactoring-implementation-guide.md).

*Документ подготовлен для планирования рефакторинга. После уточнения требований и добавления новых пунктов план можно расширить и разбить на подзадачи с привязкой к файлам и компонентам.*

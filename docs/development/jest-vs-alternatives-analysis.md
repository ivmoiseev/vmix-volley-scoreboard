# Анализ пригодности Jest для проекта и альтернативы

*Последнее обновление: 2026-01-21*

## Текущая ситуация

### Технологический стек проекта

- **Платформа**: Electron (main + renderer процессы)
- **Frontend**: React 18.3.1 + React Router 6.28.0
- **Языки**: TypeScript + JavaScript (смешанный код)
- **Модульная система**: ESM (`"type": "module"` в package.json)
- **Сборщик**: Vite 7.3.0
- **Тестирование**: Jest 29.7.0 + ts-jest + babel-jest

### Текущие проблемы с Jest

1. **ESM + TypeScript конфликты**
   - Jest требует экспериментальный флаг `--experimental-vm-modules`
   - Проблемы с разрешением модулей: `.js` расширения в импортах не находят `.ts` файлы
   - Сложная настройка `moduleNameMapper` для маппинга путей
   - `jest.unstable_mockModule()` для ESM модулей работает нестабильно

2. **Сложная конфигурация**
   - Необходимость настройки `ts-jest` с `useESM: true`
   - Настройка `extensionsToTreatAsEsm`
   - Проблемы с `moduleNameMapper` для разрешения путей
   - Устаревший API (`globals` для ts-jest)

3. **Производительность**
   - Медленный старт (особенно с TypeScript)
   - Полный перезапуск тестов при изменениях
   - Тяжелые трансформации через Babel/ts-jest

4. **Смешанный код (JS + TS)**
   - Разные настройки для `.js` и `.ts` файлов
   - Проблемы с мокированием TypeScript модулей из JavaScript тестов

## Оценка пригодности Jest

### ✅ Преимущества Jest для проекта

1. **Зрелость экосистемы**
   - Большое сообщество и документация
   - Множество плагинов и расширений
   - Хорошая поддержка React Testing Library
   - Много примеров и решений на StackOverflow

2. **Уже используется в проекте**
   - 46 тестовых файлов уже написаны
   - Настроена инфраструктура (coverage, CI/CD)
   - Команда знакома с API

3. **Функциональность**
   - Мощная система моков
   - Snapshot testing
   - Coverage reports
   - Хорошая интеграция с React Testing Library

### ❌ Недостатки Jest для проекта

1. **ESM поддержка экспериментальная**
   - Требует флаги и специальную настройку
   - Нестабильная работа с TypeScript ESM модулями
   - Проблемы с разрешением путей

2. **Сложная настройка для смешанного стека**
   - Electron (main + renderer)
   - TypeScript + JavaScript
   - ESM модули
   - Vite сборщик

3. **Производительность**
   - Медленный старт
   - Медленный watch mode
   - Полный перезапуск тестов

4. **Технический долг**
   - Устаревшие API (`globals` для ts-jest)
   - Экспериментальные функции (`unstable_mockModule`)
   - Сложная конфигурация

## Альтернативы

### 1. Vitest (Рекомендуется)

**Описание**: Современный тестовый фреймворк, построенный на Vite

**Преимущества для проекта**:
- ✅ **Нативная поддержка ESM** - работает из коробки без флагов
- ✅ **Отличная интеграция с Vite** - использует тот же конфиг и настройки
- ✅ **TypeScript из коробки** - не нужен ts-jest, работает напрямую
- ✅ **Быстрый** - 10-20x быстрее Jest в watch mode
- ✅ **Jest-совместимый API** - легкая миграция (`describe`, `it`, `expect`, `vi.mock` вместо `jest.mock`)
- ✅ **Поддержка React Testing Library** - полная совместимость
- ✅ **Простая настройка** - конфиг в `vite.config.ts`

**Недостатки**:
- ⚠️ Меньше зрелости (но быстро растет)
- ⚠️ Меньше плагинов (но основные есть)
- ⚠️ Может потребоваться миграция тестов (но API совместим)

**Оценка пригодности**: ⭐⭐⭐⭐⭐ (5/5)

**Пример конфигурации**:
```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './tests/setup.js',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
    },
  },
});
```

**Миграция**:
- Заменить `jest.mock` → `vi.mock`
- Заменить `jest.fn` → `vi.fn`
- Заменить `jest.spyOn` → `vi.spyOn`
- Импорты: `import { describe, it, expect, vi } from 'vitest'`
- Большинство тестов работают без изменений

---

### 2. Mocha + Chai + ts-node

**Описание**: Классический стек для тестирования

**Преимущества**:
- ✅ Зрелая экосистема
- ✅ Гибкость в выборе инструментов
- ✅ Хорошая поддержка TypeScript

**Недостатки**:
- ❌ Требует больше настройки
- ❌ Нет встроенной поддержки моков (нужен Sinon)
- ❌ Нет snapshot testing из коробки
- ❌ Медленнее чем Vitest
- ❌ Проблемы с ESM аналогичны Jest

**Оценка пригодности**: ⭐⭐⭐ (3/5)

---

### 3. Ava

**Описание**: Минималистичный тестовый раннер

**Преимущества**:
- ✅ Быстрый
- ✅ Нативная поддержка ESM
- ✅ Параллельное выполнение тестов

**Недостатки**:
- ❌ Меньше функций (нет snapshot из коробки)
- ❌ Меньше экосистемы
- ❌ Несовместим с Jest API
- ❌ Потребует полной переписи тестов

**Оценка пригодности**: ⭐⭐ (2/5)

---

### 4. Node.js Test Runner (встроенный)

**Описание**: Встроенный тестовый раннер Node.js (с версии 18+)

**Преимущества**:
- ✅ Не требует зависимостей
- ✅ Нативная поддержка ESM
- ✅ Официальная поддержка Node.js

**Недостатки**:
- ❌ Очень базовый функционал
- ❌ Нет моков из коробки
- ❌ Нет snapshot testing
- ❌ Нет coverage из коробки
- ❌ Несовместим с Jest API

**Оценка пригодности**: ⭐⭐ (2/5)

---

## Рекомендации

### Краткосрочное решение (остаться на Jest)

**Если**:
- Нет времени на миграцию
- Критически важна стабильность
- Команда не готова к изменениям

**Действия**:
1. Исправить текущую проблему с `moduleNameMapper`
2. Документировать все workaround'ы
3. Принять ограничения ESM поддержки

**Оценка**: ⭐⭐⭐ (3/5) - работает, но с проблемами

---

### Долгосрочное решение (миграция на Vitest)

**Рекомендуется**, потому что:
1. ✅ Проект уже использует Vite - естественная интеграция
2. ✅ Нативная поддержка ESM + TypeScript
3. ✅ Значительно быстрее
4. ✅ Проще настройка
5. ✅ Jest-совместимый API - легкая миграция
6. ✅ Лучшая поддержка современного стека

**План миграции**:
1. **Фаза 1: Установка и базовая настройка** (1-2 часа)
   - Установить `vitest` и `@vitest/ui`
   - Настроить `vite.config.ts`
   - Запустить один простой тест

2. **Фаза 2: Миграция тестов постепенно** (1-2 дня)
   - Мигрировать по одному файлу/папке
   - Заменить `jest.*` на `vi.*`
   - Обновить импорты
   - Проверить работу

3. **Фаза 3: Обновление CI/CD** (1-2 часа)
   - Обновить скрипты в `package.json`
   - Обновить конфигурацию CI/CD
   - Обновить coverage reports

4. **Фаза 4: Очистка** (1 час)
   - Удалить Jest зависимости
   - Удалить `jest.config.js`
   - Обновить документацию

**Оценка**: ⭐⭐⭐⭐⭐ (5/5) - оптимальное решение

---

## Сравнительная таблица

| Критерий | Jest | Vitest | Mocha | Ava |
|----------|------|--------|-------|-----|
| **ESM поддержка** | ⚠️ Экспериментальная | ✅ Нативная | ⚠️ Требует настройки | ✅ Нативная |
| **TypeScript** | ⚠️ Через ts-jest | ✅ Из коробки | ⚠️ Через ts-node | ⚠️ Через tsx |
| **Скорость** | ⚠️ Медленно | ✅ Очень быстро | ⚠️ Средне | ✅ Быстро |
| **Настройка** | ❌ Сложная | ✅ Простая | ⚠️ Средняя | ⚠️ Средняя |
| **Vite интеграция** | ❌ Нет | ✅ Отличная | ❌ Нет | ❌ Нет |
| **Jest API совместимость** | ✅ Нативный | ✅ Полная | ❌ Нет | ❌ Нет |
| **Экосистема** | ✅ Огромная | ⚠️ Растущая | ✅ Большая | ⚠️ Средняя |
| **React Testing Library** | ✅ Отлично | ✅ Отлично | ✅ Хорошо | ✅ Хорошо |
| **Snapshot testing** | ✅ Есть | ✅ Есть | ⚠️ Плагин | ⚠️ Плагин |
| **Coverage** | ✅ Встроенный | ✅ Встроенный | ⚠️ Плагин | ⚠️ Плагин |
| **Миграция из Jest** | - | ✅ Легкая | ❌ Сложная | ❌ Сложная |

---

## Выводы

### Текущая ситуация
Jest **работает**, но с **значительными проблемами**:
- Сложная настройка для ESM + TypeScript
- Экспериментальная поддержка ESM
- Медленная производительность
- Технический долг в конфигурации

### Рекомендация
**Миграция на Vitest** - оптимальное решение для проекта:
- ✅ Решает все текущие проблемы
- ✅ Лучшая интеграция с существующим стеком (Vite)
- ✅ Значительно быстрее
- ✅ Проще настройка
- ✅ Легкая миграция (Jest-совместимый API)

### Когда остаться на Jest
- Если миграция невозможна по срокам
- Если критически важна стабильность экосистемы
- Если есть специфические Jest плагины, без которых нельзя

---

## Следующие шаги

1. **Принять решение**: остаться на Jest или мигрировать на Vitest
2. **Если Jest**: исправить текущую проблему и документировать workaround'ы
3. **Если Vitest**: начать миграцию по плану выше

---

## Полезные ссылки

- [Vitest документация](https://vitest.dev/)
- [Vitest миграция с Jest](https://vitest.dev/guide/migration.html)
- [Jest ESM поддержка](https://jestjs.io/docs/ecmascript-modules)
- [Сравнение Vitest vs Jest](https://vitest.dev/guide/comparison.html)

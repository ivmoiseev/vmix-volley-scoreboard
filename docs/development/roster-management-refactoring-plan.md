# Рефакторинг страницы «Управление составами» — описание изменений

*Последнее обновление: 2026-02-12*

## Цель рефакторинга

Расширить страницу «Управление составами» (RosterManagementPage): добавить отображение и редактирование логотипов команд, цветов формы (основной состав и либеро) с сохранением единого источника правды (match) и без потери уже реализованного функционала. Логотипы и цвета должны участвовать в импорте/экспорте данных на этой странице вместе с составом и тренером.

---

## Исходное состояние (до рефакторинга)

### Страница «Управление составами» (RosterManagementPage)

- **Отображала:** переключатель команд A/B, список игроков (№, имя, позиция, стартовый), порядок стартового состава (drag-and-drop), тренер.
- **Экспорт (JSON):** `{ coach, roster }`.
- **Импорт:** ожидал объект с полями `roster` (массив) и `coach` (строка); применял миграцию позиций, обновлял `startingLineupOrder`.
- Кнопки выбора команды уже использовали `match.teamA.color` / `match.teamB.color` для подсветки, но сами цвета на странице не редактировались.

### Страница «Настройки матча» (MatchSettingsPage)

- Для каждой команды: название, цвет формы, цвет либеро, город, логотип (превью, загрузка/изменение, удаление).
- Логотипы: загрузка файла → resize 240px → `saveLogoToFile(teamLetter, base64)` → обновление `match.teamX.logo`, `logoBase64`, `logoPath`; удаление через `deleteLogo(teamLetter)`.
- Цвета хранились в `match.teamA/B.color` и `match.teamA/B.liberoColor`.

### Модель данных (Match / Team)

- `Team`: `name`, `color`, `liberoColor?`, `logo?`, `coach?`, `roster?`, `startingLineupOrder?`; в рантайме также `logoPath`, `logoBase64` (см. main/fileManager, logoManager).
- Все изменения на странице составов уже писались в `match` и синхронизировались с `setCurrentMatch` / `setMobileMatch` и при сохранении — с vMix через `updateMatchData(match, true)`.

---

## Внесённые изменения

### 1. Дизайн страницы «Управление составами»

- **Структура сверху вниз:**
  1. **Переключатель команд A / B** — без изменений.
  2. **Блок «Внешний вид команды»** (для выбранной команды):
     - **Название команды** — редактируемое поле (дублирование с «Настройки матча» для удобства).
     - **Город команды** — редактируемое поле в одну строку с названием.
     - Логотип: превью (как на настройках матча), кнопки «Загрузить/Изменить» и «Удалить».
     - Цвет формы игроков: цветовой пикер + текстовое поле (как на настройках матча).
     - Цвет формы либеро: цветовой пикер + текстовое поле (опционально, placeholder «Не указан»).
     - В одной строке с полями цветов — кнопка **«Поменять цвета»** (меняет местами цвет формы игроков и цвет формы либеро; компонент TeamColorsEditor).
     - В заголовке блока «Внешний вид команды» справа — кнопки **«Импорт»** и **«Экспорт»** (импорт/экспорт затрагивают все параметры команды: название, город, логотип, цвета, состав, тренер).
  3. **Состав команды** — таблица и кнопка «Добавить игрока». Кнопки «Импорт» и «Экспорт» перенесены в блок «Внешний вид команды» (см. ниже).
  4. Поле **Тренер** под таблицей — без изменений.
  5. **Стартовый состав** (сетка с drag-and-drop) — без изменений.
  6. Кнопки **Отменить** / **Сохранить и вернуться** — без изменений.

- Логотип и цвета выстроены в одну строку (flex); при смене команды (A/B) блок «Внешний вид команды» и таблица состава показывают данные выбранной команды. Редактирование названия, города, логотипа и цветов сразу обновляет `match` и синхронизируется с Electron; **обновление vMix выполняется только при нажатии «Сохранить и вернуться»**.

### 2. Логика логотипов на странице составов

- **Отображение:** как на MatchSettingsPage — превью из `match.teamA/teamB.logo` (или `logoBase64`), в зависимости от выбранной команды.
- **Загрузка:** выбор файла → `resizeImage(base64, 240)` → `saveLogoToFile('A'|'B', resizedBase64)` → обновление текущей команды в `match` (`logo`, `logoBase64`, `logoPath`) и вызов `setCurrentMatch` / `setMobileMatch`. vMix не обновляется при загрузке/удалении логотипа — только при нажатии «Сохранить и вернуться».
- **Удаление:** `deleteLogo('A'|'B')` → обнуление `logo`, `logoBase64`, `logoPath` у выбранной команды и синхронизация с Electron.
- Используется общий компонент **TeamLogoEditor** (см. раздел про общие компоненты).

### 3. Логика цветов на странице составов

- Два поля: «Цвет формы игроков» и «Цвет формы либеро». Источник данных: `match.teamA/teamB.color` и `match.teamA/teamB.liberoColor`. При изменении обновляется `match`, затем `onMatchChange(updatedMatch)`, `setCurrentMatch`, `setMobileMatch`. При сохранении страницы выполняется `updateMatchData(match, true)` — цвета в vMix обновляются. Реализовано через компонент **TeamColorsEditor**.

### 4. Импорт/экспорт на странице составов

- **Экспорт:** всегда только для **одной выбранной** команды (A или B). В JSON включены:
  - `name`, `city`, `coach`, `roster`, `startingLineupOrder`,
  - `color`, `liberoColor`,
  - при наличии логотипа — `logoBase64` (base64-строка; `logoPath` не включается).
  - Имя файла: `roster_${team.name}_${Date.now()}.json`.

- **Импорт:** один формат без обратной совместимости со старыми файлами. Ожидаемая структура:
  - **Обязательно:** `roster` (массив).
  - **Опционально:** `coach`, `name`, `city`, `color`, `liberoColor`, `logoBase64` (или `logo`).
  - При наличии `logoBase64`/`logo`: вызывается `saveLogoToFile(selectedTeam, value)` и в match подставляются возвращённые `logoPath`, `logoBase64`, `logo`.
  - При наличии `name`, `city`, `color`, `liberoColor` — значения применяются к выбранной команде.
  - Сообщение пользователю об успешном импорте с перечислением импортированных полей (состав, при наличии — тренер, название, город, цвета, логотип).

### 5. Синхронизация с vMix и сохранение

- Обновление vMix только при нажатии «Сохранить и вернуться». При сохранении вызываются `setCurrentMatch`, `setMobileMatch`, `onMatchChange`, затем при подключённом vMix — `resetImageFieldsCache()` и `updateMatchData(match, true)`. При загрузке/удалении логотипа на странице составов vMix не обновляется.

---

## Выполненные технические шаги

1. **Общие компоненты (без дублирования кода):**
   - **TeamLogoEditor** (`src/renderer/components/TeamLogoEditor.tsx`) — превью, кнопка «Загрузить/Изменить», «Удалить»; пропсы: `team`, `teamLetter`, `match`, `onMatchChange`. Используется на MatchSettingsPage и RosterManagementPage.
   - **TeamColorsEditor** (`src/renderer/components/TeamColorsEditor.tsx`) — два поля: цвет формы + цвет либеро (пикер + текст), кнопка «Поменять цвета» (обмен значений). Поддержка пустого значения («Не указан»): для `input type="color"` при пустом цвете используется отображаемый fallback `#ffffff`, чтобы не нарушать формат HTML5 и не вызывать предупреждений в консоли; текстовые поля с placeholder «Не указан». Используется на обеих страницах (Управление составами, Настройки матча).
   - Поле названия и поля города на RosterManagementPage — отдельные инпуты в блоке «Внешний вид команды».

2. **RosterManagementPage:** добавлен блок «Внешний вид команды» под переключателем A/B: название, город, `TeamLogoEditor`, `TeamColorsEditor`. Обновление `match` и синхронизация с родителем и Electron при любом изменении; vMix обновляется только при «Сохранить и вернуться» (в т.ч. `resetImageFieldsCache()` перед `updateMatchData`).

3. **Экспорт:** объект для выбранной команды: `name`, `city`, `coach`, `roster`, `startingLineupOrder`, `color`, `liberoColor`, при наличии — `logoBase64`. Имя файла: `roster_${team.name}_${Date.now()}.json`.

4. **Импорт:** один формат: обязательное поле `roster` (массив); опционально `coach`, `name`, `city`, `color`, `liberoColor`, `logoBase64`/`logo`. При наличии логотипа — `saveLogoToFile(selectedTeam, value)` и подстановка в match. Сообщение об успешном импорте с перечислением полей.

5. **Типы:** в `Match.ts` интерфейс `Team` расширен полями `logoPath?`, `logoBase64?`, `city?`.

6. **Тесты:** обновлены тесты в `tests/unit/renderer/RosterManagementPage.test.tsx` (экспорт с name, city, color, liberoColor, logoBase64; импорт с name, city, color, liberoColor; мок `resetImageFieldsCache`); селектор файлового инпута для импорта — `input[accept=".json"]`.

7. **Документация:** обновлено описание страницы «Управление составами» в `docs/getting-started/ui-structure.md`.

---

## Принятые решения (2026-02-12)

1. **Название команды:** на странице составов дублировать редактируемое поле «Название команды» в блоке «Внешний вид команды» для удобства.
2. **vMix:** обновлять только при нажатии «Сохранить и вернуться»; при загрузке/удалении логотипа на странице составов vMix не трогать.
3. **Экспорт:** всегда только для одной выбранной команды (A или B).
4. **Обратная совместимость импорта:** не требуется; один формат импорта: `roster` обязателен, остальные поля опциональны.
5. **Дублирование кода:** не допускать; блоки вынесены в переиспользуемые компоненты (`TeamLogoEditor`, `TeamColorsEditor`) и используются на обеих страницах.

# План: HTML-страницы оверлеев для vMix/OBS (Browser Source)

*Последнее обновление: 2026-02-06*

## 1. Цель

Использовать встроенный мобильный HTTP-сервер приложения для отдачи **только для чтения** HTML-страниц с прозрачным фоном в формате **1920×1080**. Эти страницы будут подключаться в vMix и OBS как **Browser Source** и отображать актуальные данные матча в реальном времени.

### Типы страниц

| Страница | Назначение | Основные данные |
|----------|------------|-----------------|
| **Scoreboard** | Счёт в прямом эфире | Команды, цвета формы, текущий счёт, счёт по партиям, подача, сетбол/матчбол (всплывающий блок) |
| **Intro (начальная)** | Титр перед матчем | Название турнира, команды с логотипами, время, место проведения, дата |
| **Rosters** | Составы команд | Игроки обеих команд (номер, имя, стартовый состав), названия и логотипы команд |

### Ограничения и допущения

- Страницы **только для чтения** — никаких форм и действий.
- **Постоянные URL** — не требуют авторизации и не содержат секретов; защита не нужна.
- Работают **только при включённом мобильном сервере** в настройках приложения (те же порт и хост).
- Данные берутся из текущего матча приложения и синхронизируются при каждом обновлении матча (уже реализовано через `mobile:set-match` и `server.currentMatch`).

---

## 2. Текущая архитектура (релевантные части)

- **Сервер:** `src/main/server.ts` — Express, порт из настроек (по умолчанию 3000), запускается только при `mobileSettings.enabled === true`.
- **Матч на сервере:** `mobileServer.setMatch(match)` вызывается из main при открытии/изменении матча; данные доступны как `server.currentMatch`.
- **Существующие маршруты:** `/panel/:sessionId` — мобильная панель (требует сессию); `/api/match/:sessionId` — API матча (требует сессию); `/logos/*` — статика логотипов.
- **Логотипы:** раздаются по `GET /logos/<filename>`, имена файлов хранятся в `teamA/teamB.logoPath` (например `logos/logo_a_<uuid>.png`).

Для оверлеев нужны маршруты **без sessionId**, только чтение данных.

---

## 3. Предлагаемая архитектура

### 3.1 API данных (read-only, без сессии)

- **GET `/api/overlay/match`**  
  Возвращает JSON текущего матча для оверлеев.  
  - Если матча нет — `200` и `null` или пустой объект (страницы сами обработают «нет данных»).  
  - Логотипы отдавать как **относительные URL** вида `/logos/<filename>`, чтобы на той же схеме/хосте/порте браузер их подгружал (как уже делается в мобильной панели).  
  - Не возвращать тяжёлые поля, не нужные для отображения (например, большие base64 логотипов), если они есть в матче — достаточно `logoPath`.

Этот endpoint доступен только когда сервер запущен (т.е. когда пользователь включил мобильный сервер).

### 3.2 Страницы оверлеев (фиксированные URL)

Все страницы — один размер viewport **1920×1080**, прозрачный фон (для наложения в vMix/OBS).

| URL | Описание |
|-----|----------|
| `GET /overlay/scoreboard` | HTML-страница «табло» (счёт, партии, подача, индикаторы). |
| `GET /overlay/intro` | HTML-страница «начальный титр» (турнир, команды, время, место, дата). |
| `GET /overlay/rosters` | HTML-страница «составы» (две команды, списки игроков). |

Реализация страниц — **вариант A:** сервер отдаёт **статичный HTML** (шаблон с пустым контейнером и встроенным скриптом). Скрипт при загрузке и по таймеру запрашивает `GET /api/overlay/match`, парсит JSON и рисует содержимое в DOM. Интервал опроса — например 500–1000 мс (для Browser Source обычно достаточно 1 с).

### 3.3 Размер и прозрачность

- В `<head>` задать viewport и фиксированный размер:
  - `<meta name="viewport" content="width=1920, height=1080">`
  - Контейнер (например `html, body`) с `width: 1920px; height: 1080px; overflow: hidden;`
- Прозрачный фон: `background: transparent` у `body` (и при необходимости у корневого контейнера).
- Для OBS/vMix Browser Source важно: в настройках источника указать размер 1920×1080 и при необходимости «Transparent background» (в vMix — опция браузера).

### 3.4 Логотипы на страницах

- В ответе `GET /api/overlay/match` для каждой команды передавать URL логотипа как путь относительно хоста, например: `"/logos/logo_a_abc123.png"`.
- На страницах использовать этот URL в `<img src="...">`. Базовый URL браузера будет тот же (хост и порт мобильного сервера), поэтому запросы уйдут на тот же сервер, где уже настроен `express.static` для `/logos`.

---

## 4. Дизайн оверлеев (1920×1080, прозрачный фон)

Ниже — целевое расположение блоков на каждой странице. Все размеры и отступы задаются в CSS (px или rem), шрифты — читаемые на Full HD (например, заголовки 48–72 px, основной текст 24–36 px). Цвета текста и фона блоков — на усмотрение реализации (контраст на прозрачном фоне).

### 4.0 Общие принципы

- Единый viewport 1920×1080, `overflow: hidden`, прозрачный `body`.
- Шрифты без засечек (например системный стек или Roboto), антиалиасинг.
- Без логотипов на scoreboard; цвета формы команд — полоски/плашки/подсветка рядом с названиями или под ними.

### 4.0.1 Scoreboard (табло)

Табло оформлено как **горизонтальный баннер**: одна панель с тёмным фоном (например тёмно-синий), тонкая светлая обводка; сверху — декоративная полоска (градиент или акцентный цвет). Остальная область 1920×1080 — прозрачная (для наложения в vMix/OBS). Слева направо:

```
┌──────────────────────────────────────────────────────────────────────────────────────┐ 1080
│  (прозрачная область)                                                                 │
│  ╔════╦══════════════════════════════════════════════════════════════════╦═══════════╗ │
│  ║    ║  ▓▓ декоративная полоска (градиент) по верху панели             ║           ║ │
│  ║ Л  ║─────────────────────────────────────────────────────────────────║  МАТЧБОЛ  ║ │
│  ║ о  ║  ВОЛЖАНОЧКА-ГРАСС  (team A)         [ 25 ]  [ 1 ]  ← очки  партии║  или     ║ │
│  ║ г  ║  БРЯНСК (team B)   ● [ 23 ]  [ 0 ]  ← ● подача у этой команды   ║  СЕТБОЛ   ║ │
│  ║ о  ║                                    (цвет формы — полоска/подсветка строки)   ║ (блок   ║ │
│  ║    ║─────────────────────────────────────────────────────────────────║ справа)   ║ │
│  ╚════╩══════════════════════════════════════════════════════════════════╩═══════════╝ │
│  (прозрачная область)                                                                 │
└──────────────────────────────────────────────────────────────────────────────────────┘
  ↑ опционально: узкая вертикальная панель (турнир/федерация — текст или лого)        1920
```

- **Слева (опционально):** узкая вертикальная панель — название турнира или логотип федерации/турнира (текст, например в стиле «ВФВ», или изображение). Если в приложении нет отдельного логотипа турнира — можно только текст `tournament` или оставить панель пустой/минимальной.
- **Центр — основная панель (две строки, одна под другой):**
  - **Верхняя строка:** название команды A (слева), цвет формы — тонкая полоска/подсветка строки (`teamA.color`). Справа в строке: **текущие очки** команды A (крупно, акцентный цвет, например золотистый/бежевый), затем **выигранные партии** (меньше).
  - **Нижняя строка:** название команды B (слева), цвет формы — полоска/подсветка. **Индикатор подачи** — небольшая светлая точка (●) слева от счёта той команды, которая подаёт (`servingTeam`). Далее те же два числа: очки в партии, выигранные партии.
- **Справа — отдельный блок:** небольшая плашка с тонкой светлой обводкой, внутри текст **«МАТЧБОЛ»** или **«СЕТБОЛ»**. Показывается только когда API возвращает `matchballTeam` или `setballTeam` (приоритет: матчбол над сетболом). Блок скрыт, если оба значения `null`.
- **Стиль:** тёмный фон панели, светлый текст названий команд, счёт — крупный и контрастный (акцентный цвет), без засечек. Логотипы команд на табло не показываем.

### 4.0.2 Intro (начальный титр)

```
┌──────────────────────────────────────────────────────────────────────────────────────┐ 1080
│                                                                                      │
│                    [Название турнира / tournament]                                   │
│                    [Подзаголовок — tournamentSubtitle, при наличии]                  │
│                                                                                      │
│                    [Место проведения — venue]  •  [Город/страна — location]          │
│                    [Дата — date]  •  [Время — time]  ([timezone])                    │
│                                                                                      │
│   ┌─────────────┐                                                    ┌─────────────┐
│   │   Лого A    │   [Название команды A]   vs   [Название команды B]   │   Лого B    │
│   │   (крупно)  │                                                    │   (крупно)  │
│   └─────────────┘                                                    └─────────────┘
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                                                                    1920
```

- **Верх:** турнир (и подзаголовок), место, дата и время в одну–две строки.
- **Центр:** два логотипа (крупно) и между ними названия команд с подписью «vs» (или аналог). Логотипы отображаются рядом с названиями команд.

### 4.0.3 Rosters (составы)

```
┌──────────────────────────────────────────────────────────────────────────────────────┐ 1080
│                                                                                      │
│   Команда A (логотип)    │    Команда B (логотип)                                    │
│   [лого] Название A      │    [лого] Название B                                      │
│   Тренер: ...            │    Тренер: ...                                            │
│   ─────────────────────  │    ─────────────────────                                 │
│   №   Имя                │    №   Имя                                                │
│   1   Иванов             │    1   Петров                                            │
│   5   Сидоров        *   │    7   Козлов         *                                  │
│   ...                    │    ...                                                    │
│   (* — стартовый состав)  │                                                           │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
                                                                                    1920
```

- Две колонки (или два блока): слева — команда A, справа — команда B.
- В шапке каждой колонки: **логотип и название команды рядом**, при желании тренер.
- Ниже — таблица/список: **номер, позиция (Поз.), имя**. Позиция отображается в международном формате (OH, MB, OPP, S, L) из `positionShort` в API. Стартовый состав выделен звёздочкой (*).

---

## 4.1. Текущая реализация (актуализировано 2026-02-06)

- **Scoreboard** (`public/overlay/scoreboard.html`): панель с градиентным фоном и светлой градиентной полоской сверху; счёт, партии, подача, плашки СЕТБОЛ/МАТЧБОЛ справа от панели.
- **Intro** (`public/overlay/intro.html`): синий прямоугольник по центру (как scoreboard), градиентная полоска сверху; турнир, подзаголовок, блок команд (логотипы слева/справа от названий, под названием — город), место проведения, дата/время (формат ДД.ММ.ГГГГ ЧЧ:ММ, без часового пояса). Фон страницы прозрачный.
- **Rosters** (`public/overlay/rosters.html`): синий прямоугольник по центру с градиентной полоской сверху; две симметричные колонки (команда, тренер, таблица № / Поз. / Имя). В API ростер содержит `positionShort` (OH, MB, OPP, S, L). Размеры пересчитаны без `transform: scale`, до 14 игроков влезают в 1080px; ширина колонок и блоков увеличена, неразрывный пробел перед * у стартовых. Города команд в intro; дата и время — форматированные (matchDate, date в API).

**API `GET /api/overlay/match`:** помимо полей из раздела 6 добавлены: `matchDate` (ДД.ММ.ГГГГ ЧЧ:ММ), `date` отдаётся в формате ДД.ММ.ГГГГ; в объектах команд — `city`; в элементах `roster[]` — `positionShort` (сокращение позиции).

---

## 5. Размещение ссылок на overlay в интерфейсе приложения

Ссылки на страницы оверлеев размещаются **на той же странице, что и управление мобильной версией** — страница **«Мобильный доступ»** (`MobileAccessPage`, маршрут вида `/mobile`).

- **Где именно:** отдельный блок **«Ссылки для vMix / OBS»** (или «Страницы для Browser Source») под или рядом с блоком «Уникальная ссылка для доступа» и QR-кодом.
- **Когда показывать:** блок виден **только при запущенном мобильном сервере** (когда отображаются адрес панели и QR-код). При остановленном сервере блок можно скрыть или показывать неактивным с подсказкой «Запустите сервер».
- **Содержимое блока:**
  - Краткая подпись: что это за ссылки (например: «Добавьте в vMix или OBS как Browser Source, размер 1920×1080, прозрачный фон»).
  - Три копируемые ссылки с подписями:
    - **Табло (счёт):** `http://<IP>:<порт>/overlay/scoreboard`
    - **Начальный титр:** `http://<IP>:<порт>/overlay/intro`
    - **Составы:** `http://<IP>:<порт>/overlay/rosters`
  - IP и порт подставляются из текущего состояния сервера (тот же, что в «Адрес сервера» на этой странице). Кнопка «Копировать» для каждой ссылки (или одна кнопка «Копировать все»).
- Отдельная страница или раздел настроек под overlay не заводим — всё в одном месте с мобильным доступом.

---

## 6. Данные по страницам

### 6.1 Scoreboard

- **Из матча:** `teamA.name`, `teamB.name`, **`teamA.color`**, **`teamB.color`** (цвета формы команд — отображаются на табло; логотипы на scoreboard не показываем, слишком мелко и неудобно), `currentSet.scoreA`, `currentSet.scoreB`, `currentSet.servingTeam`, `currentSet.setNumber`, `sets[]` (счёт по партиям).
- **Из API (вычисляется на сервере, логику не дублировать на клиенте):** в ответ `GET /api/overlay/match` добавить поля **`setballTeam`** (`'A' | 'B' | null`) и **`matchballTeam`** (`'A' | 'B' | null`). Сервер считает их по правилам (`volleyballRules`), страница только отображает.
- **Отображение сетбол/матчбол:** отдельным **всплывающим блоком** (overlay) поверх табло — например плашка «СЕТБОЛ» / «МАТЧБОЛ» с указанием команды, пока данные из API не null.

### 6.2 Intro

- **Из матча:** `tournament`, `tournamentSubtitle`, `venue`, `location`, `date`, `time`, `teamA.name`, `teamA.city`, `teamB.name`, `teamB.city`, **логотипы команд** (URL из `logoPath` через API). В API отдаётся также `matchDate` (ДД.ММ.ГГГГ ЧЧ:ММ) для отображения даты/времени одной строкой.
- **Отображение:** название турнира, подзаголовок; блок команд (логотипы слева/справа от названий, под названием — город); место проведения; дата и время (без часового пояса).

### 6.3 Rosters

- **Из матча:** `teamA.name`, `teamB.name`, **логотипы команд** (URL через API), `teamA.roster[]`, `teamB.roster[]` (номер, имя, `positionShort` — OH/MB/OPP/S/L, стартовый состав), `teamA.coach`, `teamB.coach`.
- **Отображение:** две колонки или два блока (команда A / команда B); у каждого блока — **название команды и логотип рядом**; ниже — таблица (№, Поз., Имя), выделение стартового состава звёздочкой.

---

## 7. Этапы внедрения

### Этап 1: API для оверлеев

- В `server.ts` (или отдельном модуле маршрутов) добавить **GET `/api/overlay/match`**.
  - Handler читает `this.currentMatch`.
  - Формирует «лёгкий» объект для оверлеев: все нужные поля матча без тяжёлых данных; для логотипов подставлять относительные URL вида `/logos/<filename>` из `logoPath`; включать **`teamA.color`**, **`teamB.color`**.
  - **Вычислять на сервере** по правилам (`volleyballRules`) и добавлять в ответ поля **`setballTeam`** и **`matchballTeam`** (`'A' | 'B' | null`), чтобы страница scoreboard не дублировала логику.
  - Если матча нет — возвращать `200` и `null` или `{}`.
  - CORS уже открыт для всех (`*`) на этом сервере — отдельно не трогать, если не потребуется ужесточение.

### Этап 2: Базовый HTML и маршруты страниц

- Добавить маршруты:
  - `GET /overlay/scoreboard`
  - `GET /overlay/intro`
  - `GET /overlay/rosters`
- Каждый маршрут отдаёт HTML с:
  - viewport 1920×1080, прозрачный фон;
  - контейнер под контент;
  - встроенный скрипт: запрос `GET /api/overlay/match`, разбор JSON, отрисовка в DOM (без использования пользовательского ввода в разметку — только безопасное отображение текста, см. XSS ниже).
- Шаблоны можно хранить в `server.ts` как строки/шаблоны или вынести в отдельные файлы (например в `src/main/overlay/` или ресурсы).

### Этап 3: Контент и вёрстка по страницам

- **Scoreboard:** разметка и стили под 1920×1080 — названия команд, **цвета формы** (без логотипов), счёт, партии, подача; **всплывающий блок** для отображения сетбол/матчбол по полям `setballTeam` и `matchballTeam` из API.
- **Intro:** разметка и стили — турнир, место, дата/время; **названия команд с логотипами рядом**.
- **Rosters:** разметка и стили — **названия и логотипы команд** в шапке каждого блока; списки игроков (номер, имя, стартовый состав), при желании тренеры. Позиции не отображаем.

### Этап 4: Документация и подсказки в UI

- Краткое описание в пользовательской документации: для чего нужны overlay-страницы, что такое Browser Source, примеры URL (см. раздел 5 — размещение на странице «Мобильный доступ»).
- На странице **«Мобильный доступ»** вывести блок **«Ссылки для vMix/OBS»** (раздел 5): три копируемые ссылки, подсказка про 1920×1080 и прозрачный фон; блок виден только при запущенном сервере.

### Этап 5 (опционально): настройки оверлеев

- При необходимости позже: настройки только для отображения (например, размер шрифта, тема светлая/тёмная) через query-параметры или отдельный мини-конфиг в настройках приложения — в рамках этого плана не обязательно.

---

## 8. Безопасность (XSS)

- Данные матча (названия команд, турнир, имена игроков и т.д.) приходят с сервера и вставляются в DOM на страницах оверлеев. Необходимо **не** использовать `innerHTML` с сырыми строками; использовать `textContent` или безопасное создание узлов. В проекте уже есть `domUtils` (санитизация) для мобильной панели — те же принципы применить и здесь (на сервере при генерации HTML не вставлять пользовательские данные в разметку; на клиенте при отрисовке из JSON — только безопасные методы вывода текста).

---

## 9. Тестирование

- Юнит: handler `GET /api/overlay/match` — при `currentMatch === null` возвращает 200 и пустой/null объект; при переданном матче — JSON с ожидаемыми полями (в т.ч. `teamA.color`, `teamB.color`, `setballTeam`, `matchballTeam`) и относительными URL логотипов.
- Ручная проверка: включить мобильный сервер, открыть в браузере `/overlay/scoreboard`, `/overlay/intro`, `/overlay/rosters`, проверить размер 1920×1080 и прозрачность; проверить обновление данных при изменении матча в приложении.
- Проверка в vMix/OBS: добавить Browser Source с URL `http://<IP>:<порт>/overlay/scoreboard`, размер 1920×1080, при необходимости включить прозрачность.

---

## 10. Зависимости

- Нет новых npm-зависимостей: только Express и текущая логика сервера.
- Страницы работают только при включённом мобильном сервере — дополнительная настройка не нужна.
- При выключении сервера все overlay-URL становятся недоступны (ожидаемое поведение).

---

## 11. Итоговый чек-лист

- [x] Реализован `GET /api/overlay/match` с лёгким JSON, URL логотипов, цветами команд, полями `setballTeam`/`matchballTeam`, `matchDate`, `date` (ДД.ММ.ГГГГ), `city` в командах, `positionShort` в ростре.
- [x] Реализованы `GET /overlay/scoreboard`, `GET /overlay/intro`, `GET /overlay/rosters` с HTML 1920×1080 и прозрачным фоном; intro и rosters — центрированный синий блок с градиентной полоской; rosters — колонка Поз. (OH/MB/OPP/S/L).
- [x] На всех страницах данные подставляются безопасно (без XSS).
- [x] На странице «Мобильный доступ» отображается блок «Ссылки для vMix/OBS» с копируемыми ссылками (только при запущенном сервере) — см. раздел 5.
- [x] Обновлена документация (overlay-pages-browser-source-plan, vmix-data-map, CHANGELOG).

После выполнения плана можно доработать дизайн (шрифты, цвета, расположение блоков) без изменения архитектуры.

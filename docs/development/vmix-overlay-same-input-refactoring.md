# Плашки vMix при нескольких конфигурациях на один инпут — сделанные изменения

*Последнее обновление: 2026-02-12*

## Суть проблемы и решения

На странице «Настройки подключения к vMix» допускается создавать несколько инпутов приложения, сопоставленных с **одним и тем же** инпутом в vMix (например, «Первый судья» и «Второй судья» → оба на TITLES). Раньше при этом возникали две проблемы:

1. **Идентификация активной плашки**: при опросе vMix API подсвечивались обе кнопки, так как по ответу API нельзя было различить, какой из двух конфиг-инпутов в эфире.
2. **Данные при выводе в эфир**: поля инпута в vMix обновлялись только при изменении матча/настроек; при нажатии «Показать плашку» данные не обновлялись, и в эфире могли оставаться данные другого сопоставления.

В результате рефакторинга:

- При нескольких конфиг-инпутах на один vMix-инпут и один оверлей **подсвечивается только одна кнопка** — та, которую последний раз показали из приложения, либо при внешней активации в vMix первая по порядку в `inputOrder`.
- При нажатии «Показать плашку» **сначала обновляются поля этого инпута в vMix** (по текущему матчу и сопоставлению), затем выполняется показ; в эфире отображаются корректные данные выбранной плашки.

---

## Внесённые изменения

### Файл `src/renderer/hooks/useVMix.ts`

**1. Ref «последний показанный по оверлею»**

- Добавлен ref `lastShownInputKeyByOverlay: Record<number, string>` — для каждого номера оверлея (1–8) хранится inputKey последнего успешного вызова `showOverlay`.
- В `showOverlay` после успешного `showVMixOverlay(inputKey)` записывается номер оверлея из конфига инпута и выполняется `lastShownInputKeyByOverlay.current[overlay] = inputKey`.
- При смене конфига инпутов (в `loadConfig` при `configChanged`), при успешном переподключении (в `checkConnection`) и при смене/сбросе матча (в `updateMatchData`) ref очищается. При `hideOverlay` запись для оверлея **не** очищается (по принятому решению).

**2. Вспомогательная функция для списка «конкурирующих» инпутов**

- Добавлена функция `getInputKeysForOverlayAndVmixInput(config, inputsMap, overlayNumber, overlayInputValue)`: возвращает массив inputKey из конфига, у которых заданы этот оверлей и этот vMix-инпут (сравнение по номеру через inputsMap), в порядке `inputOrder`.

**3. Логика идентификации активной плашки**

- В **updateOverlayStates**: после определения «оверлей активен и vMix-инпут совпадает с данным inputKey» вызывается `getInputKeysForOverlayAndVmixInput`. Если для этого оверлея и vMix-инпута найдено больше одного конфиг-инпута, активным считается только тот, у которого `inputKey === lastShownInputKeyByOverlay.current[overlay]`, а если запись отсутствует — первый элемент списка (первая по порядку в `inputOrder`). Остальным inputKey активная кнопка сбрасывается.
- В **isOverlayActive**: после того как по номеру/идентификатору установлено совпадение инпута в оверлее с конфигом, применяется та же проверка по списку конкурирующих инпутов и `lastShownInputKeyByOverlay` (или первому по порядку).

**4. Обновление данных перед показом**

- Добавлен ref `matchRef`, синхронизируемый с аргументом хука `_match`, чтобы при вызове `showOverlay` иметь доступ к текущему матчу без передачи его аргументом.
- Из логики `updateDynamicInputs` выделена функция **updateSingleDynamicInput(inputId, matchData, forceUpdate)** — обновление одного инпута (поля, цвета, видимость, изображения, вызов `updateVMixInputFields` и при успехе обновление `lastSentValuesRef`). `updateDynamicInputs` переведён на цикл вызовов `updateSingleDynamicInput`.
- В **showOverlay** перед вызовом `showVMixOverlay(inputKey)` при наличии `matchRef.current` выполняется `await updateSingleDynamicInput(inputKey, matchRef.current, true)`. Ошибка обновления логируется; показ оверлея выполняется в любом случае.

**5. Блокировка остальных кнопок при одной плашке в эфире (тот же vMix-инпут)**

- Добавлена и экспортирована функция **isAnotherOverlayOnAirForSameInput(inputKey)**: возвращает `true`, если для данного `inputKey` есть другая плашка из той же группы (тот же оверлей и тот же vMix-инпут), которая сейчас в эфире. Используется для отключения кнопки «Показать», пока в эфире другая плашка на тот же инпут.
- Логика: по `inputKey` берётся оверлей и текущее значение инпута в оверлее из `overlayStates`; вызывается `getInputKeysForOverlayAndVmixInput` — получаем список конфиг-инпутов на этот vMix-инпут. **Блокируются только кнопки, входящие в этот список** (т.е. ссылающиеся на тот же vMix-инпут): если `inputKey` не в `competingKeys`, возвращается `false`. Если в списке больше одного и для какого-то другого ключа `isOverlayActive(k, null) === true`, возвращается `true`.

### Файлы `src/renderer/components/VMixOverlayButtons.tsx` и `src/renderer/pages/MatchControlPage.tsx`

- В **VMixOverlayButtons** добавлен опциональный проп **isAnotherOverlayOnAirForSameInput?: (inputKey: string) => boolean**. Кнопка делается недоступной, если `!isVMixConnected || !isInputEnabled || (anotherOnAir && !active)`; при блокировке из‑за «другая плашка в эфире» подсказка: «Другая плашка этого инпута в эфире».
- **MatchControlPage** передаёт в VMixOverlayButtons функцию `isAnotherOverlayOnAirForSameInput` из хука useVMix.

---

## Тесты

Добавлен файл **`tests/unit/renderer/useVMix-overlay-same-input.test.ts`** с тестами:

- Два конфиг-инпута на один vMix-инпут: активна только последняя показанная кнопка (ref1, затем ref2).
- Скрытие оверлея: после перехода в неактивное состояние ни одна кнопка не считается активной.
- Внешняя активация (плашка выведена в vMix вручную): подсвечивается первая по порядку в `inputOrder`.
- **isAnotherOverlayOnAirForSameInput**: когда ref1 в эфире — для ref2 возвращается `true`, для ref1 `false`; когда оверлей неактивен — оба `false`. Отдельный кейс: при трёх плашках (ref1, ref2 → инпут 13, other → инпут 14) и ref1 в эфире для `other` возвращается `false` — блокируются только кнопки того же vMix-инпута.
- Перед `showVMixOverlay` вызывается `updateVMixInputFields` с данными матча; порядок вызовов — сначала обновление полей, затем показ.
- Два инпута на один vMix: при показе каждого в `updateVMixInputFields` уходят свои данные (ref1 и ref2 с разными полями/данными).
- В **VMixOverlayButtons.test.tsx**: кнопка недоступна и с подсказкой «Другая плашка этого инпута в эфире», когда передан мок `isAnotherOverlayOnAirForSameInput`, возвращающий true для второго инпута.

---

## Принятые решения

1. **Внешняя активация**: при ручном выводе плашки в vMix и двух конфиг-инпутах на этот же инпут и оверлей подсвечивается **первая по порядку** в `inputOrder`.
2. **Обновление данных**: выполняется при **каждом** `showOverlay`, в том числе при переключении с одной плашки на другую (тот же vMix-инпут).
3. **Сброс lastShown при hideOverlay**: запись **не очищается**; при необходимости можно пересмотреть по результатам использования.
4. **Матч для обновления перед показом**: используется матч из хука (`matchRef`); передавать матч в `showOverlay` не требуется.
5. **Блокировка кнопок**: недоступными делаются **только** кнопки, ссылающиеся на тот же vMix-инпут, что и плашка в эфире; кнопки плашек на другие инпуты остаются доступными.

---

## Обоснование выбора решения (кратко)

- **Идентификация**: vMix API возвращает только номер оверлея и номер инпута; какой из наших конфиг-инпутов «реально» показан, из API не следует. Хранение lastShown по оверлею и эвристика «первая по порядку» при внешней активации дают минимальный объём состояния и максимально достижимую точность при ограничениях API.
- **Обновление при показе**: один целевой запрос `updateVMixInputFields` на нажатие «Показать плашку» гарантирует корректные данные в эфире; обновление всех инпутов при показе избыточно и не решает однозначность при нескольких конфигах на один vMix-инпут.

Подробное сравнение вариантов по объёму информации, скорости и точности см. в истории документа (раздел «Анализ альтернатив и оптимальность»).

---

## Ссылки на код и тесты

- Хук vMix: `src/renderer/hooks/useVMix.ts`
- Тесты: `tests/unit/renderer/useVMix-overlay-same-input.test.ts`, `tests/unit/renderer/useVMix-dynamic-inputs.test.ts`
- Настройки инпутов: `src/renderer/pages/VMixSettingsPage.tsx`
- Компонент кнопок плашек: `src/renderer/components/VMixOverlayButtons.tsx`
- Main: `src/main/main.ts` (vmix:show-overlay, vmix:hide-overlay, vmix:get-overlay-state)
- Клиент vMix: `src/main/vmix-client.ts`
- Карта данных для vMix: `docs/development/vmix-data-map.md`

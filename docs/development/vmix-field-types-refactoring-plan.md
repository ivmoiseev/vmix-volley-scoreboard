# План рефакторинга типов полей vMix

## Цель рефакторинга

Упростить классификацию типов полей и автоматизировать добавление суффиксов к именам полей в vMix.

## Текущая ситуация

### Текущие типы полей:
- `text` - текстовое поле
- `color` - поле цвета
- `visibility` - поле видимости
- `image` - поле изображения

### Проблемы:
1. В vMix нет типа "Цвет" - есть тип "Fill", у которого есть свойство Color
2. "Видимость" - это не отдельный тип, а атрибут любого текстового поля
3. Пользователь должен вручную добавлять суффиксы к именам полей:
   - `.Text` для текстовых полей
   - `.Source` для изображений
   - `.Fill.Color` для филлов

## Новая структура

### Новые типы полей:
- `text` - текстовое поле (суффикс `.Text`)
- `fill` - поле филла (суффикс `.Fill.Color`)
- `image` - поле изображения (суффикс `.Source`)

### Новые свойства полей:
- `visible` - булево свойство для управления видимостью (доступно для всех типов)
- `fieldIdentifier` - базовое имя поля (без суффикса)
- Автоматическое добавление суффиксов при отправке в vMix

## План реализации (TDD подход)

### Этап 1: Подготовка тестов

#### 1.1 Тесты для утилиты преобразования имен полей
**Файл:** `tests/unit/shared/vmix-field-utils.test.js` (новый)

Тесты должны проверить:
- Добавление суффикса `.Text` для типа `text`
- Добавление суффикса `.Source` для типа `image`
- Добавление суффикса `.Fill.Color` для типа `fill`
- Обработка полей, у которых уже есть суффикс (не добавлять повторно)
- Обработка пустых/невалидных значений

#### 1.2 Тесты для миграции конфигураций
**Файл:** `tests/unit/main/vmix-field-migration.test.js` (новый)

Тесты должны проверить:
- Миграция полей типа `color` → `fill`
- Миграция полей типа `visibility` → `text` с `visible: true`
- Сохранение существующих `fieldIdentifier` (удаление суффиксов, если они есть)
- Миграция конфигураций по умолчанию в `vmix-input-configs.js`

#### 1.3 Тесты для обработки полей в useVMix
**Файл:** `tests/unit/renderer/useVMix-field-types.test.js` (новый)

Тесты должны проверить:
- Правильное формирование имен полей с суффиксами
- Обработка полей типа `fill` вместо `color`
- Обработка видимости как атрибута, а не типа
- Совместимость с существующими данными матча

### Этап 2: Создание утилит

#### 2.1 Утилита для работы с именами полей
**Файл:** `src/shared/vmix-field-utils.js` (новый)

Функции:
- `getFullFieldName(fieldIdentifier, type)` - возвращает полное имя поля с суффиксом
- `removeFieldSuffix(fieldIdentifier)` - удаляет суффикс из имени поля (для миграции)
- `hasFieldSuffix(fieldIdentifier, type)` - проверяет наличие суффикса

#### 2.2 Константы типов полей
**Файл:** Обновить `src/renderer/hooks/useVMix.js`

```javascript
const FIELD_TYPES = {
  TEXT: "text",
  FILL: "fill",  // было COLOR
  IMAGE: "image",
  // VISIBILITY удален
};
```

### Этап 3: Обновление конфигураций по умолчанию

#### 3.1 Обновление vmix-input-configs.js
- Заменить `type: 'color'` на `type: 'fill'`
- Заменить `type: 'visibility'` на `type: 'text'` с добавлением логики видимости
- Обновить `fieldIdentifier` - убрать суффиксы (если они есть)
- Для полей видимости (pointA, pointB) добавить специальную обработку

Пример миграции:
```javascript
// Было:
pointA: { enabled: true, type: 'visibility', fieldIdentifier: 'PointA' }
colorA: { enabled: true, type: 'color', fieldIdentifier: 'ColorA' }

// Станет:
pointA: { enabled: true, type: 'text', fieldIdentifier: 'PointA', visible: true }
colorA: { enabled: true, type: 'fill', fieldIdentifier: 'ColorA' }
```

### Этап 4: Обновление UI (VMixSettingsPage.jsx)

#### 4.1 Обновление отображения типов
- Убрать тип "Цвет" и "Видимость"
- Добавить тип "Филл" (или "Заливка")
- Обновить цветовую схему для типов

#### 4.2 Добавление чекбокса видимости
- Добавить чекбокс "Управлять видимостью" для каждого поля
- Показывать чекбокс для всех типов полей
- Сохранять значение в `field.visible`

#### 4.3 Автоматическое добавление суффиксов
- В поле "Имя поля для vMix" показывать базовое имя (без суффикса)
- Добавлять подсказку о том, что суффикс будет добавлен автоматически
- Показывать превью полного имени поля

### Этап 5: Обновление логики обработки полей

#### 5.1 Обновление useVMix.js
- Заменить проверки `FIELD_TYPES.COLOR` на `FIELD_TYPES.FILL`
- Убрать обработку `FIELD_TYPES.VISIBILITY` как отдельного типа
- Добавить обработку свойства `visible` для всех типов полей
- Использовать `getFullFieldName()` при формировании запросов к vMix

#### 5.2 Обновление vmix-client.js
- Обновить комментарии и документацию
- Убедиться, что методы `setColor` работают с полными именами полей (с `.Fill.Color`)

### Этап 6: Миграция существующих данных

#### 6.1 Функция миграции в settingsManager.js
- Добавить функцию миграции конфигураций
- Автоматически вызывать при загрузке старых конфигураций
- Сохранять обратную совместимость

Логика миграции:
1. Для полей с `type: 'color'`:
   - Изменить на `type: 'fill'`
   - Если `fieldIdentifier` заканчивается на `.Fill.Color`, убрать суффикс
   - Если заканчивается на `.Color`, заменить на базовое имя

2. Для полей с `type: 'visibility'`:
   - Изменить на `type: 'text'`
   - Добавить `visible: true`
   - Если `fieldIdentifier` заканчивается на `.Text`, убрать суффикс

3. Для всех полей:
   - Убрать суффиксы из `fieldIdentifier` если они есть
   - Сохранить остальные свойства

### Этап 7: Тестирование и проверка

#### 7.1 Запуск всех тестов
- Убедиться, что все новые тесты проходят
- Проверить, что существующие тесты не сломались

#### 7.2 Ручное тестирование
- Проверить работу UI на странице настроек
- Проверить отправку данных в vMix
- Проверить миграцию существующих конфигураций

## Порядок выполнения

1. ✅ **Этап 1**: Написать все тесты (они должны падать)
2. ✅ **Этап 2**: Создать утилиты для работы с полями
3. ✅ **Этап 3**: Обновить конфигурации по умолчанию
4. ✅ **Этап 4**: Обновить UI
5. ✅ **Этап 5**: Обновить логику обработки
6. ✅ **Этап 6**: Добавить миграцию данных
7. ✅ **Этап 7**: Запустить тесты и проверить работу

## Обратная совместимость

- Старые конфигурации должны автоматически мигрироваться
- Если в `fieldIdentifier` уже есть суффикс, он будет удален
- Поля типа `visibility` будут работать как текстовые поля с видимостью

## Риски и меры предосторожности

1. **Потеря данных при миграции**: 
   - Создать резервные копии перед миграцией
   - Добавить логирование процесса миграции

2. **Некорректные имена полей**:
   - Валидация имен полей
   - Предупреждения при обнаружении суффиксов в базовом имени

3. **Совместимость с vMix API**:
   - Проверить документацию vMix API
   - Убедиться, что суффиксы корректны

## Дополнительные улучшения (опционально)

1. Валидация имен полей в UI
2. Автодополнение имен полей
3. Предпросмотр полного имени поля
4. Группировка полей по типам в UI

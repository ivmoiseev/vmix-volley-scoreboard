# План рефакторинга: Состояния партий и тайминг

## Обзор изменений

Добавление функционала управления состояниями партий, автоматической фиксации времени начала/завершения партий, отображения продолжительности и возможности коррекции данных через модальное окно.

## 1. Терминология состояний партий

### Предлагаемые названия состояний:

**В коде (английские константы):**
- `SET_STATUS_PENDING` - партия еще не началась
- `SET_STATUS_IN_PROGRESS` - партия идет
- `SET_STATUS_COMPLETED` - партия завершена

**В интерфейсе (русский):**
- "Не начата" / "Ожидает" - для партий, которые еще не начались
- "В игре" / "Идет" - для текущей активной партии
- "Завершена" - для завершенных партий

**Альтернативные варианты (более спортивные термины):**
- `SET_STATUS_SCHEDULED` / "Запланирована"
- `SET_STATUS_ACTIVE` / "Активна"
- `SET_STATUS_FINISHED` / "Завершена"

**Рекомендация:** Использовать `PENDING`, `IN_PROGRESS`, `COMPLETED` как наиболее универсальные и понятные термины.

## 2. Изменения в структуре данных

### 2.1. Обновление типов (`src/shared/types/Match.ts`)

**Изменения в интерфейсе `Set`:**
```typescript
export interface Set {
  setNumber: number;
  scoreA: number;
  scoreB: number;
  completed: boolean; // Оставить для обратной совместимости, но добавить status
  status?: 'pending' | 'in_progress' | 'completed'; // Новое поле
  startTime?: number; // Timestamp начала партии
  endTime?: number; // Timestamp завершения партии
  duration?: number; // Продолжительность в минутах (вычисляемое)
}
```

**Изменения в интерфейсе `CurrentSet`:**
```typescript
export interface CurrentSet {
  setNumber: number;
  scoreA: number;
  scoreB: number;
  servingTeam: 'A' | 'B';
  status?: 'pending' | 'in_progress'; // Статус текущей партии
  startTime?: number; // Timestamp начала текущей партии
}
```

**Константы состояний:**
```typescript
export const SET_STATUS = {
  PENDING: 'pending',
  IN_PROGRESS: 'in_progress',
  COMPLETED: 'completed',
} as const;

export type SetStatus = typeof SET_STATUS[keyof typeof SET_STATUS];
```

### 2.2. Миграция существующих данных

- При загрузке старых матчей:
  - Если `set.completed === true` → `status = 'completed'`
  - Если `set.completed === false` или отсутствует → `status = 'pending'`
- Для текущей партии:
  - Если счет > 0 или есть `startTime` → `status = 'in_progress'`
  - Иначе → `status = 'pending'`

## 3. Логика управления состояниями

### 3.1. Обновление `useMatch` hook (`src/renderer/hooks/useMatch.js`)

**Новые функции:**

1. **`startSet()`** - Начало партии:
   - Устанавливает `currentSet.status = 'in_progress'`
   - Фиксирует `currentSet.startTime = Date.now()`
   - Обновляет `updatedAt`

2. **`finishSet()`** - Завершение партии (рефакторинг):
   - Проверяет, что партия в статусе `in_progress`
   - Фиксирует `endTime = Date.now()`
   - Вычисляет `duration = Math.round((endTime - startTime) / 60000)` (в минутах)
   - Сохраняет завершенную партию с полными данными
   - Переходит к следующей партии со статусом `pending`

3. **`toggleSetStatus()`** - Переключение статуса (для toggle-кнопки):
   - Если `status === 'pending'` → вызывает `startSet()`
   - Если `status === 'in_progress'` → вызывает `finishSet()`

4. **`updateSet(setNumber, updates)`** - Обновление данных партии (для модального окна):
   - Валидация изменений (счет, статус, время)
   - Проверка логической целостности (нельзя завершить партию раньше начала)
   - Обновление данных партии
   - Пересчет продолжительности при изменении времени

### 3.2. Валидация изменений партий

**Правила валидации:**
1. Нельзя установить `endTime` раньше `startTime`
2. Нельзя изменить статус завершенной партии на `in_progress` без корректировки времени
3. При изменении счета завершенной партии проверять правила волейбола (`canFinishSet`)
4. При изменении статуса текущей партии проверять, что это не нарушает последовательность

## 4. UI компоненты

### 4.1. Toggle-кнопка "Начать/Завершить партию"

**Файл:** `src/renderer/pages/MatchControlPage.jsx`

**Изменения:**
- Заменить кнопку "Завершить партию" на toggle-кнопку
- Текст кнопки зависит от статуса:
  - `status === 'pending'` → "Начать партию"
  - `status === 'in_progress'` → "Завершить партию"
- Стили кнопки:
  - `pending` → синий цвет (#3498db)
  - `in_progress` → зеленый цвет (#27ae60)
- Кнопка активна всегда (убрать проверку `canFinish` для начала партии)

### 4.2. Компонент "Счет по партиям" (основная версия)

**Файл:** `src/renderer/components/SetsDisplay.jsx`

**Изменения:**
- Добавить отображение статуса партии
- Добавить отображение продолжительности для завершенных партий
- Сделать партии кликабельными (для открытия модального окна)
- Визуальные индикаторы:
  - `pending` → серый фон (#bdc3c7), текст "-"
  - `in_progress` → синий фон (#3498db), текст "В игре" + счет
  - `completed` → зеленый фон (#27ae60), счет + продолжительность (например, "25:20 (45')")

**Новый пропс:**
```jsx
<SetsDisplay
  sets={match.sets}
  currentSet={match.currentSet}
  onSetClick={(setNumber) => openSetEditModal(setNumber)}
/>
```

### 4.3. Компонент "Счет по партиям" (мобильная версия)

**Файл:** `src/main/server.js` (функция `updateSetsList()`)

**Изменения:**
- Добавить отображение статуса в списке партий
- Добавить отображение продолжительности для завершенных партий
- Формат: "Партия 1: 25:20 (45')" для завершенных
- Формат: "Партия 2: В игре (15:12)" для текущей

### 4.4. Модальное окно редактирования партии

**Новый файл:** `src/renderer/components/SetEditModal.jsx`

**Функционал:**
- Открывается по клику на партию в `SetsDisplay`
- Поля для редактирования:
  - Счет команды A (number input)
  - Счет команды B (number input)
  - Статус (select: pending, in_progress, completed)
  - Время начала (datetime-local или timestamp input)
  - Время завершения (datetime-local или timestamp input)
  - Продолжительность (read-only, вычисляется автоматически)
- Валидация:
  - Проверка правил волейбола для завершенных партий
  - Проверка логики времени (endTime >= startTime)
  - Предупреждения при потенциально некорректных изменениях
- Кнопки:
  - "Сохранить" - применяет изменения
  - "Отмена" - закрывает модальное окно без изменений

**Интеграция:**
- Добавить состояние модального окна в `MatchControlPage`
- Передать функцию `updateSet` из `useMatch` hook

## 5. Утилиты и вспомогательные функции

### 5.1. Утилиты для работы со временем

**Новый файл:** `src/shared/timeUtils.js`

**Функции:**
```javascript
/**
 * Вычисляет продолжительность партии в минутах
 * @param {number} startTime - Timestamp начала
 * @param {number} endTime - Timestamp завершения
 * @returns {number} Продолжительность в минутах (округленная)
 */
export function calculateDuration(startTime, endTime) {
  if (!startTime || !endTime) return null;
  return Math.round((endTime - startTime) / 60000);
}

/**
 * Форматирует продолжительность для отображения
 * @param {number} minutes - Продолжительность в минутах
 * @returns {string} Форматированная строка (например, "45'")
 */
export function formatDuration(minutes) {
  if (minutes === null || minutes === undefined) return '';
  return `${minutes}'`;
}

/**
 * Конвертирует Date в timestamp
 * @param {Date|string} date - Дата
 * @returns {number} Timestamp
 */
export function toTimestamp(date) {
  if (typeof date === 'string') {
    return new Date(date).getTime();
  }
  return date.getTime();
}
```

### 5.2. Валидация изменений партий

**Новый файл:** `src/shared/setValidation.js`

**Функции:**
```javascript
/**
 * Валидирует изменения партии
 * @param {Set} set - Текущие данные партии
 * @param {Object} updates - Предлагаемые изменения
 * @param {number} currentSetNumber - Номер текущей партии
 * @returns {Object} { valid: boolean, errors: string[] }
 */
export function validateSetUpdate(set, updates, currentSetNumber) {
  const errors = [];
  
  // Проверка времени
  if (updates.startTime && updates.endTime) {
    if (updates.endTime < updates.startTime) {
      errors.push('Время завершения не может быть раньше времени начала');
    }
  }
  
  // Проверка счета для завершенных партий
  if (updates.status === 'completed' || (set.status === 'completed' && updates.status !== 'pending')) {
    if (!canFinishSet(updates.scoreA || set.scoreA, updates.scoreB || set.scoreB, set.setNumber)) {
      errors.push('Счет не соответствует правилам завершения партии');
    }
  }
  
  // Проверка последовательности статусов
  // (нельзя перейти из completed в in_progress без корректировки времени)
  
  return {
    valid: errors.length === 0,
    errors
  };
}
```

## 6. Обновление API мобильного сервера

**Файл:** `src/main/server.js`

**Изменения:**

1. **API завершения партии** (`POST /api/match/:sessionId/set`):
   - Обновить логику для работы с новыми полями (status, startTime, endTime)
   - Фиксировать время завершения

2. **Новый API начала партии** (`POST /api/match/:sessionId/set/start`):
   - Устанавливает статус `in_progress`
   - Фиксирует `startTime`

3. **Обновление HTML мобильной панели:**
   - Обновить функцию `updateSetsList()` для отображения статуса и продолжительности
   - Обновить кнопку "Завершить партию" на toggle-кнопку

## 7. Обратная совместимость

### 7.1. Миграция данных при загрузке

**Файл:** `src/shared/matchUtils.js` (или создать новый `matchMigration.js`)

**Функция миграции:**
```javascript
/**
 * Мигрирует старые данные матча к новой структуре
 * @param {Match} match - Матч для миграции
 * @returns {Match} Мигрированный матч
 */
export function migrateMatchToSetStatus(match) {
  const migrated = { ...match };
  
  // Миграция завершенных партий
  migrated.sets = match.sets.map(set => {
    if (set.completed && !set.status) {
      return {
        ...set,
        status: 'completed',
        // Если нет времени, можно установить дефолтные значения или оставить undefined
      };
    }
    return set;
  });
  
  // Миграция текущей партии
  if (match.currentSet) {
    const currentSet = { ...match.currentSet };
    
    // Если счет > 0, считаем партию начатой
    if ((currentSet.scoreA > 0 || currentSet.scoreB > 0) && !currentSet.status) {
      currentSet.status = 'in_progress';
      // Если нет startTime, можно установить updatedAt как приблизительное время начала
      if (!currentSet.startTime && match.updatedAt) {
        currentSet.startTime = new Date(match.updatedAt).getTime();
      }
    } else if (!currentSet.status) {
      currentSet.status = 'pending';
    }
    
    migrated.currentSet = currentSet;
  }
  
  return migrated;
}
```

**Применение миграции:**
- В `fileManager.js` при загрузке матча
- В `useMatch.js` при инициализации

## 8. Тестирование

### 8.1. Юнит-тесты

**Новые тесты:**

1. **`tests/unit/shared/timeUtils.test.js`**
   - Тесты для `calculateDuration()`
   - Тесты для `formatDuration()`
   - Тесты для `toTimestamp()`

2. **`tests/unit/shared/setValidation.test.js`**
   - Тесты валидации времени
   - Тесты валидации счета
   - Тесты валидации статусов

3. **`tests/unit/renderer/useMatch-set-status.test.js`**
   - Тесты для `startSet()`
   - Тесты для `finishSet()` с таймингом
   - Тесты для `toggleSetStatus()`
   - Тесты для `updateSet()`

4. **Обновить существующие тесты:**
   - `tests/unit/renderer/useVMix-*.test.js` - проверить работу с новыми полями
   - `tests/unit/shared/matchUtils.test.js` - добавить тесты миграции

### 8.2. Интеграционные тесты

**Обновить:**
- `tests/integration/api/mobileServer.test.js` - проверить работу API с новыми полями

## 9. Порядок реализации

### Этап 1: Структура данных и типы
1. ✅ Обновить `Match.ts` с новыми полями
2. ✅ Создать константы состояний
3. ✅ Создать утилиты для работы со временем
4. ✅ Создать функции миграции данных

### Этап 2: Логика управления
5. ✅ Обновить `useMatch.js` с новыми функциями
6. ✅ Добавить валидацию изменений партий
7. ✅ Обновить `finishSet()` для работы с таймингом

### Этап 3: UI компоненты (основная версия)
8. ✅ Обновить `SetsDisplay.jsx` с отображением статуса и продолжительности
9. ✅ Создать `SetEditModal.jsx`
10. ✅ Обновить `MatchControlPage.jsx` с toggle-кнопкой
11. ✅ Интегрировать модальное окно

### Этап 4: Мобильная версия
12. ✅ Обновить API мобильного сервера
13. ✅ Обновить HTML мобильной панели
14. ✅ Обновить функцию `updateSetsList()` в мобильной версии

### Этап 5: Тестирование и документация
15. ✅ Написать тесты
16. ✅ Обновить документацию
17. ✅ Провести ручное тестирование

## 10. Дополнительные соображения

### 10.1. Производительность
- Кэширование вычисленной продолжительности
- Debounce для обновлений времени в модальном окне

### 10.2. UX улучшения
- Индикатор "Идет партия" с таймером в реальном времени (опционально)
- Подсветка текущей партии
- Анимации при смене статуса

### 10.3. Безопасность
- Валидация всех входных данных в модальном окне
- Защита от XSS при отображении времени (использовать `domUtils.js`)

## 11. Чеклист перед завершением

- [x] Все типы обновлены
- [x] Миграция данных работает корректно
- [x] Toggle-кнопка работает в обеих версиях
- [x] Время фиксируется автоматически
- [x] Продолжительность вычисляется и отображается
- [x] Модальное окно позволяет корректировать данные
- [x] Валидация предотвращает некорректные изменения
- [x] Мобильная версия синхронизирована
- [ ] Все тесты проходят (частично реализовано)
- [x] Документация обновлена

## 12. Дополнительные реализованные функции

### 12.1. Блокировка управления счетом при неактивной партии
- ✅ Кнопки изменения счета (+1, -1) блокируются, когда партия не начата
- ✅ Кнопка "Отменить последнее действие" блокируется при неактивной партии
- ✅ Реализовано в основной версии (`MatchControlPage.jsx`, `ScoreButtons.jsx`)
- ✅ Реализовано в мобильной версии (`server.js`)

### 12.2. Оптимизация истории действий в мобильной версии
- ✅ Создана функция `createLightweightMatchCopy()` для исключения логотипов из истории
- ✅ Уменьшен объем данных при отмене действий (с нескольких МБ до десятков КБ)
- ✅ Логотипы сохраняются при восстановлении состояния

### 12.3. Отображение длительности "0'"
- ✅ Длительность показывается даже если она равна 0 (для тестирования)
- ✅ Реализовано в основной версии (`SetsDisplay.jsx`)
- ✅ Реализовано в мобильной версии (`server.js`)

### 12.4. Улучшения логики отображения статусов
- ✅ Компонент "Счет по партиям" обновляется сразу после завершения партии
- ✅ Текущий счет показывает "Партия #X - завершена" после завершения
- ✅ Номер партии обновляется только при нажатии "Начать партию"
- ✅ Счет обнуляется при нажатии "Начать партию", а не при "Завершить партию"

### 12.5. Исправления логики сетбола/матчбола
- ✅ Индикаторы "Сетбол" и "Матчбол" показываются только когда партия в статусе `in_progress`
- ✅ Исправлена проблема с неправильным отображением после завершения партии

### 12.6. API мобильного сервера
- ✅ Реализован endpoint `POST /api/match/:sessionId/set/start` для начала партии
- ✅ Обновлен endpoint `POST /api/match/:sessionId/set` для завершения партии с таймингом
- ✅ Реализован endpoint `POST /api/match/:sessionId/undo` для отмены действий
- ✅ Исправлена обработка ошибок в мобильной версии

## 13. Статус реализации: ✅ ОСНОВНОЙ ФУНКЦИОНАЛ РЕАЛИЗОВАН

Все основные функции из плана реализованы и работают. Осталось:
- Написать полный набор тестов для новых функций
- Опциональные UX улучшения (таймер в реальном времени, анимации)

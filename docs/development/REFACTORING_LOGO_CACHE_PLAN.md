# План рефакторинга: Уникальные имена логотипов для обхода кэширования vMix

## Проблема
vMix кэширует изображения по имени файла, что приводит к проблемам при смене команд местами или обновлении логотипов.

## Решение
Использовать уникальные имена файлов с timestamp для каждого сохранения логотипа, что гарантирует обход кэша vMix.

## План рефакторинга (TDD подход)

### Этап 1: Тесты (Красная фаза)

#### 1.1 Тесты для logoManager с уникальными именами
**Файл:** `tests/unit/main/logoManager-unique-names.test.js`

Тесты должны проверить:
- ✅ `saveLogoToFile` генерирует уникальные имена с timestamp
- ✅ Имена файлов содержат префикс `logo_a_` или `logo_b_` и timestamp
- ✅ `cleanupLogosDirectory` удаляет все файлы из папки logos
- ✅ `processTeamLogoForSave` очищает папку перед сохранением новых логотипов
- ✅ При каждом сохранении создается новый файл с уникальным именем
- ✅ Старые файлы удаляются перед сохранением новых

#### 1.2 Обновление существующих тестов
**Файл:** `tests/unit/main/swap-teams-logo.test.js`

Обновить тесты для работы с уникальными именами:
- Проверять, что имена файлов содержат timestamp
- Проверять, что старые файлы удаляются
- Проверять, что новые файлы создаются с уникальными именами

### Этап 2: Реализация (Зеленая фаза)

#### 2.1 Изменения в `logoManager.js`

**Функция `saveLogoToFile`:**
```javascript
// БЫЛО:
const fileName = team === 'A' ? 'logo_a.png' : 'logo_b.png';

// СТАНЕТ:
const timestamp = Date.now();
const prefix = team === 'A' ? 'logo_a' : 'logo_b';
const fileName = `${prefix}_${timestamp}.png`;
```

**Новая функция `cleanupLogosDirectory`:**
```javascript
// Полностью очищает папку logos от всех файлов
// Вызывается перед каждым сохранением новых логотипов
async function cleanupLogosDirectory() {
  const logosDir = getLogosDir();
  try {
    const files = await fs.readdir(logosDir);
    for (const file of files) {
      if (file.startsWith('logo_') && file.endsWith('.png')) {
        await fs.unlink(path.join(logosDir, file));
      }
    }
  } catch (error) {
    // Игнорируем ошибки, если папка не существует или пуста
  }
}
```

**Изменения в `processTeamLogoForSave`:**
```javascript
// Добавить очистку папки ПЕРЕД сохранением новых логотипов
async function processTeamLogoForSave(team, teamLetter) {
  // ... существующий код определения logoBase64 ...
  
  if (isBase64) {
    try {
      // ВАЖНО: Очищаем папку перед сохранением новых логотипов
      await cleanupLogosDirectory();
      
      // Сохраняем в файл с уникальным именем
      const logoPath = await saveLogoToFile(logoBase64, teamLetter);
      // ... остальной код ...
    }
  }
}
```

#### 2.2 Изменения в `main.js`

**Обработчик `match:swap-teams`:**
- Убрать вызов `cleanupLogosDirectory` после обработки логотипов (теперь это делается в `processTeamLogoForSave`)
- Убедиться, что `processTeamLogoForSave` вызывается для обеих команд

**Обработчик `match:set-current`:**
- Убрать отдельную очистку, так как `processTeamLogoForSave` теперь делает это автоматически

#### 2.3 Изменения в `fileManager.js`

**Функция `saveMatch`:**
- Убрать вызов `cleanupLogosDirectory` после сохранения (теперь это делается в `processTeamLogoForSave`)

### Этап 3: Обновление зависимостей

#### 3.1 Места использования логотипов
- `useVMix.js` - использование `logoPath` из матча (не требует изменений, так как путь хранится в JSON)
- `server.js` - отдача логотипов по HTTP (не требует изменений, так как путь динамический)
- `vmix-client.js` - отправка URL логотипов в vMix (не требует изменений)

### Этап 4: Миграция существующих данных

#### 4.1 Обработка старых матчей
- При загрузке матча со старыми `logoPath` (без timestamp) - пересохранить с новыми именами
- Обновить `processTeamLogoForLoad` для пересохранения логотипов с уникальными именами

### Этап 5: Тестирование и проверка

#### 5.1 Запуск всех тестов
- ✅ Все новые тесты проходят
- ✅ Все существующие тесты проходят (после обновления)
- ✅ Интеграционные тесты проходят

#### 5.2 Ручное тестирование
- Проверить смену команд местами
- Проверить обновление логотипов
- Проверить работу в vMix (логотипы обновляются без кэширования)

## Детальный план изменений по файлам

### `src/main/logoManager.js`

1. **`saveLogoToFile(base64String, team)`**
   - Изменить генерацию имени файла на уникальное с timestamp
   - Формат: `logo_a_1234567890.png` или `logo_b_1234567890.png`

2. **`cleanupLogosDirectory()`**
   - Реализовать полную очистку папки logos
   - Удалять все файлы, начинающиеся с `logo_` и заканчивающиеся на `.png`

3. **`processTeamLogoForSave(team, teamLetter)`**
   - Добавить вызов `cleanupLogosDirectory()` перед сохранением
   - Убрать логику удаления конкретного файла (теперь очищаем всю папку)

4. **`processTeamLogoForLoad(team, teamLetter)`**
   - При наличии `logoBase64` - пересохранить с уникальным именем
   - Обновить `logoPath` на новое уникальное имя

### `src/main/main.js`

1. **`match:swap-teams`**
   - Убрать вызов `cleanupLogosDirectory()` после обработки логотипов
   - Оставить только вызовы `processTeamLogoForSave`

2. **`match:set-current`**
   - Убрать отдельную очистку (если есть)
   - Полагаться на `processTeamLogoForSave` для очистки

### `src/main/fileManager.js`

1. **`saveMatch(match, filePath)`**
   - Убрать вызов `cleanupLogosDirectory()` после сохранения
   - Полагаться на `processTeamLogoForSave` для очистки

### Тесты

1. **Новый файл:** `tests/unit/main/logoManager-unique-names.test.js`
   - Тесты для уникальных имен
   - Тесты для очистки папки
   - Тесты для процесса сохранения

2. **Обновить:** `tests/unit/main/swap-teams-logo.test.js`
   - Адаптировать под уникальные имена
   - Проверять паттерн имен файлов

## Преимущества нового подхода

1. ✅ **Обход кэша vMix** - каждое сохранение создает новый файл
2. ✅ **Чистота папки** - старые файлы автоматически удаляются
3. ✅ **Надежность** - нет конфликтов имен файлов
4. ✅ **Простота** - единая точка очистки в `processTeamLogoForSave`

## Риски и митигация

1. **Риск:** Потеря логотипов при ошибке очистки
   - **Митигация:** Очистка происходит только после успешного определения `logoBase64`

2. **Риск:** Множественные файлы при ошибке сохранения
   - **Митигация:** Очистка происходит ПЕРЕД сохранением, а не после

3. **Риск:** Проблемы с загрузкой старых матчей
   - **Митигация:** `processTeamLogoForLoad` пересохраняет логотипы с новыми именами

## Порядок выполнения (TDD)

1. ✅ Написать тесты для новой логики (красная фаза)
2. ✅ Реализовать изменения в `logoManager.js`
3. ✅ Обновить существующие тесты
4. ✅ Обновить код в `main.js` и `fileManager.js`
5. ✅ Запустить все тесты (зеленая фаза)
6. ✅ Рефакторинг и оптимизация
7. ✅ Ручное тестирование

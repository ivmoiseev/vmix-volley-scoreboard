# План разработки приложения vMix Volley Scoreboard

## Этап 1: Инициализация проекта и базовая структура

### 1.1. Настройка проекта Electron

- [x] Инициализация проекта (npm init)
- [x] Установка Electron
- [x] Установка React и необходимых зависимостей
- [x] Настройка структуры папок проекта
- [x] Создание базовой конфигурации Electron (main.js, preload.js)
- [x] Настройка сборки проекта (Vite)

### 1.2. Базовая структура приложения

- [x] Создание главного окна Electron
- [x] Настройка React приложения
- [x] Создание базовой маршрутизации (React Router)
- [x] Настройка IPC коммуникации между процессами
- [x] Создание базовых компонентов (Layout, Header, Navigation)

**Результат:** Работающее Electron приложение с базовым React интерфейсом

---

## Этап 2: Модель данных и управление файлами

### 2.1. Модель данных матча

- [x] Определение структуры JSON файла матча
- [x] Создание утилит для валидации данных (matchUtils.js)
- [x] Поддержка логотипов команд (base64 + файлы)
- [x] Поддержка города для каждой команды

**Структура JSON файла матча:**

```json
{
  "matchId": "uuid",
  "tournament": "string",
  "venue": "string",
  "date": "ISO date",
  "time": "ISO time",
  "teamA": {
    "name": "string",
    "color": "hex color",
    "logo": "base64 или путь к файлу",
    "coach": "string",
    "roster": [
      {
        "number": 1,
        "name": "string",
        "position": "string",
        "isStarter": true
      }
    ]
  },
  "teamB": {
    "name": "string",
    "color": "hex color",
    "logo": "base64 или путь к файлу",
    "coach": "string",
    "roster": [
      {
        "number": 1,
        "name": "string",
        "position": "string",
        "isStarter": true
      }
    ]
  },
  "officials": {
    "referee1": "string",
    "referee2": "string",
    "lineJudge1": "string",
    "lineJudge2": "string",
    "scorer": "string"
  },
  "sets": [
    {
      "setNumber": 1,
      "scoreA": 25,
      "scoreB": 20,
      "completed": true
    }
  ],
  "currentSet": {
    "setNumber": 2,
    "scoreA": 15,
    "scoreB": 18,
    "servingTeam": "A"
  },
  "statistics": {
    "enabled": false,
    "teamA": {
      "attack": 0,
      "block": 0,
      "serve": 0,
      "opponentErrors": 0
    },
    "teamB": {
      "attack": 0,
      "block": 0,
      "serve": 0,
      "opponentErrors": 0
    }
  },
  "createdAt": "ISO datetime",
  "updatedAt": "ISO datetime"
}
```

### 2.2. Управление файлами

- [x] Реализация функции создания нового матча
- [x] Реализация функции открытия матча (диалог выбора файла)
- [x] Реализация функции сохранения матча
- [x] Реализация функции "Сохранить как..."
- [x] Обработка ошибок при работе с файлами
- [x] IPC handlers для работы с файлами
- [x] Интеграция управления логотипами (сохранение/загрузка)

**Результат:** Возможность создавать, открывать и сохранять матчи в JSON формате

---

## Этап 3: Основной интерфейс управления матчем

### 3.1. Страница управления матчем

- [ ] Компонент отображения информации о матче
- [ ] Компонент отображения команд
- [ ] Компонент отображения счета по партиям
- [ ] Компонент управления текущим счетом
- [ ] Кнопки управления (+1, -1 для каждой команды)
- [ ] Компонент отображения текущей подачи
- [ ] Кнопки ручной коррекции подачи (◄ ►)
- [ ] Индикаторы сетбола и матчбола
- [ ] Кнопка завершения партии
- [ ] Функция отмены последнего действия (история действий)
- [ ] Валидация правил волейбола (до 25 очков, разница минимум 2 и т.д.)
- [ ] Переключатель расширенной статистики
- [ ] Кнопки управления статистикой (Атака, Блок, Подачи, Ошибки соперника)
- [ ] Кнопки управления плашками vMix (12 различных плашек)

### 3.2. Логика ведения счета

- [x] Управление счетом текущей партии
- [x] Автоматический учет перехода подачи при начислении очка
- [x] Логика ручной коррекции подачи
- [x] Определение сетбола (по правилам ВФВ: >=24 для сетов 1-4, >=14 для 5-го сета, с разницей в 1 очко, не при равном счете)
- [x] Определение матчбола (по правилам ВФВ: 2 выигранных сета + сетбол в текущем сете)
- [x] Логика завершения партии (до 25 для сетов 1-4, до 15 для 5-го сета, разница минимум 2)
- [x] Переход к следующей партии
- [x] Определение победителя матча
- [x] История действий для отмены

### 3.3. Расширенная статистика

- [ ] Модель данных для статистики
- [ ] Компоненты для ввода статистики
- [ ] Подсчет статистики по категориям (Атака, Блок, Подачи, Ошибки соперника)
- [ ] Отображение статистики в интерфейсе
- [ ] Интеграция статистики с плашками vMix
- [ ] Валидация опциональности (не блокирует основное ведение счета)

**Результат:** Полнофункциональная страница управления матчем с логикой ведения счета

---

## Этап 4: Настройки матча

### 4.1. Страница настроек матча

- [ ] Форма для ввода информации о турнире
- [ ] Форма для настройки команд (названия, цвета)
- [ ] Компонент выбора цвета (цветовой пикер)
- [ ] Компонент выбора даты и времени
- [ ] Форма для указания судейской коллегии
- [ ] Валидация форм
- [ ] Сохранение изменений в текущий матч

### 4.2. Управление составами команд

- [x] Страница управления составами команд
- [x] Форма для указания тренеров команд (поле "Тренер" в блоке состава команды)
- [x] Редактор состава команды (добавление, удаление игроков)
- [x] Указание позиций игроков
- [x] Выбор стартового состава
- [x] Импорт/экспорт составов в файлы (новый формат: { coach, roster })
- [x] Сохранение составов в файл матча
- [x] Экспорт и импорт имени тренера вместе с составом

**Результат:** Страница для настройки всех параметров матча и управления составами команд

---

## Этап 5: Интеграция с vMix

### 5.1. HTTP клиент для vMix

- [ ] Изучение vMix HTTP API
- [ ] Создание модуля для отправки HTTP запросов к vMix
- [ ] Функции для обновления инпутов
- [ ] Функции для управления оверлеями
- [ ] Обработка ошибок подключения
- [ ] Тестирование подключения

### 5.2. Страница настроек vMix

- [x] Форма для ввода IP адреса и порта
- [x] Кнопка тестирования подключения
- [x] Форма для настройки названий инпутов (12 инпутов для всех плашек)
- [x] Выбор оверлея для каждого инпута отдельно (выпадающие списки 1-8)
- [x] Сохранение настроек в глобальный файл настроек `settings.json`
- [x] Автоматическая загрузка настроек при запуске приложения

### 5.3. Автоматическое обновление vMix

- [x] Подписка на изменения счета
- [x] Автоматическая отправка обновлений в vMix при изменении счета
- [x] Обновление всех настроенных инпутов
- [x] Индикатор статуса подключения
- [x] Debounce для оптимизации запросов

### 5.4. Управление плашками vMix

- [ ] Функции для вывода плашек в оверлеи через HTTP API vMix
- [ ] Кнопки управления плашками в интерфейсе:
  - Заявка (TeamA vs TeamB)
  - Статистика
  - Состав команды (полный)
  - Стартовый состав команды
  - Текущий счет (во время партии)
  - Счет после 1-5 партий
  - Плашка 1 судья
  - Плашка 2 судьи
- [ ] Подготовка данных для каждой плашки
- [ ] Отправка данных в соответствующие инпуты vMix
- [ ] Управление оверлеями (показ/скрытие плашек)
- [ ] Реализация state-dependent кнопок плашек
- [ ] Запрос текущего состояния оверлеев из vMix через HTTP API
- [ ] Синхронизация состояния кнопок с реальным состоянием оверлеев в vMix
- [ ] Визуальная индикация активного/неактивного состояния плашек
- [ ] Обновление состояния кнопок при изменении состояния оверлеев в vMix
- [ ] Обработка случая отсутствия соединения с vMix (кнопки неактивны или показывают неизвестное состояние)

**Результат:** Полная интеграция с vMix с автоматическим обновлением данных

---

## Этап 6: Встроенный HTTP сервер

### 6.1. Создание HTTP сервера

- [ ] Настройка Express или встроенного Node.js HTTP сервера
- [ ] Определение порта для сервера
- [ ] Получение локального IP адреса
- [ ] Запуск/остановка сервера
- [ ] Обработка CORS для мобильных устройств

### 6.2. Система доступа

- [x] Генерация уникальных идентификаторов для сессий
- [x] Хранение активных сессий
- [x] Валидация доступа по уникальной ссылке
- [x] Истечение срока действия ссылок (24 часа)
- [x] Сохранение sessionId в глобальных настройках
- [x] Автоматическое восстановление ссылки при перезапуске приложения

### 6.3. API endpoints

- [ ] `GET /panel/:sessionId` - страница мобильной панели
- [ ] `GET /api/match/:sessionId` - получение данных матча
- [ ] `POST /api/match/:sessionId/score` - обновление счета
- [ ] `POST /api/match/:sessionId/set` - завершение партии
- [ ] WebSocket или Server-Sent Events для real-time обновлений (опционально)

**Результат:** Работающий HTTP сервер с системой безопасного доступа

---

## Этап 7: Страница мобильного доступа

### 7.1. Генерация ссылок и QR-кодов

- [x] Генерация уникальных ссылок
- [x] Интеграция библиотеки для генерации QR-кодов (через внешний API)
- [x] Отображение QR-кода на странице
- [x] Копирование ссылки в буфер обмена
- [x] Генерация новой ссылки (инвалидация старой)
- [x] Сохранение ссылки в глобальных настройках
- [x] Автоматическое восстановление и отображение сохраненной ссылки при перезапуске

### 7.2. Управление сервером

- [x] Кнопки запуска/остановки сервера
- [x] Отображение статуса сервера
- [x] Отображение адреса сервера
- [x] Сохранение состояния сервера (включен/выключен) в глобальных настройках
- [x] Сохранение порта сервера в настройках
- [x] Автоматический запуск сервера при перезапуске приложения, если он был включен

**Результат:** Страница для управления мобильным доступом с QR-кодами

---

## Этап 8: Мобильный интерфейс

### 8.1. Адаптивный дизайн

- [ ] Создание мобильной версии компонентов
- [ ] Адаптивная верстка для различных размеров экранов
- [ ] Оптимизация для touch-управления
- [ ] Крупные кнопки для удобного использования

### 8.2. Функциональность мобильного интерфейса

- [x] Отображение текущего счета
- [x] Отображение текущей подачи
- [x] Кнопки управления счетом (+1, -1 для каждой команды)
- [x] Отображение счета по партиям
- [x] Завершение партии
- [x] Отмена последнего действия
- [x] Индикатор синхронизации (с разграничением локальных и серверных обновлений)
- [x] Упрощенный интерфейс без управления плашками vMix
- [x] Отображение индикаторов сетбола и матчбола

### 8.3. Синхронизация данных

- [x] Реал-тайм синхронизация с основным приложением (polling каждые 2 секунды)
- [x] Обработка конфликтов при одновременном изменении (приоритет основному приложению)
- [x] Отображение статуса синхронизации
- [x] Двусторонняя синхронизация (мобильное устройство → основное приложение)
- [x] Callback механизм для уведомления основного приложения об изменениях

**Результат:** Полнофункциональный мобильный интерфейс с синхронизацией

---

## Этап 9: Дополнительные страницы и функции

### 9.1. Страница "Добро пожаловать"

- [x] Компонент главной страницы
- [x] Кнопки создания/открытия матча
- [x] Информация о статусе подключения
- [ ] Список последних матчей (опционально, в будущем)

### 9.2. Навигация и меню

- [ ] Главное меню приложения
- [ ] Навигация между страницами
- [ ] Горячие клавиши
- [ ] Обработка закрытия приложения с несохраненными изменениями

### 9.3. О программе

- [ ] Страница с информацией о приложении
- [ ] Версия приложения
- [ ] Информация о лицензии

**Результат:** Полный набор страниц и функций приложения

---

## Этап 9.5: Система глобальных настроек

### 9.5.1. Менеджер настроек

- [x] Создание модуля для управления глобальными настройками (`settingsManager.js`)
- [x] Сохранение настроек в JSON файл (`settings.json`)
- [x] Автоматическое создание файла с дефолтными значениями
- [x] Поддержка миграции настроек при обновлении структуры
- [x] Функции для получения и сохранения настроек vMix
- [x] Функции для получения и сохранения настроек мобильного сервера

### 9.5.2. Интеграция настроек

- [x] Интеграция настроек vMix с глобальным менеджером
- [x] Интеграция настроек мобильного сервера с глобальным менеджером
- [x] Автоматическая загрузка настроек при запуске приложения
- [x] Автоматическое восстановление состояния при перезапуске

**Результат:** Единая система управления глобальными настройками приложения

---

## Этап 10: Тестирование и оптимизация

### 10.1. Тестирование функциональности

- [ ] Тестирование создания/открытия/сохранения матчей
- [ ] Тестирование ведения счета
- [ ] Тестирование интеграции с vMix
- [ ] Тестирование мобильного доступа
- [ ] Тестирование на различных устройствах

### 10.2. Обработка ошибок

- [ ] Обработка ошибок подключения к vMix
- [ ] Обработка ошибок работы с файлами
- [ ] Обработка ошибок сети
- [ ] Пользовательские сообщения об ошибках

### 10.3. Оптимизация

- [ ] Оптимизация производительности
- [ ] Оптимизация размера приложения
- [ ] Оптимизация сетевых запросов
- [ ] Кэширование данных

**Результат:** Протестированное и оптимизированное приложение

---

## Этап 11: Сборка и распространение

### 11.1. Настройка сборки

- [ ] Настройка electron-builder или electron-forge
- [ ] Создание иконок приложения
- [ ] Настройка конфигурации для разных платформ (Windows, macOS, Linux)

### 11.2. Создание установщиков

- [ ] Сборка для Windows (.exe)
- [ ] Сборка для macOS (.dmg)
- [ ] Сборка для Linux (.AppImage или .deb)

### 11.3. Документация

- [ ] Обновление README.md
- [ ] Создание руководства пользователя
- [ ] Документация API (если необходимо)

**Результат:** Готовое к распространению приложение

---

## Порядок приоритетов

### Минимально жизнеспособный продукт (MVP)

1. Этап 1 - Инициализация проекта
2. Этап 2 - Модель данных и управление файлами
3. Этап 3 - Основной интерфейс управления матчем
4. Этап 4 - Настройки матча
5. Этап 5 - Интеграция с vMix (базовая)
6. Этап 9.1 - Страница "Добро пожаловать"

### Полная версия

7. Этап 3.3 - Расширенная статистика
8. Этап 4.2 - Управление составами команд
9. Этап 5.4 - Управление плашками vMix
10. Этап 6 - Встроенный HTTP сервер
11. Этап 7 - Страница мобильного доступа
12. Этап 8 - Мобильный интерфейс
13. Этап 9 - Остальные страницы
14. Этап 10 - Тестирование и оптимизация
15. Этап 11 - Сборка и распространение

---

## Технические детали

### Зависимости проекта

- `electron` - фреймворк для десктопного приложения
- `react` - библиотека для UI
- `react-dom` - рендеринг React
- `react-router-dom` - маршрутизация
- `express` или встроенный `http` - HTTP сервер
- `qrcode` - генерация QR-кодов
- `axios` или `fetch` - HTTP клиент для vMix
- `electron-store` - хранение настроек (опционально)
- `sharp` или `jimp` - обработка изображений (логотипы)
- `uuid` - генерация уникальных идентификаторов

### Структура папок проекта

```
vmix-volley-scoreboard/
├── docs/                    # Документация
├── src/
│   ├── main/               # Основной процесс Electron
│   │   ├── main.js         # Точка входа
│   │   ├── server.js        # HTTP сервер для мобильного доступа
│   │   ├── vmix-client.js   # Клиент vMix
│   │   ├── vmix-config.js   # Конфигурация vMix (использует settingsManager)
│   │   ├── settingsManager.js # Менеджер глобальных настроек
│   │   ├── fileManager.js   # Управление файлами матчей
│   │   ├── logoManager.js   # Управление логотипами
│   │   └── preload.js       # Preload скрипт для IPC
│   ├── renderer/           # Рендер процесс
│   │   ├── index.html
│   │   ├── index.jsx
│   │   ├── components/     # React компоненты
│   │   ├── pages/          # Страницы приложения
│   │   ├── hooks/          # React хуки (useMatch, useVMix)
│   │   └── utils/          # Утилиты (imageResize, debounce)
│   └── shared/             # Общий код
│       ├── volleyballRules.js # Правила волейбола
│       ├── matchUtils.js    # Утилиты для работы с матчами
│       └── errorHandler.js  # Обработка ошибок
├── matches/                # Папка для сохранения матчей
├── logos/                  # Папка для сохранения логотипов (logo_a.png, logo_b.png)
├── settings.json           # Глобальные настройки приложения (не в git)
├── package.json
└── README.md
```

---

## Примечания

- На каждом этапе рекомендуется создавать коммиты в git
- Тестирование должно проводиться на каждом этапе
- При необходимости этапы можно выполнять параллельно
- Приоритет - простота и надежность, а не избыточная функциональность

# Разделение инпутов составов на команды и улучшения идентификации инпутов

## Дата изменения
2026-01-08

## Обзор изменений

Этот документ описывает изменения, связанные с разделением инпутов "Состав команды" и "Стартовый состав" на отдельные инпуты для команды A и команды B, исправление механизма идентификации инпутов vMix, и улучшение обработки номеров игроков.

## Основные изменения

### 1. Разделение инпутов составов на команды A и B

#### Проблема
Ранее инпуты `roster` (Состав команды) и `startingLineup` (Стартовый состав) были общими для обеих команд. Это не позволяло отображать отдельные составы для команды A и команды B в vMix.

#### Решение
Инпуты разделены на четыре отдельных инпута:
- `rosterTeamA` - Состав команды A (полный)
- `rosterTeamB` - Состав команды B (полный)
- `startingLineupTeamA` - Стартовый состав команды A
- `startingLineupTeamB` - Стартовый состав команды B

#### Затронутые файлы

**`src/main/vmix-input-configs.js`**
- Переименован `roster` → `rosterTeamA`
- Переименован `startingLineup` → `startingLineupTeamA`
- Добавлены конфигурации `rosterTeamB` и `startingLineupTeamB`
- Изменен тип поля `teamLogo` с `text` на `image` для всех инпутов составов
- Добавлены поля для 14 игроков в каждом инпуте (player1Number, player1Name, ... player14Number, player14Name)

**`src/main/settingsManager.js`**
- Обновлен `getDefaultSettings()` для включения новых ключей инпутов
- Добавлена логика миграции старых ключей `roster` и `startingLineup` в новые форматы
- При миграции создаются два инпута (`rosterTeamA` и `rosterTeamB`), если существовал `roster`
- Для команды B к `inputIdentifier` добавляется суффикс `_B`

**`src/renderer/pages/VMixSettingsPage.jsx`**
- Обновлен начальный state для включения новых ключей инпутов
- Обновлен `inputLabels` для отображения понятных названий новых инпутов

**`src/renderer/components/VMixOverlayButtons.jsx`**
- Добавлены кнопки для управления новыми инпутами:
  - "Состав команды A"
  - "Состав команды B"
  - "Стартовый состав A"
  - "Стартовый состав B"

### 2. Исправление идентификации инпутов vMix

#### Проблема
Функция `normalizeInputIdentifier` некорректно извлекала номер из строк типа "Input3", пытаясь преобразовать строку в число. Это приводило к ошибкам при сравнении инпутов, особенно когда один инпут имел имя (например, "Zayavka2024-2.gtzip"), а другой - формат "Input3".

#### Решение
- Переименована функция `normalizeInputIdentifier` → `findInputInMap`
- Функция теперь использует расширенную карту инпутов (`inputsMap`) для поиска по номеру, ID (key), названию или короткому названию
- Полностью переработана логика `isOverlayActive` для корректного сравнения инпутов на основе данных из vMix API

#### Затронутые файлы

**`src/main/vmix-client.js`**
- Расширен `inputsMap` для хранения полной информации об инпутах:
  ```javascript
  {
    number: number,
    key: input.$.key || null,      // ID инпута
    title: input.$.title || '',
    shortTitle: input.$.shortTitle || input.$.title || '',
    type: input.$.type || '',
  }
  ```
- Обновлены комментарии для уточнения назначения `inputsMap`

**`src/renderer/hooks/useVMix.js`**
- Удалена функция `normalizeInputIdentifier`
- Добавлена функция `findInputInMap(identifier)`:
  - Ищет инпут по номеру в `inputsMap`
  - Ищет по ID (key) в `inputsMap`
  - Ищет по названию (title) или короткому названию (shortTitle)
  - Ищет по имени файла без расширения (для .gtzip файлов)
  - Возвращает полную информацию об инпуте или `null`
- Полностью переработана функция `isOverlayActive`:
  - Использует `findInputInMap` для поиска сконфигурированного инпута
  - Использует `findInputInMap` для поиска инпута в оверлее из vMix API
  - Сравнивает инпуты по номеру из `inputsMap` вместо строковых преобразований
  - Корректно обрабатывает случаи, когда инпут не найден

### 3. Реализация передачи данных для инпутов составов

#### Проблема
После разделения инпутов на команды A и B требовалось реализовать передачу данных в новые инпуты.

#### Решение
Добавлены функции для форматирования и передачи данных составов команд в vMix.

#### Затронутые файлы

**`src/renderer/hooks/useVMix.js`**

**Новая функция `getRosterFieldValue(fieldKey, match, teamKey, roster, logoBaseUrl)`**
- Извлекает значение поля для инпута состава команды
- Поддерживает общие поля: `title`, `subtitle`, `teamName`, `teamCity`, `teamLogo`
- Поддерживает поля игроков: `player1Number`, `player1Name`, ... `player14Number`, `player14Name`
- Возвращает пустую строку для игроков, которых нет в составе
- Формирует URL логотипов в формате `/logos/logo_a.png` или `/logos/logo_b.png`

**Новая функция `formatRosterData(match, teamKey, logoBaseUrl)`**
- Форматирует данные состава команды для передачи в vMix
- Разделяет поля на `fields` (текст) и `imageFields` (изображения)
- Обрабатывает до 14 игроков, заполняя пустыми строками отсутствующие позиции

**Новые функции `updateRosterTeamAInput()` и `updateRosterTeamBInput()`**
- Обновляют инпуты `rosterTeamA` и `rosterTeamB` в vMix
- Используют `formatRosterData` для форматирования данных
- Используют `updateInputFields` для отправки данных в vMix

**Интеграция в debounce механизм**
- `updateRosterTeamAInput` и `updateRosterTeamBInput` добавлены в `updateMatchDataDebouncedRef`
- Автоматическое обновление инпутов при изменении данных матча

### 4. Поддержка пустых номеров игроков

#### Проблема
Иногда на площадке присутствуют игроки без номера, что не поддерживалось интерфейсом управления составами.

#### Решение
Добавлена поддержка `null` для номера игрока во всех частях приложения.

#### Затронутые файлы

**`src/renderer/pages/RosterManagementPage.jsx`**

**Обновлена функция `handleAddPlayer()`**
- При генерации следующего номера учитываются только игроки с номерами (игнорируются `null`)
- Правильно вычисляется максимальный номер при наличии игроков без номера

**Обновлена функция `handlePlayerChange()`**
- Для поля `number`: разрешено значение `null` (отсутствие номера)
- Пустая строка, отрицательное число или не число устанавливаются в `null`
- Положительные числа обрабатываются нормально

**Обновлен input для номера игрока**
- Значение: `player.number ?? ''` (пустое поле для `null`)
- `onChange`: пустая строка или минус сохраняются как `null`
- `onBlur`: дополнительная проверка при потере фокуса
- Добавлен `placeholder="Без номера"`
- Ширина увеличена до 80px

**Обновлено отображение стартового состава**
- Для игроков с номером: `№{номер} {имя}`
- Для игроков без номера: `Без номера {имя}`

**`src/renderer/hooks/useVMix.js`**
- Функция `getRosterFieldValue` уже корректно обрабатывает пустые номера:
  ```javascript
  if (fieldType === "Number") {
    return player.number ? String(player.number) : "";
  }
  ```
- Пустые номера передаются в vMix как пустые строки

## Миграция данных

### Автоматическая миграция настроек

При загрузке настроек выполняется автоматическая миграция:

1. **Миграция старого формата инпутов**
   - Если найдены инпуты старого формата (строка или объект без `enabled`/`fields`), выполняется миграция
   - Ключ `roster` преобразуется в `rosterTeamA` и `rosterTeamB`
   - Ключ `startingLineup` преобразуется в `startingLineupTeamA` и `startingLineupTeamB`
   - Для команды B к `inputIdentifier` добавляется суффикс `_B`

2. **Дополнительная миграция существующих ключей**
   - Если существуют ключи `roster` или `startingLineup` в новом формате, они также мигрируются
   - Старые ключи удаляются после успешной миграции

## Технические детали

### Структура данных инпутов

**До изменений:**
```javascript
{
  roster: {
    enabled: true,
    inputIdentifier: "Input3",
    overlay: 1,
    fields: { ... }
  },
  startingLineup: {
    enabled: true,
    inputIdentifier: "Input4",
    overlay: 1,
    fields: { ... }
  }
}
```

**После изменений:**
```javascript
{
  rosterTeamA: {
    enabled: true,
    inputIdentifier: "Input3",
    overlay: 1,
    fields: { ... }
  },
  rosterTeamB: {
    enabled: true,
    inputIdentifier: "Input4",
    overlay: 1,
    fields: { ... }
  },
  startingLineupTeamA: {
    enabled: true,
    inputIdentifier: "Input5",
    overlay: 1,
    fields: { ... }
  },
  startingLineupTeamB: {
    enabled: true,
    inputIdentifier: "Input6",
    overlay: 1,
    fields: { ... }
  }
}
```

### Структура inputsMap

**До изменений:**
```javascript
inputsMap[number] = {
  title: input.$.title || '',
  shortTitle: input.$.shortTitle || input.$.title || '',
}
```

**После изменений:**
```javascript
inputsMap[number] = {
  number: number,
  key: input.$.key || null,           // ID инпута
  title: input.$.title || '',
  shortTitle: input.$.shortTitle || input.$.title || '',
  type: input.$.type || '',
}
```

### Структура данных игрока

**До изменений:**
```javascript
{
  number: 1,        // всегда число >= 0
  name: "Имя",
  position: "Нападающий",
  isStarter: false
}
```

**После изменений:**
```javascript
{
  number: 1,        // число >= 0 или null (без номера)
  name: "Имя",
  position: "Нападающий",
  isStarter: false
}
```

## Совместимость

- Все изменения обратно совместимы благодаря автоматической миграции
- Старые настройки автоматически конвертируются в новый формат при загрузке
- Существующие матчи с игроками продолжат работать нормально
- Номера игроков, установленные ранее, сохраняются без изменений

## Влияние на другие компоненты

### vMix API
- Изменений в API запросах нет
- Добавлены новые инпуты для отображения составов команд
- Логика идентификации инпутов улучшена для более надежного определения активных оверлеев

### Мобильный сервер
- Без изменений
- Логотипы по-прежнему доступны через HTTP сервер

### Управление матчем
- Без изменений
- Данные матча автоматически передаются в новые инпуты при обновлении

## Тестирование

Рекомендуется протестировать:
1. Миграцию старых настроек в новый формат
2. Отображение составов команды A и команды B в vMix
3. Корректность определения активных оверлеев для новых инпутов
4. Обработку игроков без номера при создании и редактировании составов
5. Передачу данных в vMix для всех четырех новых инпутов

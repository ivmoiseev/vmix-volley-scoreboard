# Очистка логотипов при открытии проекта и принудительное обновление vMix

## Дата изменения
2026-01-XX

## Обзор изменений

Этот документ описывает исправления, связанные с очисткой логотипов при открытии проекта без логотипов и принудительной отправкой всех команд в vMix при открытии проекта из файла.

## Основные изменения

### 1. Очистка логотипов при открытии проекта без логотипов

#### Проблема
При открытии проекта без логотипов после проекта с логотипами, логотипы из предыдущего проекта оставались в файлах `logo_a.png` и `logo_b.png` и могли сохраниться в новый проект при автосохранении.

#### Решение

**В `fileManager.js` (функция `openMatch`):**
- Добавлена проверка наличия логотипов в исходном JSON **до** обработки
- Если в открытом проекте нет логотипов (ни `logo`, ни `logoBase64`, ни `logoPath`), удаляются соответствующие файлы `logo_a.png` и `logo_b.png`
- Это предотвращает использование старых файлов от предыдущего проекта

**В `logoManager.js` (функция `processTeamLogoForLoad`):**
- Логотипы загружаются из файлов только если в JSON есть `logoPath`
- Если в JSON нет логотипов, возвращается команда с явно установленными `undefined` для всех полей логотипов (`logo`, `logoPath`, `logoBase64`)
- Это обеспечивает корректное отображение отсутствия логотипов в UI

**В `logoManager.js` (функция `processTeamLogoForSave`):**
- При сохранении проекта без логотипов удаляются файлы `logo_a.png` и `logo_b.png`
- Не устанавливается `logoPath`, если логотипа нет
- Это предотвращает сохранение старых логотипов при автосохранении

**В `main.js`:**
- Добавлена функция `clearLogosOnNewMatch()` для удаления `logo_a.png` и `logo_b.png` при создании нового матча
- Функция вызывается в IPC handler `match:create`

#### Результат
- При открытии проекта без логотипов файлы от предыдущего проекта удаляются
- При автосохранении проекта без логотипов старые файлы не сохраняются
- Логотипы корректно обнуляются в интерфейсе при открытии пустого проекта

### 2. Принудительная отправка команд в vMix при открытии проекта

#### Проблема
При открытии проекта из файла команды на обновление инпутов в vMix передавались только если поля в приложении не пустые. Это означало, что если в приложении пусто, данные в vMix не очищались.

#### Решение

**Изменена проверка `hasFields` в 6 функциях обновления:**
- `updateCurrentScoreInput`
- `updateLineupInput`
- `updateStartingLineupTeamAInput`
- `updateStartingLineupTeamBInput`
- `updateRosterTeamAInput`
- `updateRosterTeamBInput`

Изменено с `if (!hasFields)` на `if (!hasFields && !forceUpdate)`, чтобы при `forceUpdate=true` всегда отправлять команды, даже если все поля пустые.

**Изменена функция `formatCurrentScoreData`:**
- Убрана проверка `value !== ""` для текстовых полей
- Теперь все текстовые поля отправляются, даже пустые

**Изменены функции форматирования для изображений:**
- `formatLineupData`
- `formatRosterData`
- `formatStartingLineupData`

Изменено с `if (value !== "")` на `if (value !== "" || forceUpdate)`, чтобы при `forceUpdate=true` отправлять все поля изображений, даже пустые (для очистки логотипов в vMix).

#### Результат
- При открытии проекта из файла (когда `forceUpdate=true`) все поля отправляются в vMix, включая пустые
- Это позволяет очистить данные в vMix при открытии пустого проекта
- vMix корректно синхронизируется с состоянием приложения при открытии проекта

### 3. Исправление ошибки с повторным объявлением fs

#### Проблема
При открытии проекта возникала ошибка `ReferenceError: Cannot access 'fs' before initialization` из-за повторного объявления `fs` и `path` внутри функции `openMatch`.

#### Решение
- Удалено повторное объявление `const fs = require('fs').promises;` и `const path = require('path');` внутри функции `openMatch`
- Используются уже объявленные в начале файла `fs` и `path`

## Затронутые файлы

### `src/main/fileManager.js`
- Добавлена проверка наличия логотипов в исходном JSON до обработки
- Добавлено удаление файлов `logo_a.png` и `logo_b.png` при открытии проекта без логотипов
- Исправлено повторное объявление `fs` и `path`

### `src/main/logoManager.js`
- Обновлена функция `processTeamLogoForLoad` для явного обнуления полей логотипов при их отсутствии
- Обновлена функция `processTeamLogoForSave` для удаления файлов при отсутствии логотипов

### `src/main/main.js`
- Добавлена функция `clearLogosOnNewMatch()` для удаления логотипов при создании нового матча
- Функция вызывается в IPC handler `match:create`

### `src/renderer/hooks/useVMix.js`
- Изменена проверка `hasFields` в 6 функциях обновления для учета `forceUpdate`
- Изменена функция `formatCurrentScoreData` для отправки всех текстовых полей, включая пустые
- Изменены функции `formatLineupData`, `formatRosterData`, `formatStartingLineupData` для отправки пустых изображений при `forceUpdate=true`

### `src/renderer/pages/MatchControlPage.jsx`
- Модифицирован `useEffect` для `onLoadMatch` для сброса `previousMatchIdRef` и `isFirstLoadRef` при загрузке нового матча
- Это обеспечивает `forceUpdate=true` при следующем обновлении vMix

## Технические детали

### Логика очистки логотипов

1. **При открытии проекта:**
   - Проверяется наличие логотипов в исходном JSON (до обработки)
   - Если логотипов нет, удаляются файлы `logo_a.png` и `logo_b.png`
   - `processTeamLogoForLoad` возвращает команду с `undefined` для всех полей логотипов

2. **При сохранении проекта:**
   - `processTeamLogoForSave` проверяет наличие логотипов
   - Если логотипов нет, удаляются файлы и не устанавливается `logoPath`

3. **При создании нового матча:**
   - Вызывается `clearLogosOnNewMatch()` для удаления файлов логотипов

### Логика принудительного обновления vMix

1. **При открытии проекта:**
   - `handleLoadMatch` сбрасывает `previousMatchIdRef` и `isFirstLoadRef.current = true`
   - Это обеспечивает `forceUpdate=true` при следующем вызове `updateMatchData`

2. **При `forceUpdate=true`:**
   - Все поля отправляются в vMix, даже если они пустые
   - Проверка `hasFields` не блокирует отправку при `forceUpdate=true`
   - Функции форматирования включают пустые поля при `forceUpdate=true`

3. **Очистка данных в vMix:**
   - Пустые текстовые поля отправляются как пустые строки `""`
   - Пустые изображения отправляются как пустые строки `""` для очистки логотипов

## Влияние на другие компоненты

- **UI:** Логотипы корректно обнуляются в интерфейсе при открытии проекта без логотипов
- **vMix:** Данные в vMix корректно очищаются при открытии пустого проекта
- **Автосохранение:** Старые логотипы не сохраняются в новый проект при автосохранении
- **Производительность:** При `forceUpdate=true` отправляются все поля, что может увеличить нагрузку, но необходимо для корректной синхронизации

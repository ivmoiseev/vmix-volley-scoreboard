# Changelog

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

## [Unreleased]

### Добавлено

- **Система глобальных настроек приложения**

  - Создан модуль `settingsManager.js` для управления глобальными настройками
  - Настройки сохраняются в файл `settings.json` в корне проекта
  - Автоматическое создание файла настроек с дефолтными значениями при первом запуске
  - Поддержка миграции настроек при обновлении структуры данных

- **Улучшенная система настроек vMix**

  - Каждый инпут теперь имеет свой собственный оверлей (1-8)
  - Удален общий блок "Выбор оверлея"
  - Добавлены выпадающие списки для выбора оверлея для каждого инпута
  - Настройки vMix сохраняются в глобальный файл настроек
  - Поддержка передачи цветов команд в vMix из настроек матча

- **Полная переработка страницы настроек vMix**

  - Новая структура интерфейса: вертикальные вкладки инпутов слева, панель редактирования справа
  - Каждый инпут настраивается индивидуально с возможностью включения/выключения
  - Поддержка настройки `inputIdentifier` (имя или номер инпута в vMix)
  - Детальная настройка полей для каждого инпута
  - Каждое поле имеет свой `fieldIdentifier` (кастомное имя для обращения к vMix)
  - Поддержка четырех типов полей: "Текст", "Видимость", "Цвет", "Изображение"
  - Возможность включения/выключения каждого поля для экономии ресурсов

- **Система типов полей для vMix инпутов**

  - **Текстовые поля** (`type: "text"`): для передачи текстовых данных (названия команд, счет, имена и т.д.)
  - **Поля видимости** (`type: "visibility"`): для управления видимостью элементов (например, индикатор подачи)
  - **Поля цвета** (`type: "color"`): для изменения цвета элементов (цвет формы команды)
  - **Поля изображений** (`type: "image"`): для установки изображений (логотипы команд) через команду `SetImage`
  - Автоматическая обработка каждого типа полей соответствующими командами vMix API

- **Функции обмена данными с vMix**

  - Метод `updateInputField()` для обновления отдельных полей через команду `SetText`
  - Метод `setColor()` для изменения цвета полей через команду `SetColor`
  - Метод `setTextVisibility()` для управления видимостью полей через `SetTextVisibleOn`/`SetTextVisibleOff`
  - Метод `setImage()` для установки изображений в поля через команду `SetImage`
  - Метод `updateInputFields()` для массового обновления полей разных типов (текст, цвет, видимость, изображения)
  - Автоматическое разделение полей по типам при отправке команд в vMix
  - Функция `formatCurrentScoreData()` для форматирования данных матча в формат vMix полей
  - Функция `formatLineupData()` для форматирования данных заявки с поддержкой логотипов через HTTP URL
  - Автоматическое формирование URL логотипов на основе IP и порта мобильного сервера

- **Синхронизация данных с vMix в реальном времени**

  - Автоматическое обновление инпута текущего счета при изменении данных матча
  - Автоматическое обновление инпута "Заявка" при изменении настроек матча (включая логотипы)
  - Автоматическое сохранение логотипов в файлы при обновлении матча для доступа через HTTP
  - Debounce механизм для оптимизации частоты обновлений
  - Поддержка кнопок управления оверлеями с отслеживанием состояния через vMix API
  - Получение состояния оверлеев из vMix XML для визуальной индикации активных оверлеев
  - Автоматическое разрешение имен инпутов в номера через vMix API

- **Автоматическое восстановление мобильного сервера**

  - Состояние мобильного сервера (включен/выключен) сохраняется в настройках
  - Порт сервера сохраняется в настройках
  - При перезапуске приложения сервер автоматически запускается, если был включен
  - Сохраненная ссылка для мобильного доступа восстанавливается при запуске

- **Улучшенная система управления статистикой**

  - Добавлены кнопки для уменьшения значений статистики (-1)
  - Исправлена проблема множественных инкрементов при клике
  - Улучшенное отображение статистики с подписями
  - Автоматическое сохранение статистики при изменении

- **Улучшения интерфейса настроек vMix**
  - Добавлено отображение типа поля "Изображение" с соответствующим цветовым индикатором
  - Улучшена визуальная индикация типов полей (Текст, Цвет, Видимость, Изображение)

### Изменено

- **Структура настроек vMix**

  - Старая структура: `inputs.lineup = 'Input1'`, общий `overlay: 1`
  - Новая структура: `inputs.lineup = { enabled: true, inputIdentifier: 'Input1', overlay: 1, fields: {...} }`
  - Каждое поле инпута имеет структуру: `{ enabled: true, type: 'text|color|visibility|image', fieldName: '...', fieldIdentifier: '...' }`
  - Автоматическая миграция старых настроек в новый формат
  - Поддержка `fieldIdentifier` для каждого поля (кастомное имя для обращения к vMix)

- **Интерфейс настроек vMix**

  - Полная переработка интерфейса: новый split-panel layout (вкладки слева, редактор справа)
  - Удален блок "Выбор оверлея" с радио-кнопками
  - Добавлены выпадающие списки справа от каждого инпута для выбора оверлея
  - Увеличена ширина выпадающего списка оверлеев (150px) для корректного отображения текста
  - Добавлены компоненты `InputTabsList` и `InputEditPanel` для новой структуры интерфейса
  - Добавлен компонент `FieldsList` для отображения и редактирования полей инпута
  - Каждое поле отображается с чекбоксом включения/выключения и полем для `fieldIdentifier`

- **Логика обработки данных для vMix**

  - Разделение полей по типам при форматировании данных (`fields`, `colorFields`, `visibilityFields`, `imageFields`)
  - Использование разных команд vMix API для разных типов полей (`SetText`, `SetColor`, `SetTextVisibleOn/Off`, `SetImage`)
  - Логика управления видимостью полей типа "visibility" (например, индикатор подачи)
  - Автоматическое получение цветов из настроек матча (`match.teamA.color`, `match.teamB.color`)
  - Тип полей логотипов изменен с "text" на "image" для использования команды `SetImage`
  - Формирование URL логотипов на основе IP и порта мобильного сервера вместо hardcoded значений

- **Страница мобильного доступа**

  - Ссылка генерируется один раз при первом запуске сервера (если нет сохраненной)
  - Сохраненная ссылка автоматически загружается и отображается при перезапуске
  - QR-код автоматически генерируется для сохраненной ссылки

- **Страница "Настройки матча"**

  - Добавлено поле "Заголовок (название турнира)" вместо "Название турнира"
  - Добавлено поле "Подзаголовок (название турнира)"
  - Добавлено поле "Город, страна" перед полем "Место проведения"
  - Поля настроек матча автоматически синхронизируются с инпутом "Заявка" в vMix
  - Дата и время форматируются в формат "ДД.ММ.ГГГГ ЧЧ:ММ" для передачи в vMix

- **Логика работы с логотипами**
  - Логотипы сохраняются в гибридном формате: base64 в JSON + PNG файлы в `logos/`
  - Используются фиксированные имена файлов (`logo_a.png`, `logo_b.png`) для предотвращения накопления мусора
  - Автоматическое перезаписывание файлов при сохранении/загрузке матча

### Исправлено

- Исправлена проблема множественных инкрементов статистики при клике (теперь инкрементируется ровно на 1)
- Исправлена проблема с сохранением статистики (теперь автоматически сохраняется при изменении)
- Исправлена проблема с отображением сохраненной ссылки после перезапуска приложения
- Исправлена проблема с импортом `settingsManager` в `server.js`
- **Исправлена критическая ошибка передачи цветов в vMix**: теперь используется правильная команда `SetColor` вместо `SetText` для изменения цвета полей в vMix инпутах
- Исправлено соответствие полей в инпуте "Заявка": `venueLine1` теперь содержит место проведения (адрес), `venueLine2` содержит город и страну
- Исправлено сохранение логотипов в файлы: логотипы теперь автоматически сохраняются при обновлении матча через `setCurrentMatch` и `setMobileMatch`, а не только при сохранении матча в файл
- Исправлено формирование URL для команды SetImage: используется правильный формат `/api/?` вместо `/api?` для совместимости с vMix API

### Технические детали

- Создан модуль `src/main/settingsManager.js` для работы с глобальными настройками
- Обновлен `src/main/vmix-config.js` для использования нового менеджера настроек
- Обновлены все IPC handlers для работы с async функциями
- Добавлена поддержка миграции настроек при обновлении структуры
- Файл `settings.json` добавлен в `.gitignore`

- **Переработка страницы настроек vMix** (`src/renderer/pages/VMixSettingsPage.jsx`):

  - Реализован split-panel layout с вкладками инпутов слева и панелью редактирования справа
  - Компонент `InputTabsList` для отображения списка инпутов с чекбоксами включения/выключения
  - Компонент `InputEditPanel` для редактирования настроек выбранного инпута
  - Компонент `FieldsList` для отображения и редактирования полей инпута
  - Поддержка редактирования `inputIdentifier`, `overlay`, `enabled` для каждого инпута
  - Поддержка редактирования `fieldIdentifier`, `enabled` для каждого поля

- **Расширение функционала vMix клиента** (`src/main/vmix-client.js`):

  - Метод `updateInputField()` для обновления текстовых полей через `SetText`
  - Метод `setColor()` для изменения цвета полей через `SetColor`
  - Метод `setTextVisibility()` для управления видимостью через `SetTextVisibleOn`/`SetTextVisibleOff`
  - Метод `setImage()` для установки изображений в поля через `SetImage`
  - Метод `updateInputFields()` для массового обновления с поддержкой четырех типов полей (текст, цвет, видимость, изображения)
  - Метод `getOverlayState()` для получения состояния оверлеев из vMix XML
  - Метод `getInputs()` для получения списка инпутов и их номеров
  - Метод `findInputNumberByIdentifier()` для разрешения имен инпутов в номера
  - Логирование полной строки HTTP запроса для команды `SetImage` для отладки

- **Интеграция vMix с приложением** (`src/renderer/hooks/useVMix.js`):

  - Функция `formatCurrentScoreData()` для форматирования данных матча в формат vMix полей
  - Разделение данных на `fields` (текст), `colorFields` (цвет), `visibilityFields` (видимость)
  - Функция `formatLineupData()` для форматирования данных заявки с разделением на `fields` (текст) и `imageFields` (изображения)
  - Логика управления видимостью полей "Point A" и "Point B" на основе `servingTeam`
  - Автоматическое получение цветов из `match.teamA.color` и `match.teamB.color`
  - Автоматическое формирование URL логотипов на основе IP и порта мобильного сервера
  - Функция `formatDateTime()` для форматирования даты и времени в формат "ДД.ММ.ГГГГ ЧЧ:ММ"
  - Debounce механизм для оптимизации частоты обновлений
  - Функция `updateCurrentScoreInput()` для автоматического обновления инпута текущего счета
  - Функция `updateLineupInput()` для автоматического обновления инпута "Заявка" с поддержкой логотипов
  - Функция `isOverlayActive()` для проверки активности оверлея через vMix API
  - Автоматическое обновление состояния оверлеев для синхронизации UI с vMix
  - Проведен рефакторинг: вынесены константы, вспомогательные функции, улучшена читаемость кода

- **IPC handlers** (`src/main/main.js`):

  - Handler `vmix:update-input-fields` для обновления множественных полей с поддержкой типов (текст, цвет, видимость, изображения)
  - Обновлены handlers для работы с новым форматом настроек инпутов
  - Автоматическое сохранение логотипов в файлы при обновлении матча через `match:set-current` и `mobile:set-match`

- **Конфигурация полей по умолчанию** (`src/main/vmix-input-configs.js`):

  - Предопределенные конфигурации полей для всех инпутов (`currentScore`, `roster`, `lineup`, `referee1`, `referee2`)
  - Настройки по умолчанию для `fieldIdentifier` каждого поля
  - Функция миграции для обновления существующих конфигураций
  - Тип полей `teamALogo` и `teamBLogo` изменен на `image` вместо `text`

- **Документация**:
  - Создан документ `docs/vmix-settings-redesign-plan.md` с полным планом переработки
  - Создан документ `docs/vmix-api-reference.md` со справочником HTTP API vMix
  - Документация включает описание всех типов полей и способов их обработки
  - Примеры использования команд `SetText`, `SetColor`, `SetTextVisibleOn`/`Off`, `SetImage`
  - Описание управления оверлеями через `OverlayInput[N]In`/`Out`/`Toggle`
  - Обновлена документация для типа поля "image" и команды `SetImage`
  - Описание формирования URL логотипов через мобильный HTTP сервер

## [0.1.0] - 2024-XX-XX

### Добавлено

- Базовая структура приложения Electron + React
- Система управления матчами (создание, открытие, сохранение)
- Основной интерфейс управления матчем
- Интеграция с vMix
- Мобильный HTTP сервер
- Мобильный интерфейс для удаленного управления
- Система управления составами команд
- Расширенная статистика
- Управление логотипами команд

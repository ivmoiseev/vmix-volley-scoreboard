---
description: "Архитектура и соглашения для Electron-приложения VolleyScore Master - управление счетом волейбольных матчей с интеграцией vMix"
alwaysApply: true
---

# Инструкции для AI-агента - VolleyScore Master

## Общее описание проекта

Это Electron-приложение для управления счетом волейбольных матчей с интеграцией vMix для трансляций. Приложение позволяет управлять счетом, составами команд, логотипами и автоматически обновлять графику в vMix.

См. также: @docs/getting-started/app-description.md

## Архитектура

### Разделение процессов

- **Main Process** (`src/main/`) - Node.js, работает с файловой системой, IPC, vMix API, HTTP сервер
- **Renderer Process** (`src/renderer/`) - React приложение, UI и пользовательский интерфейс
- **Shared** (`src/shared/`) - общий код, используемый в обоих процессах

### Важные принципы

1. **IPC коммуникация**: Все взаимодействие между Main и Renderer через IPC (`ipcMain`/`ipcRenderer`)
2. **Preload скрипт**: Безопасный мост между процессами через `preload.js`
3. **Разделение ответственности**: Main Process - файлы, сеть, системные API; Renderer - UI и логика отображения

## Структура проекта

### Main Process (`src/main/`)

- @src/main/main.js - точка входа, управление окнами, IPC handlers, автосохранение
- @src/main/server.js - HTTP сервер для мобильного доступа (Express)
- @src/main/vmix-client.js - клиент для работы с vMix HTTP API
- @src/main/vmix-config.js - конфигурация vMix (обертка над settingsManager)
- @src/main/vmix-input-configs.js - конфигурации полей по умолчанию для инпутов
- @src/main/vmix-field-migration.js - функции миграции конфигураций полей vMix (конвертация старых типов в новые)
- @src/main/settingsManager.js - менеджер глобальных настроек (`settings.json`)
- @src/main/fileManager.js - управление файлами матчей (создание, открытие, сохранение)
- @src/main/logoManager.js - управление логотипами команд (загрузка, сохранение, очистка)
- @src/main/preload.js - preload скрипт для безопасного IPC
- `utils/` - утилиты для main процесса:
  - @src/main/utils/domUtils.js - утилиты для безопасной работы с DOM (защита от XSS)

### Renderer Process (`src/renderer/`)

- @src/renderer/App.jsx - главный компонент с маршрутизацией (React Router)
- `pages/` - страницы приложения:
  - @src/renderer/pages/WelcomePage.jsx - приветственная страница
  - @src/renderer/pages/MatchControlPage.jsx - управление матчем (счет, партии)
  - @src/renderer/pages/MatchSettingsPage.jsx - настройки матча
  - @src/renderer/pages/RosterManagementPage.jsx - управление составами команд
  - @src/renderer/pages/VMixSettingsPage.jsx - настройки интеграции с vMix
  - @src/renderer/pages/MobileAccessPage.jsx - настройки мобильного доступа
  - @src/renderer/pages/AboutPage.jsx - информация о приложении
- `components/` - переиспользуемые компоненты
- `hooks/`:
  - @src/renderer/hooks/useMatch.js - логика управления матчем (состояние, обновления)
  - @src/renderer/hooks/useVMix.js - интеграция с vMix (обновление данных, управление оверлеями)
- `utils/` - утилиты для renderer процесса:
  - @src/renderer/utils/vmix-field-utils.js - утилиты для работы с полями vMix (добавление суффиксов)
  - @src/renderer/utils/colorContrast.js - утилиты для расчета контрастных цветов
  - @src/renderer/utils/debounce.js - функция debounce для оптимизации
  - @src/renderer/utils/imageResize.js - утилиты для изменения размера изображений

### Shared (`src/shared/`)

- @src/shared/types/Match.ts - TypeScript типы для структуры матча
- @src/shared/matchUtils.js - утилиты для работы с матчами
- @src/shared/volleyballRules.js - правила волейбола (логика счета, партий, сетбола, матчбола)
- @src/shared/errorHandler.js - централизованная обработка ошибок
- @src/shared/vmix-field-utils.js - общие утилиты для работы с полями vMix (используются в main и renderer)

## Важные паттерны и соглашения

### Работа с матчами

- Матчи сохраняются в папке `matches/` как JSON файлы
- Текущий матч хранится в @src/main/main.js в переменной `currentMatch`
- Путь к файлу текущего матча хранится в `currentMatchFilePath`
- Автосохранение с debounce через `scheduleAutoSave()` в @src/main/main.js

### Работа с файловой системой (Dev vs Production)

**ВАЖНО:** При работе с файловой системой всегда учитывайте различия между dev и production режимами. Некоторые пути меняются в production сборке.

#### Определение режима

- Используйте `app.isPackaged` для проверки production режима
- В production приложение упаковано в ASAR архив, что влияет на доступ к файлам

#### Основные различия путей

**Логотипы (@src/main/logoManager.js):**
- **Dev режим:** `__dirname/../../logos` (корень проекта)
- **Production режим:** `app.getPath('userData')/logos` (доступно для записи)
- **Причина:** В production `extraResources` доступна только для чтения, поэтому логотипы хранятся в `userData` для возможности записи
- Используйте функцию `getLogosDir()` из @src/main/logoManager.js для получения правильного пути

**Матчи (@src/main/fileManager.js):**
- **Dev режим:** `__dirname/../../matches` (корень проекта)
- **Production режим:** `process.resourcesPath/matches` (вне ASAR архива)
- Используйте функцию `getMatchesDir()` из @src/main/fileManager.js для получения правильного пути

**Настройки (@src/main/settingsManager.js):**
- **Dev и Production:** `app.getPath('userData')/settings.json`
- Всегда доступно для записи в обоих режимах

**Мобильный сервер (@src/main/server.js):**
- Использует метод `getLogosPath()` для определения пути к логотипам
- Автоматически определяет режим и использует соответствующий путь

#### Рекомендации при работе с файлами

1. **Всегда используйте существующие функции** для получения путей:
   - `logoManager.getLogosDir()` из @src/main/logoManager.js - для логотипов
   - `fileManager.getMatchesDir()` из @src/main/fileManager.js - для матчей (через `ensureMatchesDir()`)
   - `app.getPath('userData')` - для настроек и пользовательских данных

2. **Не используйте жестко заданные пути** типа `__dirname/../../logos` напрямую - всегда проверяйте режим

3. **При создании новых путей к файлам:**
   - Проверяйте `app.isPackaged` для определения режима
   - В production используйте `app.getPath('userData')` для данных, требующих записи
   - В production используйте `process.resourcesPath` для read-only ресурсов

4. **Миграция данных:**
   - При первом запуске в production может потребоваться миграция данных из read-only ресурсов в writable папки
   - Пример: миграция логотипов из `extraResources/logos/` в `userData/logos/` (уже реализовано)

5. **Тестирование:**
   - Всегда тестируйте изменения в обоих режимах (dev и production)
   - Проверяйте, что файлы доступны для записи в production режиме

Подробнее о реализованных решениях см. в документации:
- @docs/architecture/ARCHITECTURE.md - раздел о путях к файлам
- @docs/troubleshooting/logo-fixes-and-network-selection.md - описание решения проблемы с путями к логотипам

### Интеграция с vMix

- vMix API работает через HTTP GET запросы
- Используется @src/main/vmix-client.js для всех запросов к vMix
- Обновление данных в vMix происходит через @src/renderer/hooks/useVMix.js hook
- Кэширование отправленных значений для оптимизации (отправка только изменений)
- Параметр `forceUpdate` для принудительного обновления всех полей
- Отслеживание состояния оверлеев через периодический опрос (каждые 2 секунды)
- См. также: @docs/api/vmix-api-reference.md

### Логотипы

- Логотипы хранятся в папке `logos/` как `logo_a.png` и `logo_b.png`
- Управление через @src/main/logoManager.js
- При создании нового матча логотипы очищаются
- Логотипы загружаются в vMix с timestamp для обхода кэша

### Настройки

- Глобальные настройки хранятся в `settings.json` (не в git)
- Управление через @src/main/settingsManager.js
- Настройки vMix включают: адрес, порт, конфигурации инпутов
- Автоматическое восстановление настроек при перезапуске

### IPC каналы

Основные IPC каналы (определены в @src/main/main.js и @src/main/preload.js):
- `match:*` - операции с матчами
- `file:*` - операции с файлами
- `vmix:*` - операции с vMix
- `settings:*` - операции с настройками
- `logo:*` - операции с логотипами
- `server:*` - операции с мобильным сервером

## Тестирование

### Методология разработки

**Разработка через тестирование (TDD - Test-Driven Development)** является предпочтительным подходом:
1. **Red**: Написать тест, который падает (описывает желаемое поведение)
2. **Green**: Написать минимальный код, чтобы тест прошел
3. **Refactor**: Улучшить код, сохраняя прохождение тестов

Все необходимые инструменты для тестирования уже внедрены (Jest, настройки, структура тестов).

### Структура тестов

- `tests/unit/` - юнит-тесты для отдельных модулей
- `tests/integration/` - интеграционные тесты
- `tests/security/` - тесты безопасности (XSS и т.д.)
- `tests/setup.js` - настройка тестового окружения

### Запуск тестов

- `npm test` - запуск всех тестов
- `npm run test:watch` - режим наблюдения (рекомендуется для TDD)
- `npm run test:coverage` - с покрытием кода
- `npm run test:unit` - только юнит-тесты
- `npm run test:integration` - только интеграционные тесты
- `npm run test:security` - только тесты безопасности

### Покрытие кода

- Минимальный порог: 50% для всех метрик
- Критические модули (`volleyballRules.js`, `matchUtils.js`): 80%

### Рекомендации по TDD

- При добавлении новой функциональности: сначала пишите тест, затем реализацию
- При исправлении багов: сначала пишите тест, воспроизводящий баг, затем исправление
- Используйте `npm run test:watch` для автоматического запуска тестов при изменениях
- Стремитесь к высокому покрытию кода, особенно для критических модулей

## Стиль кода

### JavaScript/JSX

- Используется ES6+ синтаксис
- React компоненты в функциональном стиле с хуками
- Именование: camelCase для переменных и функций, PascalCase для компонентов
- Комментарии на русском языке для бизнес-логики

### Обработка ошибок

- Использование @src/shared/errorHandler.js для централизованной обработки
- Try-catch блоки для асинхронных операций
- Логирование ошибок в консоль с префиксами `[main]`, `[renderer]`

### Асинхронность

- Использование async/await вместо промисов где возможно
- Debounce для частых операций (обновление vMix, автосохранение)

## Важные файлы и их назначение

### Конфигурация

- `package.json` - зависимости и скрипты
- `vite.config.js` - конфигурация Vite для сборки
- `jest.config.js` - конфигурация тестов
- `tsconfig.json` - конфигурация TypeScript (для типов)

### Документация

**Структура папки `docs/` (организована по категориям):**

- `README.md` - главный индекс навигации по всей документации

- `getting-started/` - начало работы:
  - `app-description.md` - описание приложения и основных функций
  - `ui-structure.md` - структура интерфейса и страниц приложения

- `architecture/` - архитектура проекта:
  - `ARCHITECTURE.md` - подробная архитектура приложения, структура кода, потоки данных
  - `vmix-settings-redesign-plan.md` - описание реализованной системы настроек vMix

- `api/` - API документация:
  - `vmix-api-reference.md` - справочник HTTP API vMix
  - `vMix Responce Example.xml` - пример XML ответа от vMix API

- `testing/` - тестирование:
  - `TESTING.md` - основное руководство по тестированию
  - `TESTING_QUICK_START.md` - быстрый старт работы с тестами
  - `TESTING_SETUP_GUIDE.md` - настройка окружения для тестирования
  - `TESTING_*.md` - отчеты о внедрении и статусе тестирования

- `development/` - разработка и рефакторинг:
  - `REFACTORING_GUIDE.md` - руководство по рефакторингу и улучшению кода
  - `QA_AUDIT_REPORT.md` - отчет о качестве кода и найденных проблемах
  - Другие документы об улучшениях и изменениях

- `troubleshooting/` - устранение проблем:
  - Отчеты о решенных проблемах (логотипы, безопасность, сеть и т.д.)
  - `LOGO_*.md`, `logo-*.md` - документация по проблемам с логотипами
  - `XSS_FIX_SUMMARY.md` - исправление уязвимостей безопасности

- `examples/` - примеры использования (будут добавлены)

**Принципы организации:**
- Каждая категория имеет свой README.md для навигации
- Файлы организованы логически по назначению
- Главный README.md в корне `docs/` служит точкой входа

**Обновление документации:**
- Документация должна поддерживаться в актуальном состоянии
- **Важно:** Обновляйте документацию в конце каждой сессии работы, а не при каждом изменении кода
- Это позволяет избежать фиксации ошибочных или промежуточных изменений
- Перед завершением сессии проверьте, что все изменения в коде отражены в соответствующей документации
- **ВАЖНО:** Всегда используйте актуальную дату при создании/обновлении документации
  - Формат: `*Последнее обновление: YYYY-MM-DD*` (например, `2026-01-21`)
  - НЕ копируйте даты из других документов без обновления
  - Используйте текущую дату системы при создании нового документа
  - Обновляйте дату при каждом значительном изменении документа

**Поддержание актуальности правил (.cursor/rules/):**
- Правила должны отражать текущее состояние проекта и его архитектуру
- **При добавлении новых файлов:** обновите раздел "Структура проекта" в правилах
- **При изменении архитектуры:** обновите соответствующие разделы правил
- **При изменении паттернов работы:** обновите раздел "Важные паттерны и соглашения"
- **Периодическая проверка:** раз в месяц проверяйте соответствие правил реальной структуре проекта
- **Перед большими изменениями:** обновите правила, чтобы они отражали новую структуру
- Используйте ссылки на файлы через `@filename` вместо копирования содержимого

## Особенности работы

### Автосохранение

- Автосохранение с debounce (задержка перед сохранением)
- Отслеживание несохраненных изменений через `hasUnsavedChanges`
- Предупреждение при закрытии с несохраненными изменениями

### Мобильный сервер

- HTTP сервер на Express для мобильного доступа
- Автоматическое восстановление при перезапуске
- QR-код для быстрого подключения

### Правила волейбола

- Логика реализована в @src/shared/volleyballRules.js
- Автоматическое определение сетбола и матчбола
- Поддержка различных форматов матчей (до 3/5 партий)

## Рекомендации при работе с кодом

1. **При изменении Main Process**: Убедитесь, что IPC каналы правильно определены в @src/main/preload.js
2. **При изменении структуры матча**: Обновите типы в @src/shared/types/Match.ts
3. **При добавлении новых страниц**: Добавьте маршрут в @src/renderer/App.jsx и навигацию в @src/renderer/components/Layout.jsx
4. **При работе с vMix**: Используйте @src/main/vmix-client.js и проверяйте кэширование для оптимизации
5. **При работе с файлами**: Используйте @src/main/fileManager.js для всех операций с файлами матчей
6. **При работе с логотипами**: Используйте @src/main/logoManager.js и не забывайте очищать при создании нового матча
7. **При добавлении тестов**: Следуйте структуре существующих тестов и используйте @tests/setup.js
8. **При добавлении документации**: Размещайте файлы в соответствующих категориях (`docs/testing/`, `docs/development/`, и т.д.) и обновляйте README.md в соответствующей папке
9. **Обновление документации**: Обновляйте документацию в конце каждой сессии работы, а не при каждом изменении кода. Это позволяет избежать фиксации ошибочных или промежуточных изменений. **ВАЖНО:** Всегда используйте актуальную дату (формат YYYY-MM-DD) при создании/обновлении документации, не копируйте даты из других документов
10. **При добавлении новых файлов или изменении структуры**: Обновите раздел "Структура проекта" в @.cursor/rules/cursor_rules.mdc
11. **При изменении архитектуры или паттернов**: Обновите соответствующие разделы в правилах, чтобы они оставались актуальными
12. **При исправлении ошибок**: **НЕ перебирайте варианты подряд**. Следуйте систематическому подходу:
    - **Анализ проблемы**: Изучите сообщение об ошибке, логи, контекст выполнения
    - **Поиск похожих участков кода**: Найдите в проекте аналогичные места, где подобная функциональность работает корректно, сравните подходы
    - **Поиск решений**: Изучите документацию, поищите решения в интернете, проверьте известные проблемы и best practices
    - **Внесение изменений**: Только после анализа и поиска решений вносите изменения в код, обосновывая выбор решения

## Безопасность

- Все пользовательские данные должны быть санитизированы (защита от XSS)
- IPC каналы должны быть явно определены в @src/main/preload.js
- Не использовать `eval()` или подобные небезопасные функции
- Проверка всех входных данных от пользователя
- См. также: @docs/troubleshooting/XSS_FIX_SUMMARY.md

## Производительность

- Кэширование значений для vMix API (отправка только изменений)
- Debounce для частых операций
- Оптимизация рендеринга React компонентов (использование мемоизации где необходимо)

## Зависимости и версии библиотек

⚠️ **КРИТИЧЕСКИ ВАЖНО**: Проект имеет строгие требования к версиям библиотек. Нарушение этих требований приведет к ошибкам сборки.

**Обязательные версии:**
- **React 18.3.1** (НЕ использовать React 19.x) - несовместим с React Router 6
- **React Router 6.28.0** (НЕ использовать React Router 7.x) - проблемы с Vite production сборкой
- **Vite 7.3.x** - требуется для корректной обработки CommonJS модулей

**При обновлении зависимостей:**
1. Всегда проверяйте совместимость с текущими требованиями
2. Обновляйте @docs/development/dependencies-version-requirements.md при изменении версий
3. Тестируйте сборку: `npm run build` и `npm run build:electron`
4. Проверяйте отсутствие `require()` в bundle

См. подробности: @docs/development/dependencies-version-requirements.md

## Язык и локализация

- Интерфейс на русском языке
- Комментарии в коде на русском языке
- Сообщения об ошибках на русском языке
